webpackJsonp([0],{"69q1":function(e){e.exports={scroller:"scroller__1YrmW",episode:"episode__2mlFw",currentScene:"currentScene__c26jd",dasher:"dasher__3UmY9",paragraphWrapper:"paragraphWrapper__3mEYS",choiceWrapper:"choiceWrapper__pHatH"}},B8ml:function(e,t,n){"use strict";function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function a(e){return e.replace(q,"$1"+H+"$2").replace(J,"$1"+H+"$2").replace($,"$1"+H+"$2").replace(K,"$1"+H+"$2").replace(U,"$1"+H+"$2").replace(Y,"$1"+H+"$2")}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function h(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function f(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function d(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function p(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var v=n("KM04"),m=n("o6ac"),_=n("wYIL"),y=n("ZYns"),g=n.n(y),b=n("3Ix2"),k=n.n(b),S=n("bdDp"),w=n("lyKV"),C={},T={mute:function(e){w.Howler.mute(e)},setVolume:function(e){w.Howler.volume(e)},play:function(e){C[e]||(C[e]=new w.Howl({src:[e]})),C[e].play()},playMusic:function(e){C[e]||(C[e]=new w.Howl({src:[e],html5:!0,loop:!0})),C[e].play()}},A=T,x=n("UAeI"),O=n.n(x),E=new g.a(k.a);E.on("saveGame",function(e){return new Promise(function(t){S.a.set(e.id,e.data),t()})}),E.on("loadGame",function(e){return new Promise(function(t){t(S.a.get(e,!0))})}),E.on("loadStory",function(){return Promise.resolve(O.a)}),E.registerCommand("IMG",function(e){return'<img src="assets/game/'+e+'">'}),E.registerCommand("CLEAR",function(e,t){return t.reset(),!1},["episode"]);var P={gameState:{},renderer:function(e){this.renderer=e},startGame:function(){return E.startGame()},renderScene:function(){E.renderScene();var e=E.getCurrentEpisode();this.gameState={scene:E.getCurrentScene(),episode:e.slice(0,e.length-1)}},makeChoice:function(e){return E.makeChoice(e)},saveGame:function(){return E.saveGame("auto")},resumeGame:function(){return E.loadGame("auto")},initGame:function(){return A.mute(!_.b.getState().sound),A.playMusic("assets/snd/music.mp3"),S.a.exists("auto")?this.resumeGame():this.startGame()},clearSavedGame:function(){S.a.delete("auto")}},I=P,V=n("69q1"),N=n.n(V),F=n("aA/P"),R=n.n(F),L=function(e){function t(){for(var t,n,r,a=arguments.length,o=Array(a),s=0;s<a;s++)o[s]=arguments[s];return t=n=i(this,e.call.apply(e,[this].concat(o))),n.makeChoice=function(e){e.preventDefault(),n.props.makeChoice(n.props.option.id)},r=t,i(n,r)}return r(t,e),t.prototype.render=function(e){var t=e.option;return"^"===t.choice?Object(v.h)("a",{href:"#",onClick:this.makeChoice,class:R.a.endEpisode},"»"):Object(v.h)("a",{href:"#",onClick:this.makeChoice,class:R.a.choice},t.choice)},t}(v.Component),j=L,D=n("HwNa"),G=n.n(D),B="[абвгдеёжзийклмнопрстуфхцчшщъыьэюя]",M="[аеёиоуыэюя]",W="[бвгджзклмнпрстфхцчшщ]",H="­",q=new RegExp('([йъь])("'+B+B+")","ig"),J=new RegExp("("+M+")("+M+B+")","ig"),$=new RegExp("("+M+W+")("+W+M+")","ig"),K=new RegExp("("+W+M+")("+W+M+")","ig"),U=new RegExp("("+M+W+")("+W+W+M+")","ig"),Y=new RegExp("("+M+W+W+")("+W+W+M+")","ig"),z=a,X=function(e){var t=e.hyphens,n=e.text;return Object(v.h)("div",{class:[G.a.paragraph,t?"justified":""].join(" ")},n.map(function(e){return Object(v.h)("p",{class:0===e.indexOf("<")?"":"indented",dangerouslySetInnerHTML:{__html:t?z(e):e}})}))},Z=Object(m.connect)("hyphens")(X),Q=n("GedZ"),ee=n.n(Q),te=["-46","-43","-40","-36","-33","-29","-25","-21","-18","-14","-10","-7","-3","0","4","8","12","16","19","23","27","31","34","38","42","46"],ne=function(e){var t=e.display;return Object(v.h)("div",{class:G.a.paragraph},Object(v.h)("div",{class:ee.a.voltmeter},Object(v.h)("div",{class:ee.a.arrow,style:{transform:"rotate("+te[parseInt(t[1],10)]+"deg)"}})),Object(v.h)("p",{class:"indented",dangerouslySetInnerHTML:{__html:t[2]}}))},ie=ne,re=n("hAVL"),ae=n.n(re),oe=Object(v.h)("svg",{style:"height: 24px; width: 24px;",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},Object(v.h)("g",{class:"",style:"touch-action: none;",transform:"translate(0,0)"},Object(v.h)("path",{d:"M275.5 96l-96 96h-96v128h96l96 96V96zm51.46 27.668l-4.66 17.387c52.066 13.95 88.2 61.04 88.2 114.945 0 53.904-36.134 100.994-88.2 114.945l4.66 17.387C386.81 372.295 428.5 317.962 428.5 256c0-61.963-41.69-116.295-101.54-132.332zm-12.425 46.365l-4.658 17.387C340.96 195.748 362.5 223.822 362.5 256s-21.54 60.252-52.623 68.58l4.658 17.387C353.402 331.552 380.5 296.237 380.5 256c0-40.238-27.098-75.552-65.965-85.967zm-12.424 46.363l-4.657 17.387C307.55 236.49 314.5 245.547 314.5 256s-6.95 19.51-17.047 22.217l4.658 17.387c17.884-4.792 30.39-21.09 30.39-39.604 0-18.513-12.506-34.812-30.39-39.604z",fill:"#000000","fill-opacity":"1"}))),se=Object(v.h)("svg",{style:"height: 24px; width: 24px;",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},Object(v.h)("g",{class:"",style:"touch-action: none;",transform:"translate(0,0)"},Object(v.h)("path",{d:"M275.5 96l-96 96h-96v128h96l96 96V96zm50.863 89.637l-12.726 12.726L371.273 256l-57.636 57.637 12.726 12.726L384 268.727l57.637 57.636 12.726-12.726L396.727 256l57.636-57.637-12.726-12.726L384 243.273l-57.637-57.636z",fill:"#000000","fill-opacity":"1"}))),ue=function(e){function t(){return o(this,t),s(this,e.apply(this,arguments))}return u(t,e),t.prototype.componentDidUpdate=function(){A.mute(!this.props.sound)},t.prototype.render=function(e){var t=e.sound,n=e.setSound;return Object(v.h)("div",{class:ae.a.sound,onClick:n},t?oe:se)},t}(v.Component),le=Object(m.connect)("sound",_.a)(ue),ce=Object(v.h)(le,null),he=function(e){function t(){return l(this,t),c(this,e.apply(this,arguments))}return h(t,e),t.prototype.componentDidUpdate=function(){this.scroller&&(this.scroller.scrollTop=this.scroller.scrollHeight)},t.prototype.render=function(e){var t=this,n=e.episode,i=e.scene,r=e.makeChoice;return Object(v.h)("div",{class:N.a.scroller},Object(v.h)("div",{id:"episode",class:N.a.episode,ref:function(e){return t.scroller=e}},Object(v.h)("div",{class:N.a.paragraphWrapper},n.map(function(e){return Object(v.h)(Z,{text:e.text})})),Object(v.h)("div",{class:N.a.currentScene},i.choices.length>0?Object(v.h)("div",{class:N.a.dasher}):"",0===i.text[0].indexOf("VOLTMETER")?Object(v.h)(ie,{display:i.text}):Object(v.h)(Z,{text:i.text})),Object(v.h)("div",{class:N.a.choiceWrapper,ref:function(e){return t.currentChoices=e}},i.choices.map(function(e){return Object(v.h)(j,{option:e,makeChoice:r})}))),ce)},t}(v.Component),fe=he,de=function(e){function t(){var n,i,r;f(this,t);for(var a=arguments.length,o=Array(a),s=0;s<a;s++)o[s]=arguments[s];return n=i=d(this,e.call.apply(e,[this].concat(o))),i.makeChoice=function(e){I.makeChoice(e).then(i.renderScene),I.saveGame()},i.renderScene=function(){I.renderScene(),i.props.gameState(I.gameState)},r=n,d(i,r)}return p(t,e),t.prototype.componentWillMount=function(){I.initGame().then(this.renderScene)},t.prototype.componentDidUpdate=function(){0===this.props.scene.choices.length&&I.clearSavedGame()},t.prototype.render=function(e){var t=e.scene,n=e.episode;return t?Object(v.h)(fe,{scene:t,episode:n,makeChoice:this.makeChoice}):""},t}(v.Component);t.default=Object(m.connect)("scene,episode",_.a)(de)},GedZ:function(e){e.exports={voltmeter:"voltmeter__39rFT",arrow:"arrow__1Ou5n"}},HwNa:function(e){e.exports={paragraph:"paragraph__KzOCG"}},UAeI:function(e){e.exports={inkVersion:18,root:[["^Dark.","\n","^Cold.","\n","^Metal smell.","\n","^The awakening from anabiosis turned out to be quite different from what you imagined.","\n","^But why did not the automation work until now? The capsule should have already opened!","\n",["ev","str","^Open your eyes","/str","/ev",{"*":".^.c-0",flg:20},"ev","str","^Touch the capsule walls","/str","/ev",{"*":".^.c-1",flg:20},{"c-0":["\n","^You do not see anything at all. You hope that your eyes are fine.","\n",{"->":"0.g-0"},{"#f":5}],"c-1":["\n","^You try to reach out and your fingers ran into the cold metal. Then you find some kind of lever.","\n",["ev","str","^Pull the lever","/str","/ev",{"*":".^.c-0",flg:20},{"c-0":["\n","^You pull the lever, and the metal cap of the capsule swung open with a gnash. Light hits your eyes. After waiting until your eyes get used to the light, you clumsily get out of the capsule.","\n",["ev","str","^Look around","/str","/ev",{"*":".^.c-0",flg:20},{"c-0":["^ ",{"->":"chamber_room"},"\n",{"->":"0.g-0"},{"#f":5}]}],{"#f":5}]}],{"#f":5}],"#n":"start_exam"}],{"g-0":[{"->":"0.start_exam"},["done",{"#n":"g-1"}],null]}],"done",{chamber_room:[["^>>> CLEAR","\n","^The round chamber is poorly lit. In the center rises a complex structure of mechanisms, pipes and wires. It surrounded with capsules, one of them is opened now.","\n","^Hermetic door in the wall is ","ev",{"VAR?":"chamber_door_open"},"/ev",[{"->":".^.b",c:!0},{b:["^ opened",{"->":".^.^.^.10"},null]}],[{"->":".^.b"},{b:["^sealed",{"->":".^.^.^.10"},null]}],"nop","^.","\n",["ev","str","^🔎 Lamps","/str","/ev",{"*":".^.c-0",flg:20},"ev","str","^🔎 Mechanisms","/str","/ev",{"*":".^.c-1",flg:20},"ev","str","^🔎 Control panel","/str",{"CNT?":".^.c-1"},"/ev",{"*":".^.c-2",flg:21},"ev","str","^🔎 Capsules","/str",{"VAR?":"has_cover"},"!","/ev",{"*":".^.c-3",flg:5},"ev","str","ev",{"CNT?":"storage_room"},"/ev",[{"->":".^.b",c:!0},{b:["^ Go to storage room",{"->":".^.^.^.34"},null]}],[{"->":".^.b"},{b:["^Exit the chamber",{"->":".^.^.^.34"},null]}],"nop","/str",{"VAR?":"chamber_door_open"},"/ev",{"*":".^.c-4",flg:5},{"c-0":["\n","^Smooth metal walls and floor dimly shine in the semi-darkness. Apparently, the power is enough only for backup lighting.","\n",{"->":".^.^.^.g-0"},{"#f":5}],"c-1":["\n","^This machine made our journey possible. The indicators on the control panel glow with a soft amber light.","\n",{"->":".^.^.^.g-0"},{"#f":5}],"c-2":["\n","^A glance at the indicators was enough to understand - the rest of the capsules were out of order. It turns out that you are the only one to be lucky enough to reach the destination point alive.","\n",["ev","str","^🔎 Switches","/str","/ev",{"*":".^.c-0",flg:20},{"c-0":["\n","^It seems that you can redirect the power from the capsules to the door with these switches. You just need to find the right voltage ...","\n",["ev","str","^Switch the power","/str","/ev",{"*":".^.c-0",flg:20},{"c-0":["\n","ev",{"^->":"chamber_room"},"/ev",{"->":"electropuzzle"},{"->":"chamber_room.0.g-0"},{"#f":5}]}],{"#f":5}]}],{"#f":5}],"c-3":["\n","^There are five capsules in total. Your capsule is open. ","ev",{"VAR?":"has_cover"},"!","/ev",[{"->":".^.b",c:!0},{b:["^ There is a leather cladding inside.",{"->":".^.^.^.7"},null]}],"nop","^","\n",["ev","str","^Touch the cladding","/str","/ev",{"*":".^.c-0",flg:20},"ev","str","^Cut the cladding with shard","/str",{"VAR?":"has_glass"},{"VAR?":"has_knife"},"!","&&","/ev",{"*":".^.c-1",flg:21},"ev","str","^Cut the cladding","/str",{"VAR?":"has_knife"},"/ev",{"*":".^.c-2",flg:21},{"*":".^.c-3",flg:8},{"c-0":["\n","^Capsule cladding is still warm.","\n",{"->":".^.^.^.^.^.g-0"},{"#f":5}],"c-1":["\n","^The shard is too sharp, you would not like to cut your hands.","\n",{"->":".^.^.^.^.^.g-0"},{"#f":5}],"c-2":["\n","^It took a long time to cut the cladding from the capsule.","\n","ev",1,"/ev",{"temp=":"has_cover",re:!0},{"->":".^.^.^.^.^.g-0"},{"#f":5}],"c-3":[{"->":".^.^.^.^"},"\n",{"->":".^.^.^.^.^.g-0"},null]}],null],"c-4":["^ ",{"->":"storage_room"},"\n",{"->":".^.^.^.g-0"},null],"#n":"chamber_exam"}],{"g-0":[{"->":".^.^.chamber_exam"},null]}],{"#f":3}],electropuzzle:[{"temp=":"return_to_story"},[["^>>> CLEAR","\n","^VOLTMETER","\n","ev",{"VAR?":"voltage"},"out","/ev","\n","ev",{"VAR?":"voltage"},9,">","/ev",[{"->":".^.b",c:!0},{b:["^ A red light is on the panel. It means that the power circuit is overloaded. You need to lower the voltage.",{"->":".^.^.^.15"},null]}],"nop","\n","ev",{"VAR?":"voltage"},9,"==","/ev",[{"->":".^.b",c:!0},{b:["^ A green light appears on panel. You can hear a buzz of the mechanisms controlling the door locks.",{"->":".^.^.^.23"},null]}],"nop","\n","ev",{"VAR?":"voltage"},9,"<","/ev",[{"->":".^.b",c:!0},{b:["^ It seems that the voltage in the power circuit is not enough to control the door relay.",{"->":".^.^.^.31"},null]}],"nop","\n","ev","str","^Open the door","/str",{"VAR?":"voltage"},9,"==","/ev",{"*":".^.c-0",flg:5},"ev","str","^Capsule 1: OFF","/str",{"VAR?":"voltage"},9,"!=",{"VAR?":"tumbler1"},"&&","/ev",{"*":".^.c-1",flg:5},"ev","str","^Capsule 1: on","/str",{"VAR?":"voltage"},9,"!=",{"VAR?":"tumbler1"},"!","&&","/ev",{"*":".^.c-2",flg:5},"ev","str","^Capsule 2: OFF","/str",{"VAR?":"voltage"},9,"!=",{"VAR?":"tumbler2"},"&&","/ev",{"*":".^.c-3",flg:5},"ev","str","^Capsule 2: on","/str",{"VAR?":"voltage"},9,"!=",{"VAR?":"tumbler2"},"!","&&","/ev",{"*":".^.c-4",flg:5},"ev","str","^Capsule 3: OFF","/str",{"VAR?":"voltage"},9,"!=",{"VAR?":"tumbler3"},"&&","/ev",{"*":".^.c-5",flg:5},"ev","str","^Capsule 3: on","/str",{"VAR?":"voltage"},9,"!=",{"VAR?":"tumbler3"},"!","&&","/ev",{"*":".^.c-6",flg:5},"ev","str","^Capsule 4: OFF","/str",{"VAR?":"voltage"},9,"!=",{"VAR?":"tumbler4"},"&&","/ev",{"*":".^.c-7",flg:5},"ev","str","^Capsule 4: on","/str",{"VAR?":"voltage"},9,"!=",{"VAR?":"tumbler4"},"!","&&","/ev",{"*":".^.c-8",flg:5},"ev","str","^Capsule 5: OFF","/str",{"VAR?":"voltage"},9,"!=",{"VAR?":"tumbler5"},"&&","/ev",{"*":".^.c-9",flg:5},"ev","str","^Capsule 5: on","/str",{"VAR?":"voltage"},9,"!=",{"VAR?":"tumbler5"},"!","&&","/ev",{"*":".^.c-10",flg:5},{"c-0":["\n","ev",1,"/ev",{"temp=":"chamber_door_open",re:!0},{"->":"return_to_story",var:!0},{"->":".^.^.^.g-0"},null],"c-1":["\n","ev",{"VAR?":"voltage"},5,"+","/ev",{"temp=":"voltage",re:!0},"ev",0,"/ev",{"temp=":"tumbler1",re:!0},{"->":".^.^.^.g-0"},null],"c-2":["\n","ev",{"VAR?":"voltage"},5,"-","/ev",{"temp=":"voltage",re:!0},"ev",1,"/ev",{"temp=":"tumbler1",re:!0},{"->":".^.^.^.g-0"},null],"c-3":["\n","ev",{"VAR?":"voltage"},1,"+","/ev",{"temp=":"voltage",re:!0},"ev",0,"/ev",{"temp=":"tumbler2",re:!0},{"->":".^.^.^.g-0"},null],"c-4":["\n","ev",{"VAR?":"voltage"},1,"-","/ev",{"temp=":"voltage",re:!0},"ev",1,"/ev",{"temp=":"tumbler2",re:!0},{"->":".^.^.^.g-0"},null],"c-5":["\n","ev",{"VAR?":"voltage"},2,"+","/ev",{"temp=":"voltage",re:!0},"ev",0,"/ev",{"temp=":"tumbler3",re:!0},{"->":".^.^.^.g-0"},null],"c-6":["\n","ev",{"VAR?":"voltage"},2,"-","/ev",{"temp=":"voltage",re:!0},"ev",1,"/ev",{"temp=":"tumbler3",re:!0},{"->":".^.^.^.g-0"},null],"c-7":["\n","ev",{"VAR?":"voltage"},6,"+","/ev",{"temp=":"voltage",re:!0},"ev",0,"/ev",{"temp=":"tumbler4",re:!0},{"->":".^.^.^.g-0"},null],"c-8":["\n","ev",{"VAR?":"voltage"},6,"-","/ev",{"temp=":"voltage",re:!0},"ev",1,"/ev",{"temp=":"tumbler4",re:!0},{"->":".^.^.^.g-0"},null],"c-9":["\n","ev",{"VAR?":"voltage"},8,"+","/ev",{"temp=":"voltage",re:!0},"ev",0,"/ev",{"temp=":"tumbler5",re:!0},{"->":".^.^.^.g-0"},null],"c-10":["\n","ev",{"VAR?":"voltage"},8,"-","/ev",{"temp=":"voltage",re:!0},"ev",1,"/ev",{"temp=":"tumbler5",re:!0},{"->":".^.^.^.g-0"},null],"#n":"electropuzzle_solve"}],{"g-0":[{"->":".^.^.electropuzzle_solve"},null]}],{"#f":3}],cutscene1:[["^>>> IMG gfx/out.png","\n","^The professor warned you that this is one way journey. Warned all of you, from the very start.","\n","^But the goal was worth it. To see with your own eyes what we were only dreaming of - who would abandon such a perspective? And you volunteered.","\n","^But why nobody greets you?","\n","ev","str","^^","/str","/ev",{"*":".^.c-0",flg:20},{"c-0":["^ ","ev","void","/ev","->->","\n",{"#f":5}]}],{"#f":3}],storage_room:[["^>>> CLEAR","\n","ev",{"CNT?":"cutscene1"},"!","/ev",[{"->":".^.b",c:!0},{b:["^ ",{"->t->":"cutscene1"},{"->":".^.^.^.^"},{"->":".^.^.^.7"},null]}],"nop","\n","ev",{"VAR?":"glass_cube_broken"},"/ev",[{"->":".^.b",c:!0},{b:["^ Glass shards are scattered on the floor in the center of the room","ev",{"VAR?":"has_papers"},"!","/ev",[{"->":".^.b",c:!0},{b:["^, covering a few paper sheets",{"->":".^.^.^.6"},null]}],"nop","^.",{"->":".^.^.^.14"},null]}],[{"->":".^.b"},{b:["^In the middle of the room a glass cube gleams dully.",{"->":".^.^.^.14"},null]}],"nop","^ Along the walls there are rows of monotonous metal boxes. ","ev",{"CNT?":".^.storage_exam.c-3.12.seen_boxes"},"/ev",[{"->":".^.b",c:!0},{b:["^ There is a small manhole on the floor near you.",{"->":".^.^.^.20"},null]}],"nop","\n","ev",{"VAR?":"storage_door_open"},"/ev",[{"->":".^.b",c:!0},{b:["^ Vault door is partially opened.",{"->":".^.^.^.27"},null]}],[{"->":".^.b"},{b:["^Big vault door is closed.",{"->":".^.^.^.27"},null]}],"nop","\n",["ev","str","^🔎 Glass cube","/str",{"VAR?":"glass_cube_broken"},"!","/ev",{"*":".^.c-0",flg:5},"ev","str","^🔎 Shards of glass","/str",{"VAR?":"glass_cube_broken"},{"VAR?":"has_glass"},{"VAR?":"has_papers"},"&&","!","&&","/ev",{"*":".^.c-1",flg:5},"ev","str","^🔎 Papers","/str",{"VAR?":"has_papers"},"/ev",{"*":".^.c-2",flg:21},"ev","str","^🔎 Boxes","/str",{"VAR?":"engine_room_open"},"!","/ev",{"*":".^.c-3",flg:5},"ev","str","^🔎 Vault door","/str",{"VAR?":"storage_door_open"},"!","/ev",{"*":".^.c-4",flg:21},"ev","str","^Coat the shard with tape","/str",{"VAR?":"has_tape"},{"VAR?":"has_glass"},"&&",{"VAR?":"has_knife"},"!","&&","/ev",{"*":".^.c-5",flg:21},"ev","str","^Open the vault door","/str",{"VAR?":"storage_door_open"},"/ev",{"*":".^.c-6",flg:21},"ev","str","^Go to manhole","/str",{"VAR?":"engine_room_open"},"/ev",{"*":".^.c-7",flg:5},"ev","str","^Go to chamber","/str","/ev",{"*":".^.c-8",flg:4},"ev","str","^Exit the vault","/str",{"CNT?":"stairs_room"},"/ev",{"*":".^.c-9",flg:5},{"c-0":["\n","^Under the glass were several pages of typed text. You are the one of those who made this document, so you know what is it about ...","\n",["ev","str","^Break the cube with wrench","/str",{"VAR?":"has_wrench"},"/ev",{"*":".^.c-0",flg:21},"ev","str","^Look around","/str",{"VAR?":"has_wrench"},"!","/ev",{"*":".^.c-1",flg:5},{"c-0":["\n","^Loud sound of broken glass. The shards fell to the floor.","\n","ev",1,"/ev",{"temp=":"glass_cube_broken",re:!0},{"->":".^.^.^.^.^.g-0"},{"#f":5}],"c-1":["\n","^You look around the room.","\n",{"->":".^.^.^.^.^.g-0"},null]}],null],"c-1":["\n","^The shards reflect the yellow light of the lamps. ","ev",{"VAR?":"has_papers"},"!","/ev",[{"->":".^.b",c:!0},{b:["^A few paper sheets lie on the floor, covered with shards.",{"->":".^.^.^.7"},null]}],"nop","\n",["ev","str","^Take one of shards","/str",{"VAR?":"has_glass"},"!","/ev",{"*":".^.c-0",flg:21},"ev","str","^Take the papers","/str",{"VAR?":"has_papers"},"!","/ev",{"*":".^.c-1",flg:21},{"c-0":["\n","^You carefully pick up one of the shards from the floor.","\n","ev",1,"/ev",{"temp=":"has_glass",re:!0},{"->":".^.^.^.^.^.g-0"},{"#f":5}],"c-1":["\n","^You pull the paper sheets from under the shard, fold them and put them in your pocket.","\n","ev",1,"/ev",{"temp=":"has_papers",re:!0},{"->":".^.^.^.^.^.g-0"},{"#f":5}]}],null],"c-2":["\n","^Several pages of typed text. For those who were supposed to meet us, they are of particular importance.","\n",{"->":".^.^.^.g-0"},{"#f":5}],"c-3":["\n","^The inscriptions on the boxes are unreadable. And you have neither the time nor the desire  to search them at random.","\n","ev",{"VAR?":"has_wrench"},"!","/ev",[{"->":".^.b",c:!0},{b:["^ Between the boxes is a adjustable wrench. You wonder who could drop it here?",{"->":".^.^.^.8"},null]}],"nop","\n","^There is a small manhole on the floor near you.","\n",[["ev","str","^Take the wrench","/str","/ev",{"*":".^.c-0",flg:20},"ev","str","^Open the manhole with wrench","/str",{"VAR?":"has_wrench"},"/ev",{"*":".^.c-1",flg:21},"ev","str","^Pull the manhole cover","/str",{"VAR?":"has_wrench"},"!","/ev",{"*":".^.c-2",flg:21},{"c-0":["\n","^You pick the wrench from the floor.","\n","ev",1,"/ev",{"temp=":"has_wrench",re:!0},{"->":".^.^.^.^.^.^.g-0"},{"#f":5}],"c-1":["\n","^You lift the manhole, using the adjustable wrench as a lever, and push it aside.","\n","ev",1,"/ev",{"temp=":"engine_room_open",re:!0},{"->":".^.^.^.^.^.^.g-0"},{"#f":5}],"c-2":["\n","^You pulled the cover handle, but it did't move even a bit. It's too heavy for you.","\n",{"->":".^.^.^.^.^.^.g-0"},{"#f":5}],"#f":5,"#n":"seen_boxes"}],null],null],"c-4":["\n","^The vault is designed so that the door can only be opened from the outside. You need to find a way to open it from the inside.","\n",{"->":".^.^.^.g-0"},{"#f":5}],"c-5":["\n","^You carefully wrap the shard with electrical tape. Now you can use is as a knife, if necessary.","\n","ev",1,"/ev",{"temp=":"has_knife",re:!0},{"->":".^.^.^.g-0"},{"#f":5}],"c-6":["\n","^It seems that over the years the mechanisms have become unusable, and the door can not be fully opened.","\n","^Cold wind blows from the dark gap between the doors.","\n",["ev","str","^Squeeze into the gap","/str","/ev",{"*":".^.c-0",flg:20},{"c-0":["\n","^The width of the gap is enough to allow you to squeeze through.","\n",{"->":"stairs_room"},{"->":".^.^.^.^.^.g-0"},{"#f":5}]}],{"#f":5}],"c-7":["^ ",{"->":"engine_room"},"\n",{"->":".^.^.^.g-0"},null],"c-8":["^ ",{"->":"chamber_room"},"\n",{"->":".^.^.^.g-0"},null],"c-9":["^ ",{"->":"stairs_room"},"\n",{"->":".^.^.^.g-0"},null],"#n":"storage_exam"}],{"g-0":[{"->":".^.^.storage_exam"},null]}],{"#f":3}],engine_room:[["^>>> CLEAR","\n","^Engine room is small and narrow. Buzzing sound of machines supporting the work of the complex is very loud. At the stairs leading up, there is a control panel nearby. To the right of the console there is the valve of the control system of the storage door. ","ev",{"VAR?":"used_cover"},"/ev",[{"->":".^.b",c:!0},{b:["^The cladding is thrown on it.",{"->":".^.^.^.7"},null]}],"nop","\n","ev",{"VAR?":"has_tape"},"!","/ev",[{"->":".^.b",c:!0},{b:["^ On the floor there is a lightly dusted bundle of tape.",{"->":".^.^.^.14"},null]}],"nop","\n",["ev","str","^🔎 Control panel","/str","/ev",{"*":".^.c-0",flg:20},"ev","str","^Turn the valve","/str",{"VAR?":"used_cover"},"!","/ev",{"*":".^.c-1",flg:21},"ev","str","^Throw the cladding on the valve","/str",{"CNT?":".^.c-1.1.tried_vent"},{"VAR?":"has_cover"},"&&","/ev",{"*":".^.c-2",flg:5},"ev","str","^Take the cladding off the valve","/str",{"VAR?":"used_cover"},"/ev",{"*":".^.c-3",flg:5},"ev","str","^Turn the valve","/str",{"VAR?":"used_cover"},"/ev",{"*":".^.c-4",flg:21},"ev","str","^Take the tape","/str",{"VAR?":"has_tape"},"!","/ev",{"*":".^.c-5",flg:21},"ev","str","^Wrap the shard with tape","/str",{"VAR?":"has_tape"},{"VAR?":"has_glass"},"&&",{"VAR?":"has_knife"},"!","&&","/ev",{"*":".^.c-6",flg:21},"ev","str","^Climb the ladder","/str","/ev",{"*":".^.c-7",flg:4},{"c-0":["\n","^Most of the lights on the control panel are red. It seems that these machines will not last long.","\n",{"->":".^.^.^.g-0"},{"#f":5}],"c-1":["\n",[["^You grab the valve, and immediately pulled my hand away - the hot metal painfully burned your palm.","\n",{"->":".^.^.^.^.^.g-0"},{"#f":5,"#n":"tried_vent"}],null],{"#f":5}],"c-2":["\n","^You throw the cladding on the valve.","\n","ev",0,"/ev",{"temp=":"has_cover",re:!0},"ev",1,"/ev",{"temp=":"used_cover",re:!0},{"->":".^.^.^.g-0"},null],"c-3":["\n","^You take the cladding off the valve carefully, to avoid getting burn.","\n","ev",1,"/ev",{"temp=":"has_cover",re:!0},"ev",0,"/ev",{"temp=":"used_cover",re:!0},{"->":".^.^.^.g-0"},null],"c-4":["\n","^You turn the valve until full stop. Something rumbles in the darkness behind the interlacing of pipes. Then you hear a rasping sound of the opening hermetic door from above.","\n","ev",1,"/ev",{"temp=":"storage_door_open",re:!0},{"->":".^.^.^.g-0"},{"#f":5}],"c-5":["\n","^You pick up the tape.","\n","ev",1,"/ev",{"temp=":"has_tape",re:!0},{"->":".^.^.^.g-0"},{"#f":5}],"c-6":["\n","^You carefully wrap the shard with electrical tape. Now you can use is as a knife, if necessary.","\n","ev",1,"/ev",{"temp=":"has_knife",re:!0},{"->":".^.^.^.g-0"},{"#f":5}],"c-7":["^ ",{"->":"storage_room"},"\n",{"->":".^.^.^.g-0"},null],"#n":"engine_exam"}],{"g-0":[{"->":".^.^.engine_exam"},null]}],{"#f":3}],stairs_room:[["^>>> CLEAR","\n","^A beam of light from the gap of the vault doors illuminates a small room. You can see the daylight coming from the top of the stairwell. It is very cold in here.","\n",["ev","str","^Go upstairs","/str",{"VAR?":"has_warm"},"!","/ev",{"*":".^.c-0",flg:21},"ev","str","^Slice the cladding","/str",{"VAR?":"has_warm"},"!",{"VAR?":"has_knife"},"&&",{"VAR?":"has_cover"},"&&","/ev",{"*":".^.c-1",flg:21},"ev","str","^Go upstairs","/str",{"VAR?":"has_papers"},"!","/ev",{"*":".^.c-2",flg:21},"ev","str","^Go upstairs","/str",{"VAR?":"has_warm"},{"VAR?":"has_papers"},"&&","/ev",{"*":".^.c-3",flg:21},"ev","str","^Return to vault","/str","/ev",{"*":".^.c-4",flg:4},{"c-0":["\n","^You will inevitably freeze to death, if you try to go outside ...","\n",{"->":".^.^.^.g-0"},{"#f":5}],"c-1":["\n","^You slice the cladding into pieces and push them under your clothes.","\n","ev",0,"/ev",{"temp=":"has_cover",re:!0},"ev",1,"/ev",{"temp=":"has_warm",re:!0},{"->":".^.^.^.g-0"},{"#f":5}],"c-2":["\n","^You forgot to take the papers with you. They are really important.","\n",{"->":".^.^.^.g-0"},{"#f":5}],"c-3":["^ ",{"->":"cutscene2"},"\n",{"->":".^.^.^.g-0"},{"#f":5}],"c-4":["^ ",{"->":"storage_room"},"\n",{"->":".^.^.^.g-0"},null],"#n":"stairs_exam"}],{"g-0":[{"->":".^.^.stairs_exam"},null]}],{"#f":3}],cutscene2:[["^>>> CLEAR","\n","^>>> IMG gfx/up.png","\n","^You climb the stairs and enter the large round hall. This is the place where you journey started a long time ago.","\n","^The hall was absolutely empty and, obviously, long abandoned. Everything that represented even the slightest value, was stolen. The mosaic on the walls fell in places, there were holes in the ceiling. The sun shines through these holes.","\n","ev","str","^^","/str","/ev",{"*":".^.c-0",flg:20},{"c-0":["^ ",{"->":"hall_room"},"\n",{"#f":5}]}],{"#f":3}],hall_room:[["^You leave the hall and come to the circular gallery. And you are amazed by what you see there.","\n","^There is a stunning view behind the huge gallery windows. Snow lays on the hills, slightly covered with wood. And there, among the hills, the wind turbines go all way to horizon, their blades are slowly rotating. Lights of the nearby city shine bright.","\n",["ev","str","^Look at the wind turbines","/str","/ev",{"*":".^.c-0",flg:20},"ev","str","^Look at the city","/str","/ev",{"*":".^.c-1",flg:20},"ev","str","^Go outside","/str",{"CNT?":".^.c-0.3.seen_mills"},{"CNT?":".^.c-1.3.seen_city"},"&&","/ev",{"*":".^.c-2",flg:21},{"c-0":["\n","^There are a few dozens of them. Looks like a picture from a fantastic novel.","\n",[[{"->":".^.^.^.^.^.g-0"},{"#f":5,"#n":"seen_mills"}],null],{"#f":5}],"c-1":["\n","^The city has changed a lot over the years. There are new quarters with a lot of high-rise buildings.","\n",[[{"->":".^.^.^.^.^.g-0"},{"#f":5,"#n":"seen_city"}],null],{"#f":5}],"c-2":["^ ",{"->":"cutscene_end"},"\n",{"->":".^.^.^.g-0"},{"#f":5}],"#n":"hall_exam"}],{"g-0":[{"->":".^.^.hall_exam"},null]}],{"#f":3}],cutscene_end:[["^>>> CLEAR","\n","^>>> IMG gfx/monument.png","\n","^Half-hour descent down from the hill was tiring for you, so you stop to rest near the grass-covered monument and take a final look at the building where you spent so many years. A time capsule. One of its kind.","\n","ev","str","^^","/str","/ev",{"*":".^.c-0",flg:20},{"c-0":["\n","^You were chosen to deliver the message from the past generations. To tell about interesting and uneasy time you were living in. And even the reason why the capsule was abandoned is no longer bothering you. What you saw from above gives you hope.","\n",["ev","str","^^","/str","/ev",{"*":".^.c-0",flg:20},{"c-0":["^ ",{"->":"finale"},"\n",{"#f":5}]}],{"#f":5}]}],{"#f":3}],finale:[["^>>> CLEAR","\n","^>>> IMG gfx/finale.png","\n","^Hope to see with your own eyes the very thing for which you went through this long and difficult journey.","\n",["ev",{"^->":"finale.0.6.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-0",flg:18},{s:["^Future.",{"->":"$r",var:!0},null]}],{"c-0":["ev",{"^->":"finale.0.c-0.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.6.s"},[{"#n":"$r2"}],"\n",[["ev",{"^->":"finale.0.c-0.7.0.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-0",flg:18},{s:["^Bright future.",{"->":"$r",var:!0},null]}],{"c-0":["ev",{"^->":"finale.0.c-0.7.c-0.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.0.s"},[{"#n":"$r2"}],"\n",[["ev",{"^->":"finale.0.c-0.7.c-0.7.0.$r1"},{"temp=":"$r"},"str",{"->":".^.s"},[{"#n":"$r1"}],"/str","/ev",{"*":".^.^.c-0",flg:18},{s:["^Bright communist future.",{"->":"$r",var:!0},null]}],{"c-0":["ev",{"^->":"finale.0.c-0.7.c-0.7.c-0.$r2"},"/ev",{"temp=":"$r"},{"->":".^.^.0.s"},[{"#n":"$r2"}],"\n",'^<br><blockquote><i>We know our time is interesting, but yours is much more so. We are building communism and you live it. We believe that you have perfectly equipped our blue planet, colonised the Moon, landed on Mars; that you are continuing the exploration of outer space that we, people of the first 50 years, have begun, and that your ships are sailing across the galaxy. We believe that the work that our fathers and grandfathers started 50 years ago and which we share, you will finish and bring to victory.</i><br><p style="text-align: right">An excerpt from letter found in real<br/> time capsule, planted in 1967 in the wall<br/>of the House of Culture in Novosibirsk</p></blockquote>',"\n","done",{"#f":5}]}],{"#f":5}]}],{"#f":5}]}],{"#f":3}],"global decl":["ev",0,{"VAR=":"has_cover"},0,{"VAR=":"has_knife"},0,{"VAR=":"has_wrench"},0,{"VAR=":"has_glass"},0,{"VAR=":"has_papers"},0,{"VAR=":"has_tape"},0,{"VAR=":"chamber_door_open"},16,{"VAR=":"voltage"},0,{"VAR=":"tumbler1"},0,{"VAR=":"tumbler2"},0,{"VAR=":"tumbler3"},1,{"VAR=":"tumbler4"},0,{"VAR=":"tumbler5"},0,{"VAR=":"storage_door_open"},0,{"VAR=":"glass_cube_broken"},0,{"VAR=":"engine_room_open"},0,{"VAR=":"used_cover"},0,{"VAR=":"has_warm"},"/ev","end",null],"#f":3}],listDefs:{}}},ZYns:function(e){var t=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e};!function(t,n){e.exports=n()}("undefined"!=typeof self&&self,function(){return function(e){function t(i){if(n[i])return n[i].exports;var r=n[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,i){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:i})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(t.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var r in e)t.d(i,r,function(t){return e[t]}.bind(null,r));return i},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="/",t(t.s=0)}([function(e,t,n){e.exports=n(1)},function(e,t,n){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function r(e){return new Promise(function(){throw new Error(e+" is not implemented")})}var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o=i(n(2)),s=i(n(6)),u=i(n(7)),l=i(n(8));e.exports=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.events={loadStory:function(){return r("loadStory")},loadGame:function(){return r("loadGame")},saveGame:function(){return r("saveGame")},error:function(){return r("error")}},this.inkObservers=new u.default,this.inkFunctions=new l.default,this.inkCommands={},this.episode={},this.command={},this.transcript=[]}return a(e,[{key:"startGame",value:function(){var e=this;return this.loadEpisode(this.game.episodes[0]).then(function(){e.episode.reset()})}},{key:"loadGame",value:function(e){var t=this,n={};return this.dispatch("loadGame",e).then(function(e){return n=JSON.parse(e),t.loadEpisode(n.episode.filename)}).then(function(){t.episode.restoreState(n.episode)})}},{key:"saveGame",value:function(e){return this.dispatch("saveGame",{id:e,data:this.getGameState()})}},{key:"renderScene",value:function(){var e=this.episode.renderScene(this.command);return this.game.transcript&&this.transcript.push(e),e}},{key:"getCurrentEpisode",value:function(){return this.episode.content}},{key:"getCurrentScene",value:function(){return this.episode.getCurrentScene()}},{key:"getTranscript",value:function(){return this.transcript}},{key:"makeChoice",value:function(e){var t=this;return new Promise(function(n,i){try{t.game.transcript&&(t.transcript[t.transcript.length-1].chosen=e),t.episode.makeChoice(e)}catch(e){t.dispatch("error",e),i(e)}n()})}},{key:"loadEpisode",value:function(e){var t=this;return this.dispatch("loadStory",e).then(function(n){var i=n;if("string"==typeof n){var r=n.replace("\ufeff","");i=JSON.parse(r)}t.initEpisode(e,i)})}},{key:"initEpisode",value:function(e,t){var n=this;this.episode=new o.default(e,t,this.inkObservers,this.inkFunctions),this.command=new s.default({episode:this.episode,story:this.episode.story}),Object.keys(this.inkCommands).forEach(function(e){var t=n.inkCommands[e];n.command.register(e,t.callback,t.deps)})}},{key:"getGameState",value:function(){return{episode:this.episode.getState()}}},{key:"on",value:function(e,t){this.events[e]=t}},{key:"dispatch",value:function(e,t){return this.events[e](t)}},{key:"registerFunctions",value:function(e){this.inkFunctions.register(e)}},{key:"registerObservers",value:function(e){this.inkObservers.register(e)}},{key:"registerCommand",value:function(e,t,n){this.inkCommands[e]={callback:t,deps:n}}},{key:"debug",value:function(){return this.episode.story.state}}]),e}()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),r=function(e){return e&&e.__esModule?e:{default:e}}(n(3));t.default=function(){function e(t,n,i,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=t,this.$episode=[],this.$story=new r.default(n),this.sceneId=-1,i.attach(this.$story),a.attach(this.$story)}return i(e,[{key:"reset",value:function(){this.$episode.splice(0),this.sceneId=-1}},{key:"renderScene",value:function(e){return this.updateEpisode(this.$story.getScene(e))}},{key:"getCurrentScene",value:function(){return this.$episode[this.$episode.length-1]}},{key:"makeChoice",value:function(e){this.$story.makeChoice(e)}},{key:"updateEpisode",value:function(e){return this.sceneId>=0&&(this.$episode[this.sceneId].isActive=!1),this.sceneId+=1,e.isActive=!0,e.id=this.sceneId,this.$episode.push(e),e}},{key:"getState",value:function(){return{filename:this.id,episode:this.$episode,story:JSON.parse(this.$story.saveState())}}},{key:"restoreState",value:function(e){this.id=e.filename,this.$episode=e.episode,this.$story.loadState(JSON.stringify(e.story))}},{key:"story",get:function(){return this.$story}},{key:"content",get:function(){return this.$episode}}]),e}()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),r=n(4),a=function(e){return e&&e.__esModule?e:{default:e}}(n(5));t.default=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.story=new r.Story(t)}return i(e,[{key:"getScene",value:function(e){return(0,a.default)(this.story,e)}},{key:"makeChoice",value:function(e){this.story.ChooseChoiceIndex(e)}},{key:"saveState",value:function(){return this.story.state.toJson()}},{key:"loadState",value:function(e){this.story.state.LoadJson(e)}},{key:"globalTags",value:function(){return this.story.globalTags}},{key:"tagsForKnot",value:function(e){return this.story.TagsForContentAtPath(e)}},{key:"goTo",value:function(e){this.story.ChoosePathString(e)}},{key:"getVar",value:function(e){return this.story.variablesState[e]}},{key:"getVars",value:function(){var e=this.story.variablesState,t={};return Object.keys(e._globalVariables).forEach(function(n){t[n]=e[n]}),t}},{key:"setVar",value:function(e,t){this.story.variablesState[e]=t}},{key:"setVars",value:function(e){var t=this;Object.keys(e).forEach(function(n){t.story.variablesState[n]=e[n]})}},{key:"getVisitCount",value:function(e){this.story.state.VisitCountAtPathString(e)}},{key:"observeVar",value:function(e,t){this.story.ObserveVariable(e,t)}},{key:"bindFunction",value:function(e,t){this.story.BindExternalFunction(e,t)}},{key:"state",get:function(){return this.story.state}}]),e}()},function(e,n){"use strict";function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s,u,l,c=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(t,i){"object"===h(n)&&void 0!==e?i(n):(u=[n],void 0===(l="function"==typeof(s=i)?s.apply(n,u):s)||(e.exports=l))}(0,function(e){var n=function(){function e(){o(this,e),this._components=[],this._componentsString=null,"string"==typeof arguments[0]?this.componentsString=arguments[0]:arguments[0]instanceof s&&arguments[1]instanceof e?(this._components.push(arguments[0]),this._components=this._components.concat(arguments[1]._components)):arguments[0]instanceof Array&&(this._components=this._components.concat(arguments[0]),this._isRelative=!!arguments[1])}return c(e,[{key:"GetComponent",value:function(e){return this._components[e]}},{key:"PathByAppendingPath",value:function(t){for(var n=new e,i=0,r=0;r<t._components.length&&t._components[r].isParent;++r)i++;for(r=0;r<this._components.length-i;++r)n._components.push(this._components[r]);for(r=i;r<t._components.length;++r)n._components.push(t._components[r]);return n}},{key:"toString",value:function(){return this.componentsString}},{key:"Equals",value:function(e){if(null==e)return!1;if(e._components.length!=this._components.length)return!1;if(e.isRelative!=this.isRelative)return!1;for(var t=0,n=e._components.length;t<n;t++)if(!e._components[t].Equals(this._components[t]))return!1;return!0}},{key:"PathByAppendingComponent",value:function(t){var n=new e;return n._components.push.apply(n._components,this._components),n._components.push(t),n}},{key:"isRelative",get:function(){return this._isRelative}},{key:"componentCount",get:function(){return this._components.length}},{key:"head",get:function(){return this._components.length>0?this._components[0]:null}},{key:"tail",get:function(){return this._components.length>=2?new e(this._components.slice(1,this._components.length)):e.self}},{key:"length",get:function(){return this._components.length}},{key:"lastComponent",get:function(){var e=this._components.length-1;return e>=0?this._components[e]:null}},{key:"containsNamedComponent",get:function(){for(var e=0,t=this.components.length;e<t;e++)if(!this.components[e].isIndex)return!0;return!1}},{key:"componentsString",get:function(){return null==this._componentsString&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString},set:function(e){var t=this;this._components.length=0,null!=(this._componentsString=e)&&""!=this._componentsString&&("."==this._componentsString[0]&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1)),this._componentsString.split(".").forEach(function(e){t._components.push(/^(\-|\+)?([0-9]+|Infinity)$/.test(e)?new s(parseInt(e)):new s(e))}))}}],[{key:"self",get:function(){var t=new e;return t._isRelative=!0,t}}]),e}(),s=function(){function e(t){o(this,e),"string"==typeof t?(this._index=-1,this._name=t):(this._index=parseInt(t),this._name=null)}return c(e,[{key:"toString",value:function(){return this.isIndex?this.index.toString():this.name}},{key:"Equals",value:function(e){return null!=e&&e.isIndex==this.isIndex&&(this.isIndex?this.index==e.index:this.name==e.name)}},{key:"index",get:function(){return this._index}},{key:"name",get:function(){return this._name}},{key:"isIndex",get:function(){return this.index>=0}},{key:"isParent",get:function(){return this.name==n.parentId}}],[{key:"ToParent",value:function(){return new e(n.parentId)}}]),e}();n.parentId="^",n.Component=s;var u=function(){function e(){o(this,e),this.parent=null,this._path=null}return c(e,[{key:"ResolvePath",value:function(e){if(e.isRelative){var t=this;return t instanceof T==0&&(null==this.parent&&console.warn("Can't resolve relative path because we don't have a parent"),"Container"!==(t=this.parent).constructor.name&&console.warn("Expected parent to be a container"),e=e.tail),t.ContentAtPath(e)}return this.rootContentContainer.ContentAtPath(e)}},{key:"ConvertPathToRelative",value:function(e){for(var t=this.path,i=Math.min(e.componentCount,t.componentCount),r=-1,a=0;a<i;++a){if(!t.GetComponent(a).Equals(e.GetComponent(a)))break;r=a}if(-1==r)return e;for(var o=t.componentCount-1-r,s=[],u=0;u<o;++u)s.push(n.Component.ToParent());for(var l=r+1;l<e.componentCount;++l)s.push(e.GetComponent(l));return new n(s,!0)}},{key:"CompactPathString",value:function(e){var t=null,n=null;return e.isRelative?(n=e.componentsString,t=this.path.PathByAppendingPath(e).componentsString):(n=this.ConvertPathToRelative(e).componentsString,t=e.componentsString),n.length<t.length?n:t}},{key:"Copy",value:function(){throw"Not Implemented"}},{key:"SetChild",value:function(e,t,n){e[t]&&(e[t]=null),(e[t]=n)&&(e[t].parent=this)}},{key:"path",get:function(){if(null==this._path)if(null==this.parent)this._path=new n;else{for(var e=[],t=this,i=t.parent;i instanceof T;){var r=t;e.unshift(r.name&&r.hasValidName?new n.Component(r.name):new n.Component(i.content.indexOf(t))),t=i,i=i.parent}this._path=new n(e)}return this._path}},{key:"rootContentContainer",get:function(){for(var e=this;e.parent;)e=e.parent;return e}}]),e}(),l=function(){function e(t){o(this,e),t=void 0!==t?t.toString():"",this._string=t}return c(e,[{key:"Append",value:function(e){this._string+=e}},{key:"AppendLine",value:function(e){void 0!==e&&this.Append(e),this._string+="\n"}},{key:"AppendFormat",value:function(e){var t=Array.prototype.slice.call(arguments,1);this._string+=e.replace(/{(\d+)}/g,function(e,n){return void 0!==t[n]?t[n]:e})}},{key:"toString",value:function(){return this._string}},{key:"Length",get:function(){return this._string.length}}]),e}(),f=function(){function e(t,n){if(o(this,e),void 0!==n)this.originName=t,this.itemName=n;else{var i=t.toString().split(".");this.originName=i[0],this.itemName=i[1]}}return c(e,[{key:"isNull",value:function(){return null==this.originName&&null==this.itemName}},{key:"toString",value:function(){return this.fullname}},{key:"Equals",value:function(t){if(t instanceof e){var n=t;return n.itemName==this.itemName&&n.originName==this.originName}return!1}},{key:"toString",value:function(){var e="0",t=this.itemName?this.itemName.toString():"null";return null!=this.originName&&(e=this.originName.toString()),e+"."+t}},{key:"fullName",get:function(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}}],[{key:"Null",value:function(){return new e(null,null)}}]),e}(),d=function(){function e(t,n){var i=this;if(o(this,e),this._keys={},this._values={},this.origins=null,this._originNames=null,t)if(t instanceof e){var r=t;r.forEach(function(e){i.Add(e.Key,e.Value)}),this._originNames=r._originNames}else if("string"==typeof t){this.SetInitialOriginName(t);var a=null;if(!(a=n.listDefinitions.TryGetListDefinition(t,a)))throw new Error("InkList origin could not be found in story when constructing new list: "+singleOriginListName);this.origins=[a]}else if(t.hasOwnProperty("Key")&&t.hasOwnProperty("Value")){var s=t;this.Add(s.Key,s.Value)}}return c(e,[{key:"forEach",value:function(e){for(var t in this._values)e({Key:this._keys[t],Value:this._values[t]})}},{key:"AddItem",value:function(e){var t=this;if(e instanceof f){if(null==(r=e).originName)return void this.AddItem(r.itemName);throw this.origins.forEach(function(e){if(e.name==r.originName){var n;if(void 0!==(n=e.TryGetValueForItem(r,n)))return void t.Add(r,n);throw"Could not add the item "+r+" to this list because it doesn't exist in the original list definition in ink."}}),"Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found."}var n=e,i=null;if(this.origins.forEach(function(e){if(e.ContainsItemWithName(n)){if(null!=i)throw"Could not add the item "+n+" to this list because it could come from either "+e.name+" or "+i.name;i=e}}),null==i)throw"Could not add the item "+n+" to this list because it isn't known to any list definitions previously associated with this list.";var r=new f(i.name,n),a=i.ValueForItem(r);this.Add(r,a)}},{key:"ContainsItemNamed",value:function(e){var t=!1;return this.forEach(function(n){n.Key.itemName==e&&(t=!0)}),t}},{key:"ContainsKey",value:function(e){return e in this._values}},{key:"Add",value:function(e,t){this._keys[e]=e,this._values[e]=t}},{key:"Remove",value:function(e){delete this._values[e],delete this._keys[e]}},{key:"SetInitialOriginName",value:function(e){this._originNames=[e]}},{key:"SetInitialOriginNames",value:function(e){this._originNames=null==e?null:e.slice()}},{key:"Union",value:function(t){var n=new e(this);return t.forEach(function(e){n.Add(e.Key,e.Value)}),n}},{key:"Intersect",value:function(t){var n=new e;return this.forEach(function(e){t.ContainsKey(e.Key)&&n.Add(e.Key,e.Value)}),n}},{key:"Without",value:function(t){var n=new e(this);return t.forEach(function(e){n.Remove(e.Key)}),n}},{key:"Contains",value:function(e){var t=this,n=!0;return e.forEach(function(e){t.ContainsKey(e.Key)||(n=!1)}),n}},{key:"GreaterThan",value:function(e){return 0!=this.Count&&(0==e.Count||this.minItem.Value>e.maxItem.Value)}},{key:"GreaterThanOrEquals",value:function(e){return 0!=this.Count&&(0==e.Count||this.minItem.Value>=e.minItem.Value&&this.maxItem.Value>=e.maxItem.Value)}},{key:"LessThan",value:function(e){return 0!=e.Count&&(0==this.Count||this.maxItem.Value<e.minItem.Value)}},{key:"LessThanOrEquals",value:function(e){return 0!=e.Count&&(0==this.Count||this.maxItem.Value<=e.maxItem.Value&&this.minItem.Value<=e.minItem.Value)}},{key:"MaxAsList",value:function(){return this.Count>0?new e(this.maxItem):new e}},{key:"MinAsList",value:function(){return this.Count>0?new e(this.minItem):new e}},{key:"Equals",value:function(t){var n=t;if(n instanceof e==0)return!1;if(n.Count!=this.Count)return!1;var i=!0;return this.forEach(function(e){n.ContainsKey(e.Key)||(i=!1)}),i}},{key:"toString",value:function(){var e=[];this.forEach(function(t){e.push(t)}),e=e.sort(function(e,t){return e.Value===t.Value?0:e.Value>t.Value?1:-1});for(var t=new l,n=0;n<e.length;n++){n>0&&t.Append(", ");t.Append(e[n].Key.itemName)}return t.toString()}},{key:"valueOf",value:function(){return NaN}},{key:"Count",get:function(){return Object.keys(this._values).length}},{key:"originOfMaxItem",get:function(){if(null==this.origins)return null;var e=this.maxItem.Key.originName,t=null;return this.origins.every(function(n){return n.name!=e||(t=n,!1)}),t}},{key:"originNames",get:function(){var e=this;return this.Count>0&&(null==this._originNames&&this.Count>0?this._originNames=[]:this._originNames.length=0,this.forEach(function(t){e._originNames.push(t.Key.originName)})),this._originNames}},{key:"maxItem",get:function(){var e={Key:null,Value:null};return this.forEach(function(t){(null===e.Key||t.Value>e.Value)&&(e=t)}),e}},{key:"minItem",get:function(){var e={Key:null,Value:null};return this.forEach(function(t){(null===e.Key||t.Value<e.Value)&&(e=t)}),e}},{key:"inverse",get:function(){var t=this,n=new e;return null!=this.origins&&this.origins.forEach(function(e){e.items.forEach(function(e){t.ContainsKey(e.Key)||n.Add(e.Key,e.Value)})}),n}},{key:"all",get:function(){var t=new e;return null!=this.origins&&this.origins.forEach(function(e){e.items.forEach(function(e){t.Add(e.Key,e.Value)})}),t}}]),e}(),p=function(){function e(t){o(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.useEndLineNumber=!1,n.message=t,n.name="StoryException",n}return a(e,Error),e}(),v={Int:0,Float:1,List:2,String:3,DivertTarget:4,VariablePointer:5},m=function(){function e(){o(this,e);var t=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t}return a(e,u),c(e,[{key:"Cast",value:function(){throw"Trying to casting an AbstractValue"}},{key:"Copy",value:function(t){return e.Create(t)}},{key:"BadCastException",value:function(e){return new p("Can't cast "+this.valueObject+" from "+this.valueType+" to "+e)}},{key:"valueType",get:function(){return this._valueType}},{key:"isTruthy",get:function(){return this._isTruthy}},{key:"valueObject",get:function(){return this._valueObject}}],[{key:"Create",value:function(e){return"boolean"==typeof e&&(e=e?1:0),Number.isInteger(Number(e))?new y(e):isNaN(e)?"string"==typeof e?new b(e):e instanceof n?new k(e):e instanceof d?new w(e):null:new g(e)}}]),e}(),_=function(){function e(t){o(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.value=t,n}return a(e,m),c(e,[{key:"toString",value:function(){return this.value.toString()}},{key:"value",get:function(){return this._value},set:function(e){this._value=e}},{key:"valueObject",get:function(){return this.value}}]),e}(),y=function(){function e(t){o(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t||0));return n._valueType=v.Int,n}return a(e,_),c(e,[{key:"Cast",value:function(e){if(e==this.valueType)return this;if(e==v.Float)return new g(parseFloat(this.value));if(e==v.String)return new b(""+this.value);throw this.BadCastException(e)}},{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return v.Int}}]),e}(),g=function(){function e(t){o(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t||0));return n._valueType=v.Float,n}return a(e,_),c(e,[{key:"Cast",value:function(e){if(e==this.valueType)return this;if(e==v.Int)return new y(parseInt(this.value));if(e==v.String)return new b(""+this.value);throw this.BadCastException(e)}},{key:"isTruthy",get:function(){return 0!=this._value}},{key:"valueType",get:function(){return v.Float}}]),e}(),b=function(){function e(t){o(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t||""));return n._valueType=v.String,n._isNewline="\n"==n.value,n._isInlineWhitespace=!0,n.value.split().every(function(e){return" "==e||"\t"==e||(n._isInlineWhitespace=!1,!1)}),n}return a(e,_),c(e,[{key:"Cast",value:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){if(e==this.valueType)return this;var t,n;if(e==v.Int)return(t=parseInt(value))?new y(t):null;if(e==v.Float)return(n=n(value))?new g(n):null;throw this.BadCastException(e)})},{key:"valueType",get:function(){return v.String}},{key:"isTruthy",get:function(){return this.value.length>0}},{key:"isNewline",get:function(){return this._isNewline}},{key:"isInlineWhitespace",get:function(){return this._isInlineWhitespace}},{key:"isNonWhitespace",get:function(){return!this.isNewline&&!this.isInlineWhitespace}}]),e}(),k=function(){function e(t){o(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n._valueType=v.DivertTarget,n}return a(e,_),c(e,[{key:"Cast",value:function(e){if(e==this.valueType)return this;throw this.BadCastException(e)}},{key:"toString",value:function(){return"DivertTargetValue("+this.targetPath+")"}},{key:"targetPath",get:function(){return this.value},set:function(e){this.value=e}},{key:"isTruthy",get:function(){throw"Shouldn't be checking the truthiness of a divert target"}}]),e}(),S=function(){function e(t,n){o(this,e);var i=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i._valueType=v.VariablePointer,i.contextIndex=void 0!==n?n:-1,i}return a(e,_),c(e,[{key:"Cast",value:function(e){if(e==this.valueType)return this;throw this.BadCastException(e)}},{key:"toString",value:function(){return"VariablePointerValue("+this.variableName+")"}},{key:"Copy",value:function(){return new e(this.variableName,this.contextIndex)}},{key:"variableName",get:function(){return this.value},set:function(e){this.value=e}},{key:"isTruthy",get:function(){throw"Shouldn't be checking the truthiness of a variable pointer"}}]),e}(),w=function(){function e(t,n){o(this,e);var i=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,null));return i._valueType=v.List,i.value=t instanceof d?new d(t):void 0!==t&&void 0!==n?new d({Key:t,Value:n}):new d,i}return a(e,_),c(e,[{key:"Cast",value:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){var t;if(e==v.Int)return new y((t=this.value.maxItem).Key.isNull?0:t.Value);if(e==v.Float)return new g((t=this.value.maxItem).Key.isNull?0:parseFloat(t.Value));if(e==v.String)return new b((t=value.maxItem).Key.isNull?"":t.Key.toString());if(e==this.valueType)return this;throw this.BadCastException(e)})},{key:"valueType",get:function(){return v.List}},{key:"isTruthy",get:function(){var e=!1;return this.value.forEach(function(t){0!=t.Value&&(e=!0)}),e}}]),c(e,null,[{key:"RetainListOriginsForAssignment",value:function(t,n){var i=t,r=n;i instanceof e&&r instanceof e&&0==r.value.Count&&r.value.SetInitialOriginNames(i.value.originNames)}}]),e}(),C=function(){function e(){o(this,e)}return c(e,[{key:"copy",value:function(){var t=new e;return t.obj=this.obj,t.approximate=this.approximate,t}},{key:"correctObj",get:function(){return this.approximate?null:this.obj}},{key:"container",get:function(){return this.obj instanceof T?this.obj:null}}]),e}(),T=function(){function e(){o(this,e);var t=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t.name="",t._content=[],t.namedContent={},t.visitsShouldBeCounted=!1,t.turnIndexShouldBeCounted=!1,t.countingAtStartOnly=!1,t.CountFlags={Visits:1,Turns:2,CountStartOnly:4},t._pathToFirstLeafContent=null,t}return a(e,u),c(e,[{key:"AddContent",value:function(e){var t=this;if(e instanceof Array)e.forEach(function(e){t.AddContent(e)});else{if(this._content.push(e),e.parent)throw"content is already in "+e.parent;e.parent=this,this.TryAddNamedContent(e)}}},{key:"TryAddNamedContent",value:function(e){e.hasValidName&&e.name&&this.AddToNamedContentOnly(e)}},{key:"AddToNamedContentOnly",value:function(e){e instanceof u==0&&console.warn("Can only add Runtime.Objects to a Runtime.Container"),e.parent=this,this.namedContent[e.name]=e}},{key:"ContentAtPath",value:function(t,n,i){n=void 0!==n?n:0,i=void 0!==i?i:t.length;var r=new C;r.approximate=!1;for(var a=this,o=this,s=n;s<i;++s){var u=t.GetComponent(s);if(null==a){r.approximate=!0;break}var l=a.ContentWithPathComponent(u);if(null==l){r.approximate=!0;break}o=l,a=l instanceof e?l:null}return r.obj=o,r}},{key:"InsertContent",value:function(e){if(this.content[i]=e,e.parent)throw"content is already in "+e.parent;e.parent=this,this.TryAddNamedContent(e)}},{key:"AddContentsOfContainer",value:function(e){var t=this;this.content=this.content.concat(e.content),e.content.forEach(function(e){e.parent=t,t.TryAddNamedContent(e)})}},{key:"ContentWithPathComponent",value:function(e){if(e.isIndex)return e.index>=0&&e.index<this.content.length?this.content[e.index]:null;if(e.isParent)return this.parent;var t;return(t=this.namedContent[e.name])?t:null}},{key:"BuildStringOfHierarchy",value:function(t,n,i){function r(){for(var e=0;e<4*n;++e)t.Append(" ")}if(0==arguments.length)return t=new l,this.BuildStringOfHierarchy(t,0,null),t.toString();r(),t.Append("["),this.hasValidName&&t.AppendFormat(" ({0})",this.name),this==i&&t.Append("  <---"),t.AppendLine(),n++;for(var a=0;a<this.content.length;++a){var o=this.content[a];o instanceof e?o.BuildStringOfHierarchy(t,n,i):(r(),o instanceof b?(t.Append('"'),t.Append(o.toString().replace("\n","\\n")),t.Append('"')):t.Append(o.toString())),a!=this.content.length-1&&t.Append(","),o instanceof e||o!=i||t.Append("  <---"),t.AppendLine()}var s={};for(var u in this.namedContent)this.content.indexOf(this.namedContent[u])>=0||(s[u]=this.namedContent[u]);if(Object.keys(s).length>0)for(var u in r(),t.AppendLine("-- named: --"),s)s[u]instanceof e||console.warn("Can only print out named Containers"),s[u].BuildStringOfHierarchy(t,n,i),t.Append("\n");n--,r(),t.Append("]")}},{key:"hasValidName",get:function(){return null!=this.name&&this.name.length>0}},{key:"content",get:function(){return this._content},set:function(e){this.AddContent(e)}},{key:"namedOnlyContent",get:function(){var e={};for(var t in this.namedContent)e[t]=this.namedContent[t];return this.content.forEach(function(t){var n=t;n.name&&n.hasValidName&&delete e[n.name]}),0==Object.keys(e).length&&(e=null),e},set:function(e){var t=this.namedOnlyContent;if(null!=t)for(var n in t)delete this.namedContent[n];if(null!=e)for(var n in e){var i=e[n];i.name&&void 0!==i.hasValidName&&this.AddToNamedContentOnly(i)}}},{key:"countFlags",get:function(){var e=0;return this.visitsShouldBeCounted&&(e|=this.CountFlags.Visits),this.turnIndexShouldBeCounted&&(e|=this.CountFlags.Turns),this.countingAtStartOnly&&(e|=this.CountFlags.CountStartOnly),e==this.CountFlags.CountStartOnly&&(e=0),e},set:function(e){var t=e;(t&this.CountFlags.Visits)>0&&(this.visitsShouldBeCounted=!0),(t&this.CountFlags.Turns)>0&&(this.turnIndexShouldBeCounted=!0),(t&this.CountFlags.CountStartOnly)>0&&(this.countingAtStartOnly=!0)}},{key:"pathToFirstLeafContent",get:function(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}},{key:"internalPathToFirstLeafContent",get:function(){for(var t=[],n=this;n instanceof e;)n.content.length>0&&(t.push(new Path.Component(0)),n=n.content[0]);return new Path(t)}}]),e}(),A=function(){function e(){return o(this,e),r(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return a(e,u),c(e,[{key:"toString",value:function(){return"Glue"}}]),e}(),x=function(){function e(t){o(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n._commandType=void 0!==t?t:O.NotSet,n}return a(e,u),c(e,[{key:"copy",value:function(){return new e(this.commandType)}},{key:"toString",value:function(){return this.commandType.toString()}},{key:"commandType",get:function(){return this._commandType}}],[{key:"EvalStart",value:function(){return new e(O.EvalStart)}},{key:"EvalOutput",value:function(){return new e(O.EvalOutput)}},{key:"EvalEnd",value:function(){return new e(O.EvalEnd)}},{key:"Duplicate",value:function(){return new e(O.Duplicate)}},{key:"PopEvaluatedValue",value:function(){return new e(O.PopEvaluatedValue)}},{key:"PopFunction",value:function(){return new e(O.PopFunction)}},{key:"PopTunnel",value:function(){return new e(O.PopTunnel)}},{key:"BeginString",value:function(){return new e(O.BeginString)}},{key:"EndString",value:function(){return new e(O.EndString)}},{key:"NoOp",value:function(){return new e(O.NoOp)}},{key:"ChoiceCount",value:function(){return new e(O.ChoiceCount)}},{key:"TurnsSince",value:function(){return new e(O.TurnsSince)}},{key:"ReadCount",value:function(){return new e(O.ReadCount)}},{key:"Random",value:function(){return new e(O.Random)}},{key:"SeedRandom",value:function(){return new e(O.SeedRandom)}},{key:"VisitIndex",value:function(){return new e(O.VisitIndex)}},{key:"SequenceShuffleIndex",value:function(){return new e(O.SequenceShuffleIndex)}},{key:"StartThread",value:function(){return new e(O.StartThread)}},{key:"Done",value:function(){return new e(O.Done)}},{key:"End",value:function(){return new e(O.End)}},{key:"ListFromInt",value:function(){return new e(O.ListFromInt)}},{key:"ListRange",value:function(){return new e(O.ListRange)}}]),e}(),O={NotSet:-1,EvalStart:0,EvalOutput:1,EvalEnd:2,Duplicate:3,PopEvaluatedValue:4,PopFunction:5,PopTunnel:6,BeginString:7,EndString:8,NoOp:9,ChoiceCount:10,TurnsSince:11,Random:12,SeedRandom:13,VisitIndex:14,SequenceShuffleIndex:15,StartThread:16,Done:17,End:18,ListFromInt:19,ListRange:20,ReadCount:21};O.TOTAL_VALUES=Object.keys(O).length-1,x.CommandType=O;var E={Tunnel:0,Function:1,FunctionEvaluationFromGame:2},P=function(){function e(t,n){o(this,e),this.container=t,this.index=n}return c(e,[{key:"Resolve",value:function(){return this.index<0?this.container:null==this.container?null:0==this.container.content.length?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}},{key:"toString",value:function(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}},{key:"copy",value:function(){return new e(this.container,this.index)}},{key:"isNull",get:function(){return null==this.container}},{key:"path",get:function(){return this.isNull?null:this.index>=0?this.container.path.PathByAppendingComponent(new n.Component(this.index)):this.container.path}}],[{key:"StartOf",value:function(t){return new e(t,0)}},{key:"Null",get:function(){return new e(null,-1)}}]),e}(),I=function(){function e(t){o(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.pushesToStack=!1,t&&(n.pushesToStack=!0,n.stackPushType=t),n}return a(e,u),c(e,[{key:"Equals",value:function(t){var n=t;return n instanceof e&&this.hasVariableTarget==n.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==n.variableDivertName:this.targetPath.Equals(n.targetPath))}},{key:"toString",value:function(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";var e=new l,t=this.targetPath.toString();return e.Append("Divert"),this.isConditional&&e.Append("?"),this.pushesToStack&&e.Append(this.stackPushType==E.Function?" function":" tunnel"),e.Append(" -> "),e.Append(this.targetPathString),e.Append(" ("),e.Append(t),e.Append(")"),e.toString()}},{key:"targetPath",get:function(){if(null!=this._targetPath&&this._targetPath.isRelative){var e=this.targetPointer.Resolve();e&&(this._targetPath=e.path)}return this._targetPath},set:function(e){this._targetPath=e,this._targetPointer=P.Null}},{key:"targetPointer",get:function(){if(this._targetPointer.isNull){var e=this.ResolvePath(this._targetPath).obj;this._targetPath.lastComponent.isIndex?(this._targetPointer.container=e.parent instanceof T?e.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index):this._targetPointer=P.StartOf(e instanceof T?e:null)}return this._targetPointer.copy()}},{key:"targetPathString",get:function(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)},set:function(e){this.targetPath=null==e?null:new n(e)}},{key:"hasVariableTarget",get:function(){return null!=this.variableDivertName}}]),e}(),V=function(){function e(t){o(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.onceOnly=!!t,n}return a(e,u),c(e,[{key:"toString",value:function(){return"Choice: -> "+this.pathOnChoice.toString()}},{key:"pathOnChoice",get:function(){if(null!=this._pathOnChoice&&this._pathOnChoice.isRelative){var e=this.choiceTarget;e&&(this._pathOnChoice=e.path)}return this._pathOnChoice},set:function(e){this._pathOnChoice=e}},{key:"choiceTarget",get:function(){return this.ResolvePath(this._pathOnChoice).container}},{key:"pathStringOnChoice",get:function(){return this.CompactPathString(this.pathOnChoice)},set:function(e){this.pathOnChoice=new n(e)}},{key:"flags",get:function(){var e=0;return this.hasCondition&&(e|=1),this.hasStartContent&&(e|=2),this.hasChoiceOnlyContent&&(e|=4),this.isInvisibleDefault&&(e|=8),this.onceOnly&&(e|=16),e},set:function(e){this.hasCondition=(1&e)>0,this.hasStartContent=(2&e)>0,this.hasChoiceOnlyContent=(4&e)>0,this.isInvisibleDefault=(8&e)>0,this.onceOnly=(16&e)>0}}]),e}(),N=function(){function e(t){o(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.name=t,n}return a(e,u),c(e,[{key:"toString",value:function(){return null!=this.name?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}},{key:"containerForCount",get:function(){return this.ResolvePath(this.pathForCount).container}},{key:"pathStringForCount",get:function(){return null==this.pathForCount?null:this.CompactPathString(this.pathForCount)},set:function(e){this.pathForCount=null==e?null:new n(e)}}]),e}(),F=function(){function e(t,n){o(this,e);var i=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i._variableName=t||null,i._isNewDeclaration=!!n,i}return a(e,u),c(e,[{key:"toString",value:function(){return"VarAssign to "+this.variableName}},{key:"variableName",get:function(){return this._variableName}},{key:"isNewDeclaration",get:function(){return this._isNewDeclaration}}]),e}(),R=function(){function e(){return o(this,e),r(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return a(e,u),e}(),L=function(){function e(t){o(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.name=t,n._operationFuncs=null,e.GenerateNativeFunctionsIfNecessary(),n}return a(e,u),c(e,[{key:"Call",value:function(e){if(this._prototype)return this._prototype.Call(e);if(this.numberOfParameters!=e.length)throw"Unexpected number of parameters";var t=!1;if(e.forEach(function(e){if(e instanceof R)throw new p("Attempting to perform operation on a void value. Did you forget to 'return' a value from a function you called here?");e instanceof w&&(t=!0)}),2==e.length&&t)return this.CallBinaryListOperation(e);var n=this.CoerceValuesToSingleType(e),i=n[0].valueType;return i==v.Int?this.CallType(n):i==v.Float?this.CallType(n):i==v.String?this.CallType(n):i==v.DivertTarget?this.CallType(n):i==v.List?this.CallType(n):null}},{key:"CallType",value:function(e){var t=e[0],n=t.valueType,i=t,r=e.length;if(2==r||1==r){var a=this._operationFuncs[n];if(!a)throw new p("Cannot perform operation '"+this.name+"' on "+n);if(2==r){var o=e[1],s=a(i.value,o.value);return _.Create(s)}return s=a(i.value),_.Create(s)}throw"Unexpected number of parameters to NativeFunctionCall: "+e.length}},{key:"CallBinaryListOperation",value:function(e){if(("+"==this.name||"-"==this.name)&&e[0]instanceof w&&e[1]instanceof y)return this.CallListIncrementOperation(e);var t=e[0],n=e[1];if(!("&&"!=this.name&&"||"!=this.name||t.valueType==v.List&&n.valueType==v.List)){var i=(0,this._operationFuncs[v.Int])(t.isTruthy?1:0,n.isTruthy?1:0);return new y(i)}if(t.valueType==v.List&&n.valueType==v.List)return this.CallType([t,n]);throw new p("Can not call use '"+this.name+"' operation on "+t.valueType+" and "+n.valueType)}},{key:"CallListIncrementOperation",value:function(e){var t=this,n=e[0],i=e[1],r=new d;return n.value.forEach(function(e){var a=e.Key,o=e.Value,s=(0,t._operationFuncs[v.Int])(o,i.value),u=null;if(n.value.origins.forEach(function(e){if(e.name==a.originName)return u=e,!1}),null!=u){var l=u.TryGetItemWithValue(s);l.exists&&r.Add(l.item,s)}}),new w(r)}},{key:"CoerceValuesToSingleType",value:function(e){var t=v.Int,n=null;e.forEach(function(e){var i=e;i.valueType>t&&(t=i.valueType),i.valueType==v.List&&(n=i)});var i=[];return e.forEach(t==v.List?function(e){if(e.valueType==v.List)i.push(e);else{if(e.valueType!=v.Int)throw new p("Cannot mix Lists and "+e.valueType+" values in this operation");var t=parseInt(e.valueObject),r=n.value.originOfMaxItem,a=r.TryGetItemWithValue(t);if(!a.exists)throw new p("Could not find List item with the value "+t+" in "+r.name);var o=new w(a.item,t);i.push(o)}}:function(e){var n=e.Cast(t);i.push(n)}),i}},{key:"AddOpFuncForType",value:function(e,t){null==this._operationFuncs&&(this._operationFuncs={}),this._operationFuncs[e]=t}},{key:"toString",value:function(){return"Native '"+this.name+"'"}},{key:"name",get:function(){return this._name},set:function(t){this._name=t,this._isPrototype||(this._prototype=e._nativeFunctions[this._name])}},{key:"numberOfParameters",get:function(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters},set:function(e){this._numberOfParameters=e}}],[{key:"internalConstructor",value:function(t,n){var i=new e(t);return i._isPrototype=!0,i.numberOfParameters=n,i}},{key:"CallWithName",value:function(t){return new e(t)}},{key:"CallExistsWithName",value:function(e){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions[e]}},{key:"GenerateNativeFunctionsIfNecessary",value:function(){null==this._nativeFunctions&&(this._nativeFunctions={},this.AddIntBinaryOp(this.Add,function(e,t){return e+t}),this.AddIntBinaryOp(this.Subtract,function(e,t){return e-t}),this.AddIntBinaryOp(this.Multiply,function(e,t){return e*t}),this.AddIntBinaryOp(this.Divide,function(e,t){return parseInt(e/t)}),this.AddIntBinaryOp(this.Mod,function(e,t){return e%t}),this.AddIntUnaryOp(this.Negate,function(e){return-e}),this.AddIntBinaryOp(this.Equal,function(e,t){return e==t?1:0}),this.AddIntBinaryOp(this.Greater,function(e,t){return e>t?1:0}),this.AddIntBinaryOp(this.Less,function(e,t){return e<t?1:0}),this.AddIntBinaryOp(this.GreaterThanOrEquals,function(e,t){return e>=t?1:0}),this.AddIntBinaryOp(this.LessThanOrEquals,function(e,t){return e<=t?1:0}),this.AddIntBinaryOp(this.NotEquals,function(e,t){return e!=t?1:0}),this.AddIntUnaryOp(this.Not,function(e){return 0==e?1:0}),this.AddIntBinaryOp(this.And,function(e,t){return 0!=e&&0!=t?1:0}),this.AddIntBinaryOp(this.Or,function(e,t){return 0!=e||0!=t?1:0}),this.AddIntBinaryOp(this.Max,function(e,t){return Math.max(e,t)}),this.AddIntBinaryOp(this.Min,function(e,t){return Math.min(e,t)}),this.AddFloatBinaryOp(this.Add,function(e,t){return e+t}),this.AddFloatBinaryOp(this.Subtract,function(e,t){return e-t}),this.AddFloatBinaryOp(this.Multiply,function(e,t){return e*t}),this.AddFloatBinaryOp(this.Divide,function(e,t){return e/t}),this.AddFloatBinaryOp(this.Mod,function(e,t){return e%t}),this.AddFloatUnaryOp(this.Negate,function(e){return-e}),this.AddFloatBinaryOp(this.Equal,function(e,t){return e==t?1:0}),this.AddFloatBinaryOp(this.Greater,function(e,t){return e>t?1:0}),this.AddFloatBinaryOp(this.Less,function(e,t){return e<t?1:0}),this.AddFloatBinaryOp(this.GreaterThanOrEquals,function(e,t){return e>=t?1:0}),this.AddFloatBinaryOp(this.LessThanOrEquals,function(e,t){return e<=t?1:0}),this.AddFloatBinaryOp(this.NotEquals,function(e,t){return e!=t?1:0}),this.AddFloatUnaryOp(this.Not,function(e){return 0==e?1:0}),this.AddFloatBinaryOp(this.And,function(e,t){return 0!=e&&0!=t?1:0}),this.AddFloatBinaryOp(this.Or,function(e,t){return 0!=e||0!=t?1:0}),this.AddFloatBinaryOp(this.Max,function(e,t){return Math.max(e,t)}),this.AddFloatBinaryOp(this.Min,function(e,t){return Math.min(e,t)}),this.AddStringBinaryOp(this.Add,function(e,t){return e+t}),this.AddStringBinaryOp(this.Equal,function(e,t){return e===t?1:0}),this.AddStringBinaryOp(this.NotEquals,function(e,t){return e!==t?1:0}),this.AddStringBinaryOp(this.Has,function(e,t){return e.includes(t)?1:0}),this.AddStringBinaryOp(this.Hasnt,function(e,t){return e.includes(t)?0:1}),this.AddListBinaryOp(this.Add,function(e,t){return e.Union(t)}),this.AddListBinaryOp(this.Subtract,function(e,t){return e.Without(t)}),this.AddListBinaryOp(this.Has,function(e,t){return e.Contains(t)?1:0}),this.AddListBinaryOp(this.Hasnt,function(e,t){return e.Contains(t)?0:1}),this.AddListBinaryOp(this.Intersect,function(e,t){return e.Intersect(t)}),this.AddListBinaryOp(this.Equal,function(e,t){return e.Equals(t)?1:0}),this.AddListBinaryOp(this.Greater,function(e,t){return e.GreaterThan(t)?1:0}),this.AddListBinaryOp(this.Less,function(e,t){return e.LessThan(t)?1:0}),this.AddListBinaryOp(this.GreaterThanOrEquals,function(e,t){return e.GreaterThanOrEquals(t)?1:0}),this.AddListBinaryOp(this.LessThanOrEquals,function(e,t){return e.LessThanOrEquals(t)?1:0}),this.AddListBinaryOp(this.NotEquals,function(e,t){return e.Equals(t)?0:1}),this.AddListBinaryOp(this.And,function(e,t){return e.Count>0&&t.Count>0?1:0}),this.AddListBinaryOp(this.Or,function(e,t){return e.Count>0||t.Count>0?1:0}),this.AddListUnaryOp(this.Not,function(e){return 0==e.Count?1:0}),this.AddListUnaryOp(this.Invert,function(e){return e.inverse}),this.AddListUnaryOp(this.All,function(e){return e.all}),this.AddListUnaryOp(this.ListMin,function(e){return e.MinAsList()}),this.AddListUnaryOp(this.ListMax,function(e){return e.MaxAsList()}),this.AddListUnaryOp(this.Count,function(e){return e.Count}),this.AddListUnaryOp(this.ValueOfList,function(e){return e.maxItem.Value}),this.AddOpToNativeFunc(this.Equal,2,v.DivertTarget,function(e,t){return e.Equals(t)?1:0}))}},{key:"AddOpToNativeFunc",value:function(t,n,i,r){var a=this._nativeFunctions[t];a||(a=e.internalConstructor(t,n),this._nativeFunctions[t]=a),a.AddOpFuncForType(i,r)}},{key:"AddIntBinaryOp",value:function(e,t){this.AddOpToNativeFunc(e,2,v.Int,t)}},{key:"AddIntUnaryOp",value:function(e,t){this.AddOpToNativeFunc(e,1,v.Int,t)}},{key:"AddFloatBinaryOp",value:function(e,t){this.AddOpToNativeFunc(e,2,v.Float,t)}},{key:"AddFloatUnaryOp",value:function(e,t){this.AddOpToNativeFunc(e,1,v.Float,t)}},{key:"AddStringBinaryOp",value:function(e,t){this.AddOpToNativeFunc(e,2,v.String,t)}},{key:"AddListBinaryOp",value:function(e,t){this.AddOpToNativeFunc(e,2,v.List,t)}},{key:"AddListUnaryOp",value:function(e,t){this.AddOpToNativeFunc(e,1,v.List,t)}}]),e}();L.Add="+",L.Subtract="-",L.Divide="/",L.Multiply="*",L.Mod="%",L.Negate="_",L.Equal="==",L.Greater=">",L.Less="<",L.GreaterThanOrEquals=">=",L.LessThanOrEquals="<=",L.NotEquals="!=",L.Not="!",L.And="&&",L.Or="||",L.Min="MIN",L.Max="MAX",L.Has="?",L.Hasnt="!?",L.Intersect="^",L.ListMin="LIST_MIN",L.ListMax="LIST_MAX",L.All="LIST_ALL",L.Count="LIST_COUNT",L.ValueOfList="LIST_VALUE",L.Invert="LIST_INVERT",L._nativeFunctions=null;var j=function(){function e(t){o(this,e);var n=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n._text=t.toString()||"",n}return a(e,u),c(e,[{key:"toString",value:function(){return"# "+this._text}},{key:"text",get:function(){return this._text}}]),e}(),D=function(){function e(){o(this,e),this.isInvisibleDefault=!1}return c(e,[{key:"pathStringOnChoice",get:function(){return this.targetPath.toString()},set:function(e){this.targetPath=new n(e)}}]),e}(),G=function(){function e(t,n){o(this,e),this._name=t||"",this._items=null,this._rawListItemsKeys=null,this._itemNameToValues=n||{}}return c(e,[{key:"forEachItems",value:function(e){for(var t in this._rawListItemsKeys)e({Key:this._rawListItemsKeys[t],Value:this._items[t]})}},{key:"ValueForItem",value:function(e){var t=this._itemNameToValues[e.itemName];return void 0!==t?t:0}},{key:"ContainsItem",value:function(e){return e.originName==this.name&&e.itemName in this._itemNameToValues}},{key:"ContainsItemWithName",value:function(e){return void 0!==this._itemNameToValues[e]}},{key:"TryGetItemWithValue",value:function(e){for(var t in this._itemNameToValues)if(this._itemNameToValues[t]==e)return{item:new f(this.name,t),exists:!0};return{item:f.Null,exists:!1}}},{key:"TryGetValueForItem",value:function(e){return intVal=this._itemNameToValues[e.itemName],intVal}},{key:"ListRange",value:function(e,t){var n=new d;for(var i in this._itemNameToValues)if(this._itemNameToValues[i]>=e&&this._itemNameToValues[i]<=t){var r=new f(this.name,i);n.Add(r,this._itemNameToValues[i])}return new w(n)}},{key:"name",get:function(){return this._name}},{key:"items",get:function(){if(null==this._items)for(var e in this._items={},this._rawListItemsKeys={},this._itemNameToValues){var t=new f(this.name,e);this._rawListItemsKeys[t]=t,this._items[t]=this._itemNameToValues[e]}return this._items.forEach=this.forEachItems.bind(this),this._items}}]),e}(),B=function(){function e(t){var n=this;o(this,e),this._lists={},this._allUnambiguousListValueCache={},t.forEach(function(e){n._lists[e.name]=e,e.items.forEach(function(e){var t=e.Key,i=e.Value,r=new w(t,i);n._allUnambiguousListValueCache[t.itemName]=r,n._allUnambiguousListValueCache[t.fullName]=r})})}return c(e,[{key:"TryListGetDefinition",value:function(e,t){return e in this._lists?this._lists[e]:t}},{key:"FindSingleItemListWithName",value:function(e){var t=null;return void 0!==this._allUnambiguousListValueCache[e]&&(t=this._allUnambiguousListValueCache[e]),t}},{key:"lists",get:function(){var e=[];for(var t in this._lists)e.push(this._lists[t]);return e}}]),e}(),M=function(){function e(){o(this,e)}return c(e,null,[{key:"ListToJArray",value:function(e){var t=this,n=[];return e.forEach(function(e){n.push(t.RuntimeObjectToJToken(e))}),n}},{key:"JArrayToRuntimeObjList",value:function(e,t){var n=e.length;t&&n--;for(var i=[],r=0;r<n;r++){i.push(this.JTokenToRuntimeObject(e[r]))}return i}},{key:"JObjectToDictionaryRuntimeObjs",value:function(e){var t={};for(var n in e)t[n]=this.JTokenToRuntimeObject(e[n]);return t}},{key:"DictionaryRuntimeObjsToJObject",value:function(e){var t={};for(var n in e){var i=e[n];i instanceof u&&(t[n]=this.RuntimeObjectToJToken(i))}return t}},{key:"JObjectToIntDictionary",value:function(e){var t={};for(var n in e)t[n]=parseInt(e[n]);return t}},{key:"IntDictionaryToJObject",value:function(e){var t={};for(var n in e)t[n]=e[n];return t}},{key:"JTokenToRuntimeObject",value:function(e){if(!isNaN(e)&&"\n"!==e)return _.Create(e);if("string"==typeof e){var t=e.toString(),i=t[0];if("^"==i)return new b(t.substring(1));if("\n"==i&&1==t.length)return new b("\n");if("<>"==t)return new A;for(var r=0;r<W.length;++r)if(t==W[r])return new x(r);if("L^"==t&&(t="^"),L.CallExistsWithName(t))return L.CallWithName(t);if("->->"==t)return x.PopTunnel();if("~ret"==t)return x.PopFunction();if("void"==t)return new R}if("object"===(void 0===e?"undefined":h(e))&&e instanceof Array==0){var a,o=e;if(o["^->"])return a=o["^->"],new k(new n(a.toString()));if(o["^var"]){a=o["^var"];var s=new S(a.toString());return"ci"in o&&(a=o.ci,s.contextIndex=parseInt(a)),s}var u=!1,l=!1,c=E.Function,p=!1;if((a=o["->"])?u=!0:(a=o["f()"])?(u=!0,l=!0,c=E.Function):(a=o["->t->"])?(u=!0,l=!0,c=E.Tunnel):(a=o["x()"])&&(u=!0,p=!0,l=!1,c=E.Function),u){var v=new I;v.pushesToStack=l,v.stackPushType=c,v.isExternal=p;var m=a.toString();return(a=o.var)?v.variableDivertName=m:v.targetPathString=m,v.isConditional=!!o.c,p&&(a=o.exArgs)&&(v.externalArgs=parseInt(a)),v}if(a=o["*"]){var y=new V;return y.pathStringOnChoice=a.toString(),(a=o.flg)&&(y.flags=parseInt(a)),y}if(a=o["VAR?"])return new N(a.toString());if(a=o["CNT?"]){var g=new N;return g.pathStringForCount=a.toString(),g}var C=!1,T=!1;if((a=o["VAR="])?(C=!0,T=!0):(a=o["temp="])&&(C=!0,T=!1),C){var O=a.toString(),P=!o.re,D=new F(O,P);return D.isGlobal=T,D}if(void 0!==o["#"])return a=o["#"],new j(a.toString());if(a=o.list){var G=a,B=new d;if(a=o.origins){B.SetInitialOriginNames(a)}for(var M in G){var H=G[M];B.Add(new f(M),parseInt(H))}return new w(B)}if(null!=o.originalChoicePath)return this.JObjectToChoice(o)}if(e instanceof Array)return this.JArrayToContainer(e);if(null==e)return null;throw"Failed to convert token to runtime object: "+JSON.stringify(e)}},{key:"RuntimeObjectToJToken",value:function(e){var t=e;if(t instanceof T)return this.ContainerToJArray(t);var n=e;if(n instanceof I){var i,r="->";return n.isExternal?r="x()":n.pushesToStack&&(n.stackPushType==E.Function?r="f()":n.stackPushType==E.Tunnel&&(r="->t->")),i=n.hasVariableTarget?n.variableDivertName:n.targetPathString,(h={})[r]=i,n.hasVariableTarget&&(h.var=!0),n.isConditional&&(h.c=!0),n.externalArgs>0&&(h.exArgs=n.externalArgs),h}var a=e;if(a instanceof V)return(h={})["*"]=a.pathStringOnChoice,h.flg=a.flags,h;if(e instanceof y)return e.value;if(e instanceof g)return e.value;var o=e;if(o instanceof b)return o.isNewline?"\n":"^"+o.value;var s=e;if(s instanceof w)return this.InkListToJObject(s);if(e instanceof k)return{"^->":e.value.componentsString};var u=e;if(u instanceof S)return{"^var":u.value,ci:u.contextIndex};if(e instanceof A)return"<>";if(e instanceof x)return W[parseInt(e.commandType)];if(e instanceof L){var l=e.name;return"^"==l&&(l="L^"),l}var c=e;if(c instanceof N){var h={},f=c.pathStringForCount;return null!=f?h["CNT?"]=f:h["VAR?"]=c.name,h}var d=e;if(d instanceof F)return(h={})[d.isGlobal?"VAR=":"temp="]=d.variableName,d.isNewDeclaration||(h.re=!0),h;if(e instanceof R)return"void";if(e instanceof j)return(h={})["#"]=e.text,h;var p=e;if(p instanceof D)return this.ChoiceToJObject(p);throw"Failed to convert runtime object to Json token: "+e}},{key:"ContainerToJArray",value:function(e){var t=this.ListToJArray(e.content),n=e.namedOnlyContent,i=e.countFlags;if(null!=n&&n.length>0||i>0||null!=e.name){var r;if(null!=n)for(var a in r=this.DictionaryRuntimeObjsToJObject(n)){var o=r[a];if(null!=o){var s=o[o.length-1];null!=s&&(delete s["#n"],0==Object.keys(s).length&&(o[o.length-1]=null))}}else r={};i>0&&(r["#f"]=i),null!=e.name&&(r["#n"]=e.name),t.push(r)}else t.push(null);return t}},{key:"JArrayToContainer",value:function(e){var t=new T;t.content=this.JArrayToRuntimeObjList(e,!0);var n=e[e.length-1];if(null!=n){var i={};for(var r in n)if("#f"==r)t.countFlags=parseInt(n[r]);else if("#n"==r)t.name=n[r].toString();else{var a=this.JTokenToRuntimeObject(n[r]);a instanceof T&&(a.name=r),i[r]=a}t.namedOnlyContent=i}return t}},{key:"JObjectToChoice",value:function(e){var t=new D;return t.text=e.text.toString(),t.index=parseInt(e.index),t.sourcePath=e.originalChoicePath.toString(),t.originalThreadIndex=parseInt(e.originalThreadIndex),t.pathStringOnChoice=e.targetPath.toString(),t}},{key:"ChoiceToJObject",value:function(e){var t={};return t.text=e.text,t.index=e.index,t.originalChoicePath=e.sourcePath,t.originalThreadIndex=e.originalThreadIndex,t.targetPath=e.pathStringOnChoice,t}},{key:"InkListToJObject",value:function(e){var t=e.value,n={},i={};return t.forEach(function(e){var t=e.Key,n=e.Value;i[t.toString()]=n}),n.list=i,0==t.Count&&null!=t.originNames&&t.originNames.length>0&&(n.origins=t.originNames),n}},{key:"ListDefinitionsToJToken",value:function(e){var t={};return e.lists.forEach(function(e){var n={};e.items.forEach(function(e){n[e.Key.itemName]=e.Value}),t[e.name]=n}),t}},{key:"JTokenToListDefinitions",value:function(e){var t=e,n=[];for(var i in t){var r=i.toString(),a=t[i],o={};for(var s in a){var u=a[s];o[s]=parseInt(u)}n.push(new G(r,o))}return new B(n)}}]),e}(),W=[];W[x.CommandType.EvalStart]="ev",W[x.CommandType.EvalOutput]="out",W[x.CommandType.EvalEnd]="/ev",W[x.CommandType.Duplicate]="du",W[x.CommandType.PopEvaluatedValue]="pop",W[x.CommandType.PopFunction]="~ret",W[x.CommandType.PopTunnel]="->->",W[x.CommandType.BeginString]="str",W[x.CommandType.EndString]="/str",W[x.CommandType.NoOp]="nop",W[x.CommandType.ChoiceCount]="choiceCnt",W[x.CommandType.TurnsSince]="turns",W[x.CommandType.ReadCount]="readc",W[x.CommandType.Random]="rnd",W[x.CommandType.SeedRandom]="srnd",W[x.CommandType.VisitIndex]="visit",W[x.CommandType.SequenceShuffleIndex]="seq",W[x.CommandType.StartThread]="thread",W[x.CommandType.Done]="done",W[x.CommandType.End]="end",W[x.CommandType.ListFromInt]="listInt",W[x.CommandType.ListRange]="range";for(var H=0;H<x.CommandType.TOTAL_VALUES;++H)if(null==W[H])throw"Control command not accounted for in serialisation";var q=function(){function e(t,n,i){o(this,e),this.currentPointer=n.copy(),this.inExpressionEvaluation=i||!1,this.temporaryVariables={},this.type=t,this.evaluationStackHeightWhenPushed=0,this.functionStartInOuputStream=0}return c(e,[{key:"Copy",value:function(){var n=new e(this.type,this.currentPointer,this.inExpressionEvaluation);return t(n.temporaryVariables,this.temporaryVariables),n.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,n.functionStartInOuputStream=this.functionStartInOuputStream,n}}]),e}(),J=function(){function e(t,i){var r=this;if(o(this,e),this.callstack=[],this.threadIndex=0,this.previousPointer=P.Null,t&&i){var a=t;this.threadIndex=parseInt(a.threadIndex),a.callstack.forEach(function(e){var t=e,a=parseInt(t.type),o=P.Null,s=null,u=t.cPath;if(void 0!==u){s=u.toString();var l=i.ContentAtPath(new n(s));if(o.container=l.container,o.index=parseInt(t.idx),null==l.obj)throw"When loading state, internal story location couldn't be found: "+s+". Has the story changed since this save data was created?";l.approximate&&i.Warning("When loading state, exact internal story location couldn't be found: '"+s+"', so it was approximated to '"+o.container.path.toString()+"' to recover. Has the story changed since this save data was created?")}var c=!!t.exp,h=new q(a,o,c);h.temporaryVariables=M.JObjectToDictionaryRuntimeObjs(t.temp),r.callstack.push(h)});var s=a.previousContentObject;if(void 0!==s){var u=new n(s.toString());this.previousPointer=i.PointerAtPath(u)}}}return c(e,[{key:"Copy",value:function(){var t=new e;return t.threadIndex=this.threadIndex,this.callstack.forEach(function(e){t.callstack.push(e.Copy())}),t.previousPointer=this.previousPointer.copy(),t}},{key:"jsonToken",get:function(){var e={},t=[];return this.callstack.forEach(function(e){var n={};e.currentPointer.isNull||(n.cPath=e.currentPointer.container.path.componentsString,n.idx=e.currentPointer.index),n.exp=e.inExpressionEvaluation,n.type=parseInt(e.type),n.temp=M.DictionaryRuntimeObjsToJObject(e.temporaryVariables),t.push(n)}),e.callstack=t,e.threadIndex=this.threadIndex,this.previousPointer.isNull||(e.previousContentObject=this.previousPointer.Resolve().path.toString()),e}}]),e}(),$=function(){function e(t){var n=this;o(this,e),this._threads=[],this._threadCounter=0,this._threads.push(new J),t instanceof e?(this._threads=[],t._threads.forEach(function(e){n._threads.push(e.Copy())})):this._threads[0].callstack.push(new q(E.Tunnel,P.StartOf(t)))}return c(e,[{key:"CanPop",value:function(e){return!!this.canPop&&(null==e||this.currentElement.type==e)}},{key:"Pop",value:function(e){if(!this.CanPop(e))throw"Mismatched push/pop in Callstack";this.callStack.pop()}},{key:"Push",value:function(e,t,n){t=void 0!==t?t:0,n=void 0!==n?n:0;var i=new q(e,this.currentElement.currentPointer,!1);i.evaluationStackHeightWhenPushed=t,i.functionStartInOuputStream=n,this.callStack.push(i)}},{key:"PushThread",value:function(){var e=this.currentThread.Copy();this._threadCounter++,e.threadIndex=this._threadCounter,this._threads.push(e)}},{key:"PopThread",value:function(){if(!this.canPopThread)throw"Can't pop thread";this._threads.splice(this._threads.indexOf(this.currentThread),1)}},{key:"SetJsonToken",value:function(e,t){var n=this;this._threads.length=0;var i=e;i.threads.forEach(function(e){var i=new J(e,t);n._threads.push(i)}),this._threadCounter=parseInt(i.threadCounter)}},{key:"GetJsonToken",value:function(){var e={},t=[];return this._threads.forEach(function(e){t.push(e.jsonToken)}),e.threads=t,e.threadCounter=this._threadCounter,e}},{key:"GetTemporaryVariableWithName",value:function(e,t){-1==(t=void 0===t?-1:t)&&(t=this.currentElementIndex+1);var n;return(n=this.callStack[t-1].temporaryVariables[e])?n:null}},{key:"SetTemporaryVariable",value:function(e,t,n,i){-1==(i=void 0===i?-1:i)&&(i=this.currentElementIndex+1);var r,a=this.callStack[i-1];if(!n&&!a.temporaryVariables[e])throw new p("Could not find temporary variable to set: "+e);(r=a.temporaryVariables[e])&&w.RetainListOriginsForAssignment(r,t),a.temporaryVariables[e]=t}},{key:"ContextForVariableNamed",value:function(e){return this.currentElement.temporaryVariables[e]?this.currentElementIndex+1:0}},{key:"ThreadWithIndex",value:function(e){return this._threads.filter(function(t){if(t.threadIndex==e)return t})[0]}},{key:"currentThread",get:function(){return this._threads[this._threads.length-1]},set:function(e){1!=this._threads.length&&console.warn("Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(e)}},{key:"callStack",get:function(){return this.currentThread.callstack}},{key:"callStackTrace",get:function(){for(var e=new l,t=0;t<this._threads.length;t++){var n=this._threads[t];e.AppendFormat("=== THREAD {0}/{1} {2}===\n",t+1,this._threads.length,t==this._threads.length-1?"(current) ":"");for(var i=0;i<n.callstack.length;i++){e.Append(n.callstack[i].type==E.Function?"  [FUNCTION] ":"  [TUNNEL] ");var r=n.callstack[i].currentPointer;r.isNull||(e.Append("<SOMEWHERE IN "),e.Append(r.container.path.toString()),e.AppendLine(">"))}}return e.toString()}},{key:"elements",get:function(){return this.callStack}},{key:"depth",get:function(){return this.elements.length}},{key:"currentElement",get:function(){var e=this._threads[this._threads.length-1].callstack;return e[e.length-1]}},{key:"currentElementIndex",get:function(){return this.callStack.length-1}},{key:"canPop",get:function(){return this.callStack.length>1}},{key:"canPopThread",get:function(){return this._threads.length>1&&!this.elementIsEvaluateFromGame}},{key:"elementIsEvaluateFromGame",get:function(){return this.currentElement.type==E.FunctionEvaluationFromGame}}]),e}(),K=function(){function e(t,n){o(this,e),this._globalVariables={},this._defaultGlobalVariables={},this._callStack=t,this._listDefsOrigin=n,this._batchObservingVariableChanges=null,this._changedVariables=null,this.variableChangedEvent=null,this.variableChangedEventCallbacks=[];try{return new Proxy(this,{get:function(e,t){return t in e?e[t]:e.$(t)},set:function(e,t,n){return t in e?e[t]=n:e.$(t,n),!0}})}catch(e){}}return c(e,[{key:"ObserveVariableChange",value:function(e){var t=this;null==this.variableChangedEvent&&(this.variableChangedEvent=function(e,n){t.variableChangedEventCallbacks.forEach(function(t){t(e,n)})}),this.variableChangedEventCallbacks.push(e)}},{key:"CopyFrom",value:function(e){this._globalVariables=t({},e._globalVariables),this._defaultGlobalVariables=t({},e._defaultGlobalVariables),this.variableChangedEvent=e.variableChangedEvent,e.batchObservingVariableChanges!=this.batchObservingVariableChanges&&(e.batchObservingVariableChanges?(this._batchObservingVariableChanges=!0,this._changedVariables=e._changedVariables):(this._batchObservingVariableChanges=!1,this._changedVariables=null))}},{key:"GlobalVariableExistsWithName",value:function(e){return void 0!==this._globalVariables[e]}},{key:"GetVariableWithName",value:function(e,t){void 0===t&&(t=-1);var n=this.GetRawVariableWithName(e,t),i=n;return i instanceof S&&(n=this.ValueAtVariablePointer(i)),n}},{key:"TryGetDefaultVariableValue",value:function(e){var t=_defaultGlobalVariables[e];return void 0===t&&(t=null),t}},{key:"GetRawVariableWithName",value:function(e,t){var n=null;if(0==t||-1==t){if(n=this._globalVariables[e])return n;var i=this._listDefsOrigin.FindSingleItemListWithName(e);if(i)return i}return n=this._callStack.GetTemporaryVariableWithName(e,t)}},{key:"ValueAtVariablePointer",value:function(e){return this.GetVariableWithName(e.variableName,e.contextIndex)}},{key:"Assign",value:function(e,t){var n=e.variableName,i=-1,r=!1;if(r=e.isNewDeclaration?e.isGlobal:!!this._globalVariables[n],e.isNewDeclaration){var a=t;a instanceof S&&(t=this.ResolveVariablePointer(a))}else{var o=null;do{(o=this.GetRawVariableWithName(n,i))instanceof S&&(n=o.variableName,r=0==(i=o.contextIndex))}while(o instanceof S)}r?this.SetGlobal(n,t):this._callStack.SetTemporaryVariable(n,t,e.isNewDeclaration,i)}},{key:"SnapshotDefaultGlobals",value:function(){this._defaultGlobalVariables=t({},this._globalVariables)}},{key:"RetainListOriginsForAssignment",value:function(e,t){var n=e,i=t;n instanceof w&&i instanceof w&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames)}},{key:"SetGlobal",value:function(e,t){var n;n=this._globalVariables[e],w.RetainListOriginsForAssignment(n,t),this._globalVariables[e]=t,null!=this.variableChangedEvent&&t!==n&&(this.batchObservingVariableChanges?this._changedVariables.push(e):this.variableChangedEvent(e,t))}},{key:"ResolveVariablePointer",value:function(e){var t=e.contextIndex;-1==t&&(t=this.GetContextIndexOfVariableNamed(e.variableName));var n=this.GetRawVariableWithName(e.variableName,t);return n instanceof S?n:new S(e.variableName,t)}},{key:"GetContextIndexOfVariableNamed",value:function(e){return this._globalVariables[e]?0:this._callStack.currentElementIndex}},{key:"$",value:function(e,t){if(void 0===t){var n=this._globalVariables[e];return void 0===n&&(n=this._defaultGlobalVariables[e]),void 0!==n?n.valueObject:null}if(void 0===this._defaultGlobalVariables[e])throw new p("Cannot assign to a variable that hasn't been declared in the story");var i=_.Create(t);if(null==i)throw new p(null==t?"Cannot pass null to VariableState":"Invalid value passed to VariableState: "+t.toString());this.SetGlobal(e,i)}},{key:"callStack",get:function(){return this._callStack},set:function(e){this._callStack=e}},{key:"batchObservingVariableChanges",get:function(){return this._batchObservingVariableChanges},set:function(e){var t=this;e=!!e,this._batchObservingVariableChanges=e,e?this._changedVariables=[]:(null!=this._changedVariables&&this._changedVariables.forEach(function(e){t.variableChangedEvent(e,t._globalVariables[e])}),this._changedVariables=null)}},{key:"jsonToken",get:function(){return M.DictionaryRuntimeObjsToJObject(this._globalVariables)},set:function(e){this._globalVariables=M.JObjectToDictionaryRuntimeObjs(e)}}]),e}(),U=function(){function e(t){o(this,e),(this._seed=t%2147483647)<=0&&(this._seed+=2147483646)}return c(e,[{key:"next",value:function(){return this._seed=16807*this._seed%2147483647}},{key:"nextFloat",value:function(){return(this.next()-1)/2147483646}}]),e}(),Y=function(){function e(t){o(this,e),this.story=t,this._outputStream=[],this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this.OutputStreamDirty(),this._evaluationStack=[],this.callStack=new $(t.rootContentContainer),this._variablesState=new K(this.callStack,t.listDefinitions),this._visitCounts={},this._turnIndices={},this._currentTurnIndex=-1,this.divertedPointer=P.Null;var n=(new Date).getTime();this.storySeed=new U(n).next()%100,this.previousRandom=0,this._currentChoices=[],this._currentText=null,this._currentTags=null,this._currentErrors=null,this._currentWarnings=null,this.didSafeExit=!1,this.GoToStart()}return c(e,[{key:"CleanOutputWhitespace",value:function(e){for(var t=new l,n=-1,i=0;i<e.length;i++){var r=e.charAt(i),a=" "==r||"\t"==r;a&&-1==n&&(n=i),a||("\n"!=r&&n>0&&t.Append(e.substr(n,i-n)),n=-1),a||t.Append(r)}return t.toString()}},{key:"GoToStart",value:function(){this.callStack.currentElement.currentPointer=P.StartOf(this.story.mainContentContainer)}},{key:"ResetErrors",value:function(){this._currentErrors=null,this._currentWarnings=null}},{key:"ResetOutput",value:function(e){e=void 0!==e?e:null,this._outputStream.length=0,null!=e&&this._outputStream.push.apply(this._outputStream,e),this.OutputStreamDirty()}},{key:"PushEvaluationStack",value:function(e){var t=this;if(e instanceof w){var n=e.value;null!=n.originNames&&(n.origins||(n.origins=[]),n.origins.length=0,n.originNames.forEach(function(e){var i=null;i=t.story.listDefinitions.TryListGetDefinition(e,i),n.origins.indexOf(i)<0&&n.origins.push(i)}))}this.evaluationStack.push(e)}},{key:"PopEvaluationStack",value:function(e){if(e){if(e>this.evaluationStack.length)throw"trying to pop too many objects";return this.evaluationStack.splice(this.evaluationStack.length-e,e)}return this.evaluationStack.pop()}},{key:"PeekEvaluationStack",value:function(){return this.evaluationStack[this.evaluationStack.length-1]}},{key:"PushToOutputStream",value:function(e){var t=this,n=e;if(n instanceof b){var i=this.TrySplittingHeadTailWhitespace(n);if(null!=i)return i.forEach(function(e){t.PushToOutputStreamIndividual(e)}),void this.OutputStreamDirty()}this.PushToOutputStreamIndividual(e),this.OutputStreamDirty()}},{key:"PopFromOutputStream",value:function(e){this.outputStream.splice(this.outputStream.length-e,e),this.OutputStreamDirty()}},{key:"TrySplittingHeadTailWhitespace",value:function(e){for(var t=e.value,n=-1,i=-1,r=0;r<t.length;++r){if("\n"!=(s=t[r])){if(" "==s||"\t"==s)continue;break}-1==n&&(n=r),i=r}var a=-1,o=-1;for(r=0;r<t.length;++r){var s;if("\n"!=(s=t[r])){if(" "==s||"\t"==s)continue;break}-1==a&&(a=r),o=r}if(-1==n&&-1==a)return null;var u=[],l=0,c=t.length;if(-1!=n){if(n>0){u.push(t.substring(0,n))}u.push(new b("\n")),l=i+1}if(-1!=a&&(c=o),c>l){var h=t.substring(l,c-l);u.push(new b(h))}if(-1!=a&&o>i&&(u.push(new b("\n")),a<t.length-1)){u.push(new b(t.substring(a+1,t.length-a-1)))}return u}},{key:"PushToOutputStreamIndividual",value:function(e){var t=e,n=!0;if(e instanceof A)this.TrimNewlinesFromOutputStream(),n=!0;else if(t instanceof b){var i=-1,r=this.callStack.currentElement;r.type==E.Function&&(i=r.functionStartInOutputStream);for(var a=-1,o=this._outputStream.length-1;o>=0;o--){var s=this._outputStream[o],u=s instanceof x?s:null;if(null!=(s instanceof A?s:null)){a=o;break}if(null!=u&&u.commandType==x.CommandType.BeginString){o>=i&&(i=-1);break}}if(-1!=(-1!=a&&-1!=i?Math.min(i,a):-1!=a?a:i)){if(t.isNewline)n=!1;else if(t.isNonWhitespace&&(a>-1&&this.RemoveExistingGlue(),i>-1)){var l=this.callStack.elements;for(o=l.length-1;o>=0;o--){var c=l[o];if(c.type!=E.Function)break;c.functionStartInOutputStream=-1}}}else t.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(n=!1))}n&&(this._outputStream.push(e),this.OutputStreamDirty())}},{key:"TrimNewlinesFromOutputStream",value:function(){for(var e=-1,t=this._outputStream.length-1;t>=0;){var n=this._outputStream[t],i=n instanceof b?n:null;if(null!=(n instanceof x?n:null)||null!=i&&i.isNonWhitespace)break;null!=i&&i.isNewline&&(e=t),t--}if(e>=0)for(t=e;t<this._outputStream.length;)this._outputStream[t]instanceof b?this._outputStream.splice(t,1):t++;this.OutputStreamDirty()}},{key:"RemoveExistingGlue",value:function(){for(var e=this._outputStream.length-1;e>=0;e--){var t=this._outputStream[e];if(t instanceof A)this._outputStream.splice(e,1);else if(t instanceof x)break}this.OutputStreamDirty()}},{key:"ForceEnd",value:function(){for(;this.callStack.canPopThread;)this.callStack.PopThread();for(;this.callStack.canPop;)this.PopCallStack();this._currentChoices.length=0,this.currentPointer=P.Null,this.previousPointer=P.Null,this.didSafeExit=!0}},{key:"TrimWhitespaceFromFunctionEnd",value:function(){var e=this.callStack.currentElement.functionStartInOutputStream;-1==e&&(e=0);for(var t=this._outputStream.length-1;t>=e;t--){var n=this._outputStream[t],i=n instanceof b?n:null;if(null!=i){if(n instanceof x?n:null)break;if(!i.isNewline&&!i.isInlineWhitespace)break;this._outputStream.splice(t,1),this.OutputStreamDirty()}}}},{key:"PopCallStack",value:function(e){e=void 0!==e?e:null,this.callStack.currentElement.type==E.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(e)}},{key:"SetChosenPath",value:function(e){this._currentChoices.length=0;var t=this.story.PointerAtPath(e);t.isNull||-1!=t.index||(t.index=0),this.currentPointer=t,this._currentTurnIndex++}},{key:"StartFunctionEvaluationFromGame",value:function(e,t){this.callStack.Push(E.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=P.StartOf(e),this.PassArgumentsToEvaluationStack(t)}},{key:"PassArgumentsToEvaluationStack",value:function(e){if(null!=e)for(var t=0;t<e.length;t++){if("number"!=typeof e[t]&&"string"!=typeof e[t])throw"ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters  must be int, float or string";this.PushEvaluationStack(_.Create(e[t]))}}},{key:"TryExitFunctionEvaluationFromGame",value:function(){return this.callStack.currentElement.type==E.FunctionEvaluationFromGame&&(this.currentPointer=P.Null,this.didSafeExit=!0,!0)}},{key:"CompleteFunctionEvaluationFromGame",value:function(){if(this.callStack.currentElement.type!=E.FunctionEvaluationFromGame)throw new p("Expected external function evaluation to be complete. Stack trace: "+callStack.callStackTrace);for(var e=this.callStack.currentElement.evaluationStackHeightWhenPushed,t=null;this.evaluationStack.length>e;){var n=this.PopEvaluationStack();null==t&&(t=n)}if(this.PopCallStack(E.FunctionEvaluationFromGame),t){if(t instanceof R)return null;var i=t;return i.valueType==v.DivertTarget?i.valueObject.toString():i.valueObject}return null}},{key:"AddError",value:function(e,t){t?(null==this._currentWarnings&&(this._currentWarnings=[]),this._currentWarnings.push(e)):(null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(e))}},{key:"OutputStreamDirty",value:function(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}},{key:"VisitCountAtPathString",value:function(e){var t;return(t=this.visitCounts[e])?t:0}},{key:"Copy",value:function(){var t=new e(this.story);for(var n in t.outputStream.push.apply(t.outputStream,this._outputStream),this.OutputStreamDirty(),t._currentChoices.push.apply(t._currentChoices,this._currentChoices),this.hasError&&(t._currentErrors=[],t._currentErrors.push.apply(t._currentErrors,this.currentErrors)),this.hasWarning&&(t._currentWarnings=[],t._currentWarnings.push.apply(t._currentWarnings,this.currentWarnings)),t.callStack=new $(this.callStack),t._variablesState=new K(t.callStack,this.story.listDefinitions),t.variablesState.CopyFrom(this.variablesState),t.evaluationStack.push.apply(t.evaluationStack,this.evaluationStack),this.divertedPointer.isNull||(t.divertedPointer=this.divertedPointer.copy()),t.previousPointer=this.previousPointer.copy(),t._visitCounts={},this._visitCounts)t._visitCounts[n]=this._visitCounts[n];for(var n in t._turnIndices={},this._turnIndices)t._turnIndices[n]=this._turnIndices[n];return t._currentTurnIndex=this.currentTurnIndex,t.storySeed=this.storySeed,t.previousRandom=this.previousRandom,t.didSafeExit=this.didSafeExit,t}},{key:"ToJson",value:function(e){return JSON.stringify(this.jsonToken,null,e?2:0)}},{key:"toJson",value:function(e){return this.ToJson(e)}},{key:"LoadJson",value:function(e){this.jsonToken=JSON.parse(e)}},{key:"currentChoices",get:function(){return this.canContinue?[]:this._currentChoices}},{key:"generatedChoices",get:function(){return this._currentChoices}},{key:"currentErrors",get:function(){return this._currentErrors}},{key:"currentWarnings",get:function(){return this._currentWarnings}},{key:"visitCounts",get:function(){return this._visitCounts}},{key:"turnIndices",get:function(){return this._turnIndices}},{key:"currentTurnIndex",get:function(){return this._currentTurnIndex}},{key:"variablesState",get:function(){return this._variablesState}},{key:"currentContentObject",get:function(){return this.callStack.currentElement.currentObject},set:function(e){this.callStack.currentElement.currentObject=e}},{key:"canContinue",get:function(){return!this.currentPointer.isNull&&!this.hasError}},{key:"hasError",get:function(){return null!=this.currentErrors&&this.currentErrors.length>0}},{key:"hasWarning",get:function(){return null!=this.currentWarnings&&this.currentWarnings.length>0}},{key:"inExpressionEvaluation",get:function(){return this.callStack.currentElement.inExpressionEvaluation},set:function(e){this.callStack.currentElement.inExpressionEvaluation=e}},{key:"evaluationStack",get:function(){return this._evaluationStack}},{key:"outputStreamEndsInNewline",get:function(){if(this._outputStream.length>0)for(var e=this._outputStream.length-1;e>=0&&!(this._outputStream[e]instanceof x);e--){var t=this._outputStream[e];if(t instanceof b){if(t.isNewline)return!0;if(t.isNonWhitespace)break}}return!1}},{key:"outputStreamContainsContent",get:function(){for(var e=0;e<this._outputStream.length;e++)if(this._outputStream[e]instanceof b)return!0;return!1}},{key:"inStringEvaluation",get:function(){for(var e=this._outputStream.length-1;e>=0;e--){var t=this._outputStream[e];if(t instanceof x&&t.commandType==x.CommandType.BeginString)return!0}return!1}},{key:"currentText",get:function(){if(this._outputStreamTextDirty){var e=new l;this._outputStream.forEach(function(t){var n=t;n instanceof b&&e.Append(n.value)}),this._currentText=this.CleanOutputWhitespace(e.toString()),this._outputStreamTextDirty=!1}return this._currentText}},{key:"currentTags",get:function(){var e=this;return this._outputStreamTagsDirty&&(this._currentTags=[],this._outputStream.forEach(function(t){var n=t;n instanceof j&&e._currentTags.push(n.text)}),this._outputStreamTagsDirty=!1),this._currentTags}},{key:"outputStream",get:function(){return this._outputStream}},{key:"currentPathString",get:function(){var e=this.currentPointer;return e.isNull?null:e.path.toString()}},{key:"currentPointer",get:function(){return this.callStack.currentElement.currentPointer.copy()},set:function(e){this.callStack.currentElement.currentPointer=e.copy()}},{key:"previousPointer",get:function(){return this.callStack.currentThread.previousPointer.copy()},set:function(e){this.callStack.currentThread.previousPointer=e.copy()}},{key:"callstackDepth",get:function(){return this.callStack.depth}},{key:"jsonToken",get:function(){var t=this,n={},i=null;return this._currentChoices.forEach(function(e){e.originalThreadIndex=e.threadAtGeneration.threadIndex,null==t.callStack.ThreadWithIndex(e.originalThreadIndex)&&(null==i&&(i={}),i[e.originalThreadIndex.toString()]=e.threadAtGeneration.jsonToken)}),null!=this.choiceThreads&&(n.choiceThreads=this.choiceThreads),n.callstackThreads=this.callStack.GetJsonToken(),n.variablesState=this.variablesState.jsonToken,n.evalStack=M.ListToJArray(this.evaluationStack),n.outputStream=M.ListToJArray(this._outputStream),n.currentChoices=M.ListToJArray(this._currentChoices),this.divertedPointer.isNull||(n.currentDivertTarget=this.divertedPointer.path.componentsString),n.visitCounts=M.IntDictionaryToJObject(this.visitCounts),n.turnIndices=M.IntDictionaryToJObject(this.turnIndices),n.turnIdx=this.currentTurnIndex,n.storySeed=this.storySeed,n.inkSaveVersion=e.kInkSaveStateVersion,n.inkFormatVersion=this.story.inkVersionCurrent,n},set:function(t){var i=this,r=t,a=r.inkSaveVersion;if(null==a)throw new p("ink save format incorrect, can't load.");if(parseInt(a)<e.kMinCompatibleLoadVersion)throw new p("Ink save format isn't compatible with the current version (saw '"+a+"', but minimum is "+e.kMinCompatibleLoadVersion+"), so can't load.");this.callStack.SetJsonToken(r.callstackThreads,this.story),this.variablesState.jsonToken=r.variablesState,this._evaluationStack=M.JArrayToRuntimeObjList(r.evalStack),this._outputStream=M.JArrayToRuntimeObjList(r.outputStream),this.OutputStreamDirty(),this._currentChoices=M.JArrayToRuntimeObjList(r.currentChoices);var o=r.currentDivertTarget;if(null!=o){this.divertedPointer=this.story.PointerAtPath(new n(o.toString()))}this._visitCounts=M.JObjectToIntDictionary(r.visitCounts),this._turnIndices=M.JObjectToIntDictionary(r.turnIndices),this._currentTurnIndex=parseInt(r.turnIdx),this.storySeed=parseInt(r.storySeed);var s=r.choiceThreads;this._currentChoices.forEach(function(e){var t=i.callStack.ThreadWithIndex(e.originalThreadIndex);if(null!=t)e.threadAtGeneration=t;else{var n=s[e.originalThreadIndex.toString()];e.threadAtGeneration=new $.Thread(n,i.story)}})}}]),e}();Y.kInkSaveStateVersion=8,Y.kMinCompatibleLoadVersion=8;var z=function(){function e(){o(this,e)}return c(e,[{key:"Start",value:function(){this.startTime=(new Date).getTime()}},{key:"Stop",value:function(){this.startTime=void 0}},{key:"ElapsedMilliseconds",get:function(){return(new Date).getTime()-this.startTime}}]),e}();Number.isInteger||(Number.isInteger=function(e){return"number"==typeof e&&isFinite(e)&&e>-9007199254740992&&e<9007199254740992&&Math.floor(e)===e});var X=function(){function e(t,n){o(this,e);var i=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));if(n=n||null,i.inkVersionCurrent=18,i.inkVersionMinimumCompatible=18,i._variableObservers=null,i._externals={},i._prevContainers=[],i._listDefinitions=null,i._stateAtLastNewline=null,i._recursiveContinueCount=0,i._temporaryEvaluationContainer=null,i._profiler=null,t instanceof T)i._mainContentContainer=t,null!=n&&(i._listDefinitions=new B(n));else{var a="string"==typeof t?JSON.parse(t):t,s=a.inkVersion;if(null==s)throw"ink version number not found. Are you sure it's a valid .ink.json file?";var u=parseInt(s);if(u>i.inkVersionCurrent)throw"Version of ink used to build story was newer than the current version of the engine";if(u<i.inkVersionMinimumCompatible)throw"Version of ink used to build story is too old to be loaded by this version of the engine";u!=i.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");var l,c=a.root;if(null==c)throw"Root node for ink not found. Are you sure it's a valid .ink.json file?";(l=a.listDefs)&&(i._listDefinitions=M.JTokenToListDefinitions(l)),i._mainContentContainer=M.JTokenToRuntimeObject(c),i._hasValidatedExternals=null,i.allowExternalFunctionFallbacks=!1,i.ResetState()}return i}return a(e,u),c(e,[{key:"StartProfiling",value:function(){}},{key:"EndProfiling",value:function(){}},{key:"ToJsonString",value:function(){var e=M.RuntimeObjectToJToken(this._mainContentContainer),t={};return t.inkVersion=this.inkVersionCurrent,t.root=e,null!=this._listDefinitions&&(t.listDefs=M.ListDefinitionsToJToken(this._listDefinitions)),JSON.stringify(t)}},{key:"ResetState",value:function(){this.IfAsyncWeCant("ResetState"),this._state=new Y(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}},{key:"ResetErrors",value:function(){this._state.ResetErrors()}},{key:"ResetCallstack",value:function(){this.IfAsyncWeCant("ResetCallstack"),this._state.ForceEnd()}},{key:"ResetGlobals",value:function(){if(this._mainContentContainer.namedContent["global decl"]){var e=this.state.currentPointer.copy();this.ChoosePathString("global decl",!1),this.ContinueInternal(),this.state.currentPointer=e}this.state.variablesState.SnapshotDefaultGlobals()}},{key:"Continue",value:function(){return this.ContinueAsync(0),this.currentText}},{key:"ContinueAsync",value:function(e){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(e)}},{key:"ContinueInternal",value:function(e){e=void 0!==e?e:0,null!=this._profiler&&this._profiler.PreContinue();var t=e>0;if(this._recursiveContinueCount++,!this._asyncContinueActive){if(this._asyncContinueActive=t,!this.canContinue)throw new p("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!0)}var n=new z;n.Start();var i=!1;do{try{i=this.ContinueSingleStep()}catch(e){if(!(e instanceof p))throw e;this.AddError(e.Message,void 0,e.useEndLineNumber);break}if(i)break;if(this._asyncContinueActive&&n.ElapsedMilliseconds>e)break}while(this.canContinue);n.Stop(),!i&&this.canContinue||(null!=this._stateAtLastNewline&&(this.RestoreStateSnapshot(this._stateAtLastNewline),this._stateAtLastNewline=null),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||this.AddError(this.state.callStack.CanPop(E.Tunnel)?"unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?":this.state.callStack.CanPop(E.Function)?"unexpectedly reached end of content. Do you need a '~ return'?":this.state.callStack.canPop?"unexpectedly reached end of content for unknown reason. Please debug compiler!":"ran out of content. Do you need a '-> DONE' or '-> END'?")),this.state.didSafeExit=!1,1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!1),this._asyncContinueActive=!1),this._recursiveContinueCount--,null!=this._profiler&&this._profiler.PostContinue()}},{key:"ContinueSingleStep",value:function(){if(null!=this._profiler&&this._profiler.PreStep(),this.Step(),null!=this._profiler&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),null!=this._profiler&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(null!=this._stateAtLastNewline){var e=this.CalculateNewlineOutputStateChange(this._stateAtLastNewline.currentText,this.state.currentText,this._stateAtLastNewline.currentTags.length,this.state.currentTags.length);if(e==Z.ExtendedBeyondNewline)return this.RestoreStateSnapshot(this._stateAtLastNewline),!0;e==Z.NewlineRemoved&&(this._stateAtLastNewline=null)}this.state.outputStreamEndsInNewline&&(this.canContinue?null==this._stateAtLastNewline&&(this._stateAtLastNewline=this.StateSnapshot()):this._stateAtLastNewline=null)}return null!=this._profiler&&this._profiler.PostSnapshot(),!1}},{key:"CalculateNewlineOutputStateChange",value:function(e,t,n,i){var r=t.length>=e.length&&"\n"==t.charAt(e.length-1);if(n==i&&e.length==t.length&&r)return Z.NoChange;if(!r)return Z.NewlineRemoved;if(i>n)return Z.ExtendedBeyondNewline;for(var a=e.length;a<t.length;a++){var o=t.charAt(a);if(" "!=o&&"\t"!=o)return Z.ExtendedBeyondNewline}return Z.NoChange}},{key:"ContinueMaximally",value:function(){this.IfAsyncWeCant("ContinueMaximally");for(var e=new l;this.canContinue;)e.Append(this.Continue());return e.toString()}},{key:"ContentAtPath",value:function(e){return this.mainContentContainer.ContentAtPath(e)}},{key:"KnotContainerWithName",value:function(e){var t=this.mainContentContainer.namedContent[e];return t instanceof T?t:null}},{key:"PointerAtPath",value:function(e){if(0==e.length)return P.Null;var t=new P,n=e.length,i=null;return e.lastComponent.isIndex?(n=e.length-1,i=this.mainContentContainer.ContentAtPath(e,void 0,n),t.container=i.container,t.index=e.lastComponent.index):(i=this.mainContentContainer.ContentAtPath(e),t.container=i.container,t.index=-1),null==i.obj||i.obj==this.mainContentContainer&&n>0?this.Error("Failed to find content at path '"+e+"', and no approximation of it was possible."):i.approximate&&this.Warning("Failed to find content at path '"+e+"', so it was approximated to: '"+i.obj.path+"'."),t}},{key:"StateSnapshot",value:function(){return this.state.Copy()}},{key:"RestoreStateSnapshot",value:function(e){this._state=e}},{key:"Step",value:function(){var e=!0,t=this.state.currentPointer.copy();if(!t.isNull){for(var n=t.Resolve();n instanceof T&&(this.VisitContainer(n,!0),0!=n.content.length);)n=(t=P.StartOf(n)).Resolve();this.state.currentPointer=t.copy(),null!=this._profiler&&this._profiler.Step(state.callStack);var i=t.Resolve(),r=this.PerformLogicAndFlowControl(i);if(!this.state.currentPointer.isNull){r&&(e=!1);var a=i;if(a instanceof V){var o=this.ProcessChoice(a);o&&this.state.generatedChoices.push(o),i=null,e=!1}if(i instanceof T&&(e=!1),e){var s=i;if(s instanceof S&&-1==s.contextIndex){var u=this.state.callStack.ContextForVariableNamed(s.variableName);i=new S(s.variableName,u)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(i):this.state.PushToOutputStream(i)}this.NextContent(),i instanceof x&&i.commandType==x.CommandType.StartThread&&this.state.callStack.PushThread()}}}},{key:"VisitContainer",value:function(e,t){e.countingAtStartOnly&&!t||(e.visitsShouldBeCounted&&this.IncrementVisitCountForContainer(e),e.turnIndexShouldBeCounted&&this.RecordTurnIndexVisitToContainer(e))}},{key:"VisitChangedContainersDueToDivert",value:function(){var e=this.state.previousPointer.copy(),t=this.state.currentPointer.copy();if(!t.isNull&&-1!=t.index){if(this._prevContainers.length=0,!e.isNull)for(var n=e.Resolve(),i=n instanceof T?n:e.container;i instanceof T;)this._prevContainers.push(i),i=i.parent;var r=t.Resolve();if(null!=r)for(var a=r.parent;a instanceof T&&this._prevContainers.indexOf(a)<0;){var o=a.content.length>0&&r==a.content[0];this.VisitContainer(a,o),r=a,a=a.parent}}}},{key:"ProcessChoice",value:function(e){var t=!0;if(e.hasCondition){this.IsTruthy(this.state.PopEvaluationStack())||(t=!1)}var n="",i="";if(e.hasChoiceOnlyContent&&(i=this.state.PopEvaluationStack().value),e.hasStartContent&&(n=this.state.PopEvaluationStack().value),e.onceOnly&&this.VisitCountForContainer(e.choiceTarget)>0&&(t=!1),!t)return null;var r=new D;return r.targetPath=e.pathOnChoice,r.sourcePath=e.path.toString(),r.isInvisibleDefault=e.isInvisibleDefault,r.threadAtGeneration=this.state.callStack.currentThread.Copy(),r.text=(n+i).replace(/^[ \t]+|[ \t]+$/g,""),r}},{key:"IsTruthy",value:function(e){if(e instanceof _){var t=e;if(t instanceof k){return this.Error("Shouldn't use a divert target (to "+t.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return t.isTruthy}return!1}},{key:"PerformLogicAndFlowControl",value:function(e){if(null==e)return!1;if(e instanceof I){var t=e;if(t.isConditional){if(!this.IsTruthy(this.state.PopEvaluationStack()))return!0}if(t.hasVariableTarget){var n=t.variableDivertName,i=this.state.variablesState.GetVariableWithName(n);if(null==i)this.Error("Tried to divert using a target from a variable that could not be found ("+n+")");else if(!(i instanceof k)){var r="Tried to divert to a target from a variable, but the variable ("+n+") didn't contain a divert target, it ";r+=i instanceof y&&0==i.value?"was empty/null (the value 0).":"contained '"+i+"'.",this.Error(r)}var a=i;this.state.divertedPointer=this.PointerAtPath(a.targetPath)}else{if(t.isExternal)return this.CallExternalFunction(t.targetPathString,t.externalArgs),!0;this.state.divertedPointer=t.targetPointer.copy()}return t.pushesToStack&&this.state.callStack.Push(t.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!t.isExternal&&this.Error(t&&null!=t.debugMetadata.sourceName?"Divert target doesn't exist: "+t.debugMetadata.sourceName:"Divert resolution failed: "+t),!0}if(e instanceof x){var o=e;switch(o.commandType){case x.CommandType.EvalStart:this.state.inExpressionEvaluation&&console.warn("Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case x.CommandType.EvalEnd:this.state.inExpressionEvaluation||console.warn("Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case x.CommandType.EvalOutput:if(this.state.evaluationStack.length>0){var s=this.state.PopEvaluationStack();if(!(s instanceof R)){this.state.PushToOutputStream(new b(s.toString()))}}break;case x.CommandType.NoOp:break;case x.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case x.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case x.CommandType.PopFunction:case x.CommandType.PopTunnel:var u=o.commandType==x.CommandType.PopFunction?E.Function:E.Tunnel,c=null;if(u==E.Tunnel){var h=this.state.PopEvaluationStack();if((c=h)instanceof k==0){if(h instanceof R==0)throw"Expected void if ->-> doesn't override target";c=null}}if(this.state.TryExitFunctionEvaluationFromGame())break;if(this.state.callStack.currentElement.type==u&&this.state.callStack.canPop)this.state.PopCallStack(),c&&(this.state.divertedPointer=this.PointerAtPath(c.targetPath));else{var f={};f[E.Function]="function return statement (~ return)",f[E.Tunnel]="tunnel onwards statement (->->)";var d=f[this.state.callStack.currentElement.type];this.state.callStack.canPop||(d="end of flow (-> END or choice)");this.Error("Found "+f[u]+", when expected "+d)}break;case x.CommandType.BeginString:this.state.PushToOutputStream(o),this.state.inExpressionEvaluation||console.warn("Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case x.CommandType.EndString:for(var v=[],m=0,_=this.state.outputStream.length-1;_>=0;--_){var g=this.state.outputStream[_];if(m++,g instanceof x&&g.commandType==x.CommandType.BeginString)break;g instanceof b&&v.push(g)}this.state.PopFromOutputStream(m),v=v.reverse();var S=new l;v.forEach(function(e){S.Append(e.toString())}),this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new b(S.toString()));break;case x.CommandType.ChoiceCount:this.state.PushEvaluationStack(new y(this.state.generatedChoices.length));break;case x.CommandType.TurnsSince:case x.CommandType.ReadCount:if(!((a=this.state.PopEvaluationStack())instanceof k)){var C="";a instanceof y&&(C=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+a+C);break}var A,O=a,V=this.ContentAtPath(O.targetPath).correctObj;null!=(se=V instanceof T?V:null)?A=o.commandType==x.CommandType.TurnsSince?this.TurnsSinceForContainer(se):this.VisitCountForContainer(se):(A=o.commandType==x.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+o.toString()+" lookup at "+O.targetPath.toString())),this.state.PushEvaluationStack(new y(A));break;case x.CommandType.Random:var j=this.state.PopEvaluationStack(),D=this.state.PopEvaluationStack();null!=D&&D instanceof y!=0||this.Error("Invalid value for minimum parameter of RANDOM(min, max)"),null!=j&&D instanceof y!=0||this.Error("Invalid value for maximum parameter of RANDOM(min, max)");var G=j.value-D.value+1;G<=0&&this.Error("RANDOM was called with minimum as "+D.value+" and maximum as "+j.value+". The maximum must be larger");var B=this.state.storySeed+this.state.previousRandom,M=new U(B).next();this.state.PushEvaluationStack(new y(M%G+D.value)),this.state.previousRandom=M;break;case x.CommandType.SeedRandom:var W=this.state.PopEvaluationStack();null!=W&&W instanceof y!=0||this.Error("Invalid value passed to SEED_RANDOM"),this.state.storySeed=W.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new R);break;case x.CommandType.VisitIndex:var H=this.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new y(H));break;case x.CommandType.SequenceShuffleIndex:var q=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new y(q));break;case x.CommandType.StartThread:break;case x.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=P.Null);break;case x.CommandType.End:this.state.ForceEnd();break;case x.CommandType.ListFromInt:var J=parseInt(this.state.PopEvaluationStack()),$=this.state.PopEvaluationStack().toString();if(null==J)throw new p("Passed non-integer when creating a list element from a numerical value.");var K,Y=null;if(!(K=this.listDefinitions.TryListGetDefinition($,K)))throw new p("Failed to find LIST called "+$.value);var z=K.TryGetItemWithValue(J);z.exists&&(Y=new w(z.item,J)),null==Y&&(Y=new w),this.state.PushEvaluationStack(Y);break;case x.CommandType.ListRange:var X=this.state.PopEvaluationStack(),Z=this.state.PopEvaluationStack(),Q=this.state.PopEvaluationStack();if(Q instanceof w==0||null==Q||null==Z||null==X)throw new p("Expected list, minimum and maximum for LIST_RANGE");var ee=function(e){return e instanceof w?parseInt(e.value.maxItem.Value):e instanceof y?e.value:-1},te=ee(Z),ne=ee(X);if(-1==te)throw new p("Invalid min range bound passed to LIST_VALUE(): "+Z);if(-1==ne)throw new p("Invalid max range bound passed to LIST_VALUE(): "+X);var ie=new w,re=Q.value.origins;null!=re&&re.forEach(function(e){e.ListRange(te,ne).value.forEach(function(e){ie.value.Add(e.Key,e.Value)})}),this.state.PushEvaluationStack(ie);break;default:this.Error("unhandled ControlCommand: "+o)}return!0}if(e instanceof F){return this.state.variablesState.Assign(e,this.state.PopEvaluationStack()),!0}if(e instanceof N){var ae=e,oe=null;if(null!=ae.pathForCount){var se=ae.containerForCount;H=this.VisitCountForContainer(se),oe=new y(H)}else if(null==(oe=this.state.variablesState.GetVariableWithName(ae.name))){var ue=this.state.variablesState.TryGetDefaultVariableValue(ae.name);null!=ue?(this.Warning("Variable not found in save state: '"+ae.name+"', but seems to have been newly created. Assigning value from latest ink's declaration: "+ue),oe=ue,state.variablesState.SetGlobal(ae.name,oe)):(this.Warning("Variable not found: '"+ae.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit."),oe=new y(0))}return this.state.PushEvaluationStack(oe),!0}if(e instanceof L){var le=e,ce=this.state.PopEvaluationStack(le.numberOfParameters);return ie=le.Call(ce),this.state.PushEvaluationStack(ie),!0}return!1}},{key:"ChoosePathString",value:function(e,t,i){if(t=void 0===t||t,i=i||[],this.IfAsyncWeCant("call ChoosePathString right now"),t)this.ResetCallstack();else if(this.state.callStack.currentElement.type==E.Function){var r="",a=this.state.callStack.currentElement.currentPointer.container;throw null!=a&&(r="("+a.path.toString()+") "),"Story was running a function "+r+"when you called ChoosePathString("+e+") - this is almost certainly not not what you want! Full stack trace: \n"+this.state.callStack.callStackTrace}this.state.PassArgumentsToEvaluationStack(i),this.ChoosePath(new n(e))}},{key:"IfAsyncWeCant",value:function(e){if(this._asyncContinueActive)throw"Can't "+e+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand."}},{key:"ChoosePath",value:function(e){this.state.SetChosenPath(e),this.VisitChangedContainersDueToDivert()}},{key:"ChooseChoiceIndex",value:function(e){e=e;var t=this.currentChoices;(e<0||e>t.length)&&console.warn("choice out of range");var n=t[e];this.state.callStack.currentThread=n.threadAtGeneration,this.ChoosePath(n.targetPath)}},{key:"HasFunction",value:function(e){try{return null!=this.KnotContainerWithName(e)}catch(e){return!1}}},{key:"EvaluateFunction",value:function(e,t,n){if(n=!!n,this.IfAsyncWeCant("evaluate a function"),null==e)throw"Function is null";if(""==e||""==e.trim())throw"Function is empty or white space.";var i=this.KnotContainerWithName(e);if(null==i)throw"Function doesn't exist: '"+e+"'";var r=[];r.push.apply(r,this.state.outputStream),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(i,t);for(var a=new l;this.canContinue;)a.Append(this.Continue());var o=a.toString();this._state.ResetOutput(r);var s=this.state.CompleteFunctionEvaluationFromGame();return n?{returned:s,output:o}:s}},{key:"EvaluateExpression",value:function(e){var t=this.state.callStack.elements.length;this.state.callStack.Push(E.Tunnel),this._temporaryEvaluationContainer=e,this.state.GoToStart();var n=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>t&&this.state.PopCallStack(),this.state.evaluationStack.length>n?this.state.PopEvaluationStack():null}},{key:"CallExternalFunction",value:function(e,t){var n=this._externals[e],i=null;if(void 0===n){if(this.allowExternalFunctionFallbacks)return(i=this.KnotContainerWithName(e))instanceof T||console.warn("Trying to call EXTERNAL function '"+e+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(E.Function,void 0,this.state.outputStream.length),void(this.state.divertedPointer=P.StartOf(i));console.warn("Trying to call EXTERNAL function '"+e+"' which has not been bound (and ink fallbacks disabled).")}for(var r=[],a=0;a<t;++a){r.push(this.state.PopEvaluationStack().valueObject)}r.reverse();var o=n(r),s=null;null!=o?null==(s=_.Create(o))&&console.warn("Could not create ink value from returned object of type "+(void 0===o?"undefined":h(o))):s=new R,this.state.PushEvaluationStack(s)}},{key:"TryCoerce",value:function(e){return e}},{key:"BindExternalFunctionGeneral",value:function(e,t){this.IfAsyncWeCant("bind an external function"),this._externals[e]&&console.warn("Function '"+e+"' has already been bound."),this._externals[e]=t}},{key:"BindExternalFunction",value:function(e,t){var n=this;t||console.warn("Can't bind a null function"),this.BindExternalFunctionGeneral(e,function(e){e.length<t.length&&console.warn("External function expected "+t.length+" arguments");for(var i=[],r=0,a=e.length;r<a;r++)i[r]=n.TryCoerce(e[r]);return t.apply(null,i)})}},{key:"UnbindExternalFunction",value:function(e){this.IfAsyncWeCant("unbind an external a function"),void 0===this._externals[e]&&console.warn("Function '"+e+"' has not been bound."),delete this._externals[e]}},{key:"ValidateExternalBindings",value:function(e,t){var n=this;if(e)if(e instanceof T){var i=e;for(var r in i.content.forEach(function(e){n.ValidateExternalBindings(e,t)}),i.namedContent)this.ValidateExternalBindings(i.namedContent[r],t)}else{var a=e;if(a instanceof I&&a.isExternal){var o=a.targetPathString;this._externals[o]||(this.allowExternalFunctionFallbacks?!!this.mainContentContainer.namedContent[o]||t.push(o):t.push(o))}}else if(t=[],this.ValidateExternalBindings(this._mainContentContainer,t),this._hasValidatedExternals=!0,0==t.length)this._hasValidatedExternals=!0;else{var s="Error: Missing function binding for external";s+=t.length>1?"s":"",s+=": '",s+=t.join("', '"),s+="' ",s+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(s)}}},{key:"ObserveVariable",value:function(e,t){if(this.IfAsyncWeCant("observe a new variable"),null==this._variableObservers&&(this._variableObservers={}),!this.state.variablesState.GlobalVariableExistsWithName(e))throw new p("Cannot observe variable '"+e+"' because it wasn't declared in the ink story.");this._variableObservers[e]?this._variableObservers[e].push(t):this._variableObservers[e]=[t]}},{key:"ObserveVariables",value:function(e,t){for(var n=0,i=e.length;n<i;n++)this.ObserveVariable(e[n],t[n])}},{key:"RemoveVariableObserver",value:function(e,t){if(this.IfAsyncWeCant("remove a variable observer"),null!=this._variableObservers)if(void 0!==t)this._variableObservers[t]&&this._variableObservers[t].splice(this._variableObservers[t].indexOf(e),1);else for(var n in this._variableObservers)this._variableObservers[n].splice(this._variableObservers[n].indexOf(e),1)}},{key:"VariableStateDidChangeEvent",value:function(e,t){if(null!=this._variableObservers){var n=this._variableObservers[e];if(void 0!==n){if(!(t instanceof _))throw"Tried to get the value of a variable that isn't a standard type";var i=t;n.forEach(function(t){t(e,i.valueObject)})}}}},{key:"TagsForContentAtPath",value:function(e){return this.TagsAtStartOfFlowContainerWithPathString(e)}},{key:"TagsAtStartOfFlowContainerWithPathString",value:function(e){for(var t=new n(e),i=this.ContentAtPath(t).container;;){var r=i.content[0];if(!(r instanceof T))break;i=r}var a=null;return i.content.every(function(e){var t=e;return t instanceof j&&(null==a&&(a=[]),a.push(t.text),!0)}),a}},{key:"BuildStringOfHierarchy",value:function(){var e=new l;return this.mainContentContainer.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}},{key:"BuildStringOfContainer",value:function(e){var t=new l;return e.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}},{key:"NextContent",value:function(){if(this.state.previousPointer=this.state.currentPointer.copy(),(this.state.divertedPointer.isNull||(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=P.Null,this.VisitChangedContainersDueToDivert(),this.state.currentPointer.isNull))&&!this.IncrementContentPointer()){var e=!1;this.state.callStack.CanPop(E.Function)?(this.state.PopCallStack(E.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new R),e=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),e=!0):this.state.TryExitFunctionEvaluationFromGame(),e&&!this.state.currentPointer.isNull&&this.NextContent()}}},{key:"IncrementContentPointer",value:function(){var e=!0,t=this.state.callStack.currentElement.currentPointer.copy();for(t.index++;t.index>=t.container.content.length;){e=!1;var n=t.container.parent;if(n instanceof T==0)break;var i=n.content.indexOf(t.container);if(-1==i)break;(t=new P(n,i)).index++,e=!0}return e||(t=P.Null),this.state.callStack.currentElement.currentPointer=t.copy(),e}},{key:"TryFollowDefaultInvisibleChoice",value:function(){var e=this._state.currentChoices,t=e.filter(function(e){return e.isInvisibleDefault});return!(0==t.length||e.length>t.length)&&(this.ChoosePath(t[0].targetPath),!0)}},{key:"VisitCountForContainer",value:function(e){if(!e.visitsShouldBeCounted)return console.warn("Read count for target ("+e.name+" - on "+e.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;var t=0;return t=this.state.visitCounts[e.path.toString()]||t}},{key:"IncrementVisitCountForContainer",value:function(e){var t=0,n=e.path.toString();this.state.visitCounts[n]&&(t=this.state.visitCounts[n]),t++,this.state.visitCounts[n]=t}},{key:"RecordTurnIndexVisitToContainer",value:function(e){this.state.turnIndices[e.path.toString()]=this.state.currentTurnIndex}},{key:"TurnsSinceForContainer",value:function(e){e.turnIndexShouldBeCounted||this.Error("TURNS_SINCE() for target ("+e.name+" - on "+e.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c).");var t=e.path.toString(),n=this.state.turnIndices[t];return void 0!==n?this.state.currentTurnIndex-n:-1}},{key:"NextSequenceShuffleIndex",value:function(){var e=this.state.PopEvaluationStack();if(!(e instanceof y))return this.Error("expected number of elements in sequence for shuffle index"),0;for(var t=this.state.currentPointer.container,n=e.value,i=this.state.PopEvaluationStack().value,r=i/n,a=i%n,o=t.path.toString(),s=0,u=0,l=o.length;u<l;u++)s+=o.charCodeAt(u)||0;var c=s+r+this.state.storySeed,h=new U(parseInt(c)),f=[];for(u=0;u<n;++u)f.push(u);for(u=0;u<=a;++u){var d=h.next()%f.length,p=f[d];if(f.splice(d,1),u==a)return p}throw"Should never reach here"}},{key:"Error",value:function(e){throw new p(e)}},{key:"Warning",value:function(e){this.AddError(e,!0)}},{key:"AddError",value:function(e,t){var n=t?"WARNING":"ERROR";e=this.state.currentPointer.isNull?"RUNTIME "+n+": "+e:"RUNTIME "+n+": ("+this.state.currentPath+"): "+e,this.state.AddError(e,t),t||this.state.ForceEnd()}},{key:"currentChoices",get:function(){var e=[];return this._state.currentChoices.forEach(function(t){t.isInvisibleDefault||(t.index=e.length,e.push(t))}),e}},{key:"currentText",get:function(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}},{key:"currentTags",get:function(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}},{key:"currentErrors",get:function(){return this.state.currentErrors}},{key:"currentWarnings",get:function(){return this.state.currentWarnings}},{key:"hasError",get:function(){return this.state.hasError}},{key:"hasWarning",get:function(){return this.state.hasWarning}},{key:"variablesState",get:function(){return this.state.variablesState}},{key:"listDefinitions",get:function(){return this._listDefinitions}},{key:"state",get:function(){return this._state}},{key:"mainContentContainer",get:function(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}},{key:"canContinue",get:function(){return this.state.canContinue}},{key:"asyncContinueComplete",get:function(){return!this._asyncContinueActive}},{key:"globalTags",get:function(){return this.TagsAtStartOfFlowContainerWithPathString("")}}]),e}(),Z={NoChange:0,ExtendedBeyondNewline:1,NewlineRemoved:2};e.Story=X,e.InkList=d,Object.defineProperty(e,"__esModule",{value:!0})})},function(e,n){"use strict";function i(e){var t={};return e.forEach(function(e){var n=e.split(":"),i=n[0].trim(),r=n.slice(1).join(":").trim(),a=r.substr(0,1);"{"!==a&&"["!==a||(r=JSON.parse(r)),t[i]=r}),t}Object.defineProperty(n,"__esModule",{value:!0}),n.default=function(e,n){for(var r={type:"text",content:[],text:[],tags:{},choices:[]};e.canContinue;){e.Continue();var a=e.currentText;if(0===a.indexOf(">>>")){var o=n.run(a);o&&r.text.push(o)}else r.text.push(a);var s=i(e.currentTags);s.scene&&(r.type=s.scene),r.tags=t({},r.tags,s),r.content.push({text:a,tags:s})}return e.currentChoices.forEach(function(e,t){r.choices.push({id:t,choice:e.text})}),r}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();t.default=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.dependencies=t,this.commands={}}return n(e,[{key:"register",value:function(e,t,n){this.commands[e]={callback:t,deps:n}}},{key:"run",value:function(e){var t=this,n=e.replace(/(\r\n\t|\n|\r\t)/gm,"").split(" "),i=n[1],r=n.slice(2);if(!(i in this.commands))return e;var a=this.commands[i],o=[];return a.deps&&a.deps.forEach(function(e){o.push(t.dependencies[e])}),a.callback.apply(a,[r].concat(o))}}]),e}()},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();t.default=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.observers={}}return n(e,[{key:"register",value:function(e){var t=this;Object.keys(e).forEach(function(n){t.observers[n]=e[n]})}},{key:"attach",value:function(e){var t=this;Object.keys(this.observers).forEach(function(n){e.observeVar(n,t.observers[n])})}}]),e}()},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();t.default=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.functions={}}return n(e,[{key:"register",value:function(e){var t=this;Object.keys(e).forEach(function(n){t.functions[n]=e[n]})}},{key:"attach",value:function(e){var t=this;Object.keys(this.functions).forEach(function(n){e.bindFunction(n,t.functions[n])})}}]),e}()}])})},"aA/P":function(e){e.exports={choice:"choice__3HkX2",endEpisode:"endEpisode__1IBfH"}},h6ac:function(e){var t;t=function(){return this}();try{t=t||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(t=window)}e.exports=t},hAVL:function(e){e.exports={sound:"sound__3_d27"}},lyKV:function(e,t,n){(function(n){var i,r;!function(){"use strict";var a=function(){this.init()};a.prototype={init:function(){var e=this||o;return e._counter=1e3,e._codecs={},e._howls=[],e._muted=!1,e._volume=1,e._canPlayEvent="canplaythrough",e._navigator="undefined"!=typeof window&&window.navigator?window.navigator:null,e.masterGain=null,e.noAudio=!1,e.usingWebAudio=!0,e.autoSuspend=!0,e.ctx=null,e.mobileAutoEnable=!0,e._setup(),e},volume:function(e){var t=this||o;if(e=parseFloat(e),t.ctx||p(),void 0!==e&&e>=0&&e<=1){if(t._volume=e,t._muted)return t;t.usingWebAudio&&t.masterGain.gain.setValueAtTime(e,o.ctx.currentTime);for(var n=0;n<t._howls.length;n++)if(!t._howls[n]._webAudio)for(var i=t._howls[n]._getSoundIds(),r=0;r<i.length;r++){var a=t._howls[n]._soundById(i[r]);a&&a._node&&(a._node.volume=a._volume*e)}return t}return t._volume},mute:function(e){var t=this||o;t.ctx||p(),t._muted=e,t.usingWebAudio&&t.masterGain.gain.setValueAtTime(e?0:t._volume,o.ctx.currentTime);for(var n=0;n<t._howls.length;n++)if(!t._howls[n]._webAudio)for(var i=t._howls[n]._getSoundIds(),r=0;r<i.length;r++){var a=t._howls[n]._soundById(i[r]);a&&a._node&&(a._node.muted=!!e||a._muted)}return t},unload:function(){for(var e=this||o,t=e._howls.length-1;t>=0;t--)e._howls[t].unload();return e.usingWebAudio&&e.ctx&&void 0!==e.ctx.close&&(e.ctx.close(),e.ctx=null,p()),e},codecs:function(e){return(this||o)._codecs[e.replace(/^x-/,"")]},_setup:function(){var e=this||o;if(e.state=e.ctx?e.ctx.state||"running":"running",e._autoSuspend(),!e.usingWebAudio)if("undefined"!=typeof Audio)try{var t=new Audio;void 0===t.oncanplaythrough&&(e._canPlayEvent="canplay")}catch(t){e.noAudio=!0}else e.noAudio=!0;try{var t=new Audio;t.muted&&(e.noAudio=!0)}catch(e){}return e.noAudio||e._setupCodecs(),e},_setupCodecs:function(){var e=this||o,t=null;try{t="undefined"!=typeof Audio?new Audio:null}catch(t){return e}if(!t||"function"!=typeof t.canPlayType)return e;var n=t.canPlayType("audio/mpeg;").replace(/^no$/,""),i=e._navigator&&e._navigator.userAgent.match(/OPR\/([0-6].)/g),r=i&&parseInt(i[0].split("/")[1],10)<33;return e._codecs={mp3:!(r||!n&&!t.canPlayType("audio/mp3;").replace(/^no$/,"")),mpeg:!!n,opus:!!t.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!t.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),aac:!!t.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!t.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(t.canPlayType("audio/x-m4a;")||t.canPlayType("audio/m4a;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(t.canPlayType("audio/x-mp4;")||t.canPlayType("audio/mp4;")||t.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!t.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),webm:!!t.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),dolby:!!t.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(t.canPlayType("audio/x-flac;")||t.canPlayType("audio/flac;")).replace(/^no$/,"")},e},_enableMobileAudio:function(){var e=this||o,t=/iPhone|iPad|iPod|Android|BlackBerry|BB10|Silk|Mobi|Chrome/i.test(e._navigator&&e._navigator.userAgent);if(!e._mobileEnabled&&e.ctx&&t){e._mobileEnabled=!1,e.mobileAutoEnable=!1,e._mobileUnloaded||44100===e.ctx.sampleRate||(e._mobileUnloaded=!0,e.unload()),e._scratchBuffer=e.ctx.createBuffer(1,1,22050);var n=function t(n){n.preventDefault(),o._autoResume();var i=e.ctx.createBufferSource();i.buffer=e._scratchBuffer,i.connect(e.ctx.destination),void 0===i.start?i.noteOn(0):i.start(0),"function"==typeof e.ctx.resume&&e.ctx.resume(),i.onended=function(){i.disconnect(0),e._mobileEnabled=!0,document.removeEventListener("touchstart",t,!0),document.removeEventListener("touchend",t,!0),document.removeEventListener("click",t,!0);for(var n=0;n<e._howls.length;n++)e._howls[n]._emit("unlock")}};return document.addEventListener("touchstart",n,!0),document.addEventListener("touchend",n,!0),document.addEventListener("click",n,!0),e}},_autoSuspend:function(){var e=this;if(e.autoSuspend&&e.ctx&&void 0!==e.ctx.suspend&&o.usingWebAudio){for(var t=0;t<e._howls.length;t++)if(e._howls[t]._webAudio)for(var n=0;n<e._howls[t]._sounds.length;n++)if(!e._howls[t]._sounds[n]._paused)return e;return e._suspendTimer&&clearTimeout(e._suspendTimer),e._suspendTimer=setTimeout(function(){e.autoSuspend&&(e._suspendTimer=null,e.state="suspending",e.ctx.suspend().then(function(){e.state="suspended",e._resumeAfterSuspend&&(delete e._resumeAfterSuspend,e._autoResume())}))},3e4),e}},_autoResume:function(){var e=this;if(e.ctx&&void 0!==e.ctx.resume&&o.usingWebAudio)return"running"===e.state&&e._suspendTimer?(clearTimeout(e._suspendTimer),e._suspendTimer=null):"suspended"===e.state?(e.ctx.resume().then(function(){e.state="running";for(var t=0;t<e._howls.length;t++)e._howls[t]._emit("resume")}),e._suspendTimer&&(clearTimeout(e._suspendTimer),e._suspendTimer=null)):"suspending"===e.state&&(e._resumeAfterSuspend=!0),e}};var o=new a,s=function(e){var t=this;if(!e.src||0===e.src.length)return void console.error("An array of source files must be passed with any new Howl.");t.init(e)};s.prototype={init:function(e){var t=this;return o.ctx||p(),t._autoplay=e.autoplay||!1,t._format="string"!=typeof e.format?e.format:[e.format],t._html5=e.html5||!1,t._muted=e.mute||!1,t._loop=e.loop||!1,t._pool=e.pool||5,t._preload="boolean"!=typeof e.preload||e.preload,t._rate=e.rate||1,t._sprite=e.sprite||{},t._src="string"!=typeof e.src?e.src:[e.src],t._volume=void 0!==e.volume?e.volume:1,t._xhrWithCredentials=e.xhrWithCredentials||!1,t._duration=0,t._state="unloaded",t._sounds=[],t._endTimers={},t._queue=[],t._playLock=!1,t._onend=e.onend?[{fn:e.onend}]:[],t._onfade=e.onfade?[{fn:e.onfade}]:[],t._onload=e.onload?[{fn:e.onload}]:[],t._onloaderror=e.onloaderror?[{fn:e.onloaderror}]:[],t._onplayerror=e.onplayerror?[{fn:e.onplayerror}]:[],t._onpause=e.onpause?[{fn:e.onpause}]:[],t._onplay=e.onplay?[{fn:e.onplay}]:[],t._onstop=e.onstop?[{fn:e.onstop}]:[],t._onmute=e.onmute?[{fn:e.onmute}]:[],t._onvolume=e.onvolume?[{fn:e.onvolume}]:[],t._onrate=e.onrate?[{fn:e.onrate}]:[],t._onseek=e.onseek?[{fn:e.onseek}]:[],t._onunlock=e.onunlock?[{fn:e.onunlock}]:[],t._onresume=[],t._webAudio=o.usingWebAudio&&!t._html5,void 0!==o.ctx&&o.ctx&&o.mobileAutoEnable&&o._enableMobileAudio(),o._howls.push(t),t._autoplay&&t._queue.push({event:"play",action:function(){t.play()}}),t._preload&&t.load(),t},load:function(){var e=this,t=null;if(o.noAudio)return void e._emit("loaderror",null,"No audio support.");"string"==typeof e._src&&(e._src=[e._src]);for(var n=0;n<e._src.length;n++){var i,r;if(e._format&&e._format[n])i=e._format[n];else{if("string"!=typeof(r=e._src[n])){e._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}i=/^data:audio\/([^;,]+);/i.exec(r),i||(i=/\.([^.]+)$/.exec(r.split("?",1)[0])),i&&(i=i[1].toLowerCase())}if(i||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),i&&o.codecs(i)){t=e._src[n];break}}return t?(e._src=t,e._state="loading","https:"===window.location.protocol&&"http:"===t.slice(0,5)&&(e._html5=!0,e._webAudio=!1),new u(e),e._webAudio&&c(e),e):void e._emit("loaderror",null,"No codec support for selected audio sources.")},play:function(e,t){var n=this,i=null;if("number"==typeof e)i=e,e=null;else{if("string"==typeof e&&"loaded"===n._state&&!n._sprite[e])return null;if(void 0===e){e="__default";for(var r=0,a=0;a<n._sounds.length;a++)n._sounds[a]._paused&&!n._sounds[a]._ended&&(r++,i=n._sounds[a]._id);1===r?e=null:i=null}}var s=i?n._soundById(i):n._inactiveSound();if(!s)return null;if(i&&!e&&(e=s._sprite||"__default"),"loaded"!==n._state){s._sprite=e,s._ended=!1;var u=s._id;return n._queue.push({event:"play",action:function(){n.play(u)}}),u}if(i&&!s._paused)return t||n._loadQueue("play"),s._id;n._webAudio&&o._autoResume();var l=Math.max(0,s._seek>0?s._seek:n._sprite[e][0]/1e3),c=Math.max(0,(n._sprite[e][0]+n._sprite[e][1])/1e3-l),h=1e3*c/Math.abs(s._rate);if(s._paused=!1,s._ended=!1,s._sprite=e,s._seek=l,s._start=n._sprite[e][0]/1e3,s._stop=(n._sprite[e][0]+n._sprite[e][1])/1e3,s._loop=!(!s._loop&&!n._sprite[e][2]),s._seek>=s._stop)return void n._ended(s);var f=s._node;if(n._webAudio){var d=function(){n._refreshBuffer(s),f.gain.setValueAtTime(s._muted||n._muted?0:s._volume,o.ctx.currentTime),s._playStart=o.ctx.currentTime,void 0===f.bufferSource.start?s._loop?f.bufferSource.noteGrainOn(0,l,86400):f.bufferSource.noteGrainOn(0,l,c):s._loop?f.bufferSource.start(0,l,86400):f.bufferSource.start(0,l,c),h!==1/0&&(n._endTimers[s._id]=setTimeout(n._ended.bind(n,s),h)),t||setTimeout(function(){n._emit("play",s._id)},0)};"running"===o.state?d():(n.once("resume",d),n._clearTimer(s._id))}else{var p=function(){f.currentTime=l,f.muted=s._muted||n._muted||o._muted||f.muted,f.volume=s._volume*o.volume(),f.playbackRate=s._rate;try{var i=f.play();if("undefined"!=typeof Promise&&(i instanceof Promise||"function"==typeof i.then)?(n._playLock=!0,i.then(function(){n._playLock=!1,t||n._emit("play",s._id)}).catch(function(){n._playLock=!1,n._emit("playerror",s._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.")})):t||n._emit("play",s._id),f.playbackRate=s._rate,f.paused)return void n._emit("playerror",s._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");"__default"!==e||s._loop?n._endTimers[s._id]=setTimeout(n._ended.bind(n,s),h):(n._endTimers[s._id]=function(){n._ended(s),f.removeEventListener("ended",n._endTimers[s._id],!1)},f.addEventListener("ended",n._endTimers[s._id],!1))}catch(e){n._emit("playerror",s._id,e)}},v=window&&window.ejecta||!f.readyState&&o._navigator.isCocoonJS;if(f.readyState>=3||v)p();else{f.addEventListener(o._canPlayEvent,function e(){p(),f.removeEventListener(o._canPlayEvent,e,!1)},!1),n._clearTimer(s._id)}}return s._id},pause:function(e){var t=this;if("loaded"!==t._state||t._playLock)return t._queue.push({event:"pause",action:function(){t.pause(e)}}),t;for(var n=t._getSoundIds(e),i=0;i<n.length;i++){t._clearTimer(n[i]);var r=t._soundById(n[i]);if(r&&!r._paused&&(r._seek=t.seek(n[i]),r._rateSeek=0,r._paused=!0,t._stopFade(n[i]),r._node))if(t._webAudio){if(!r._node.bufferSource)continue;void 0===r._node.bufferSource.stop?r._node.bufferSource.noteOff(0):r._node.bufferSource.stop(0),t._cleanBuffer(r._node)}else isNaN(r._node.duration)&&r._node.duration!==1/0||r._node.pause();arguments[1]||t._emit("pause",r?r._id:null)}return t},stop:function(e,t){var n=this;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"stop",action:function(){n.stop(e)}}),n;for(var i=n._getSoundIds(e),r=0;r<i.length;r++){n._clearTimer(i[r]);var a=n._soundById(i[r]);a&&(a._seek=a._start||0,a._rateSeek=0,a._paused=!0,a._ended=!0,n._stopFade(i[r]),a._node&&(n._webAudio?a._node.bufferSource&&(void 0===a._node.bufferSource.stop?a._node.bufferSource.noteOff(0):a._node.bufferSource.stop(0),n._cleanBuffer(a._node)):isNaN(a._node.duration)&&a._node.duration!==1/0||(a._node.currentTime=a._start||0,a._node.pause())),t||n._emit("stop",a._id))}return n},mute:function(e,t){var n=this;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"mute",action:function(){n.mute(e,t)}}),n;if(void 0===t){if("boolean"!=typeof e)return n._muted;n._muted=e}for(var i=n._getSoundIds(t),r=0;r<i.length;r++){var a=n._soundById(i[r]);a&&(a._muted=e,a._interval&&n._stopFade(a._id),n._webAudio&&a._node?a._node.gain.setValueAtTime(e?0:a._volume,o.ctx.currentTime):a._node&&(a._node.muted=!!o._muted||e),n._emit("mute",a._id))}return n},volume:function(){var e,t,n=this,i=arguments;if(0===i.length)return n._volume;if(1===i.length||2===i.length&&void 0===i[1]){n._getSoundIds().indexOf(i[0])>=0?t=parseInt(i[0],10):e=parseFloat(i[0])}else i.length>=2&&(e=parseFloat(i[0]),t=parseInt(i[1],10));var r;if(!(void 0!==e&&e>=0&&e<=1))return r=t?n._soundById(t):n._sounds[0],r?r._volume:0;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"volume",action:function(){n.volume.apply(n,i)}}),n;void 0===t&&(n._volume=e),t=n._getSoundIds(t);for(var a=0;a<t.length;a++)(r=n._soundById(t[a]))&&(r._volume=e,i[2]||n._stopFade(t[a]),n._webAudio&&r._node&&!r._muted?r._node.gain.setValueAtTime(e,o.ctx.currentTime):r._node&&!r._muted&&(r._node.volume=e*o.volume()),n._emit("volume",r._id));return n},fade:function(e,t,n,i){var r=this;if("loaded"!==r._state||r._playLock)return r._queue.push({event:"fade",action:function(){r.fade(e,t,n,i)}}),r;r.volume(e,i);for(var a=r._getSoundIds(i),s=0;s<a.length;s++){var u=r._soundById(a[s]);if(u){if(i||r._stopFade(a[s]),r._webAudio&&!u._muted){var l=o.ctx.currentTime,c=l+n/1e3;u._volume=e,u._node.gain.setValueAtTime(e,l),u._node.gain.linearRampToValueAtTime(t,c)}r._startFadeInterval(u,e,t,n,a[s],void 0===i)}}return r},_startFadeInterval:function(e,t,n,i,r,a){var o=this,s=t,u=n-t,l=Math.abs(u/.01),c=Math.max(4,l>0?i/l:i),h=Date.now();e._fadeTo=n,e._interval=setInterval(function(){var r=(Date.now()-h)/i;h=Date.now(),s+=u*r,s=Math.max(0,s),s=Math.min(1,s),s=Math.round(100*s)/100,o._webAudio?e._volume=s:o.volume(s,e._id,!0),a&&(o._volume=s),(n<t&&s<=n||n>t&&s>=n)&&(clearInterval(e._interval),e._interval=null,e._fadeTo=null,o.volume(n,e._id),o._emit("fade",e._id))},c)},_stopFade:function(e){var t=this,n=t._soundById(e);return n&&n._interval&&(t._webAudio&&n._node.gain.cancelScheduledValues(o.ctx.currentTime),clearInterval(n._interval),n._interval=null,t.volume(n._fadeTo,e),n._fadeTo=null,t._emit("fade",e)),t},loop:function(){var e,t,n,i=this,r=arguments;if(0===r.length)return i._loop;if(1===r.length){if("boolean"!=typeof r[0])return!!(n=i._soundById(parseInt(r[0],10)))&&n._loop;e=r[0],i._loop=e}else 2===r.length&&(e=r[0],t=parseInt(r[1],10));for(var a=i._getSoundIds(t),o=0;o<a.length;o++)(n=i._soundById(a[o]))&&(n._loop=e,i._webAudio&&n._node&&n._node.bufferSource&&(n._node.bufferSource.loop=e,e&&(n._node.bufferSource.loopStart=n._start||0,n._node.bufferSource.loopEnd=n._stop)));return i},rate:function(){var e,t,n=this,i=arguments;if(0===i.length)t=n._sounds[0]._id;else if(1===i.length){var r=n._getSoundIds(),a=r.indexOf(i[0]);a>=0?t=parseInt(i[0],10):e=parseFloat(i[0])}else 2===i.length&&(e=parseFloat(i[0]),t=parseInt(i[1],10));var s;if("number"!=typeof e)return s=n._soundById(t),s?s._rate:n._rate;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"rate",action:function(){n.rate.apply(n,i)}}),n;void 0===t&&(n._rate=e),t=n._getSoundIds(t);for(var u=0;u<t.length;u++)if(s=n._soundById(t[u])){s._rateSeek=n.seek(t[u]),s._playStart=n._webAudio?o.ctx.currentTime:s._playStart,s._rate=e,n._webAudio&&s._node&&s._node.bufferSource?s._node.bufferSource.playbackRate.setValueAtTime(e,o.ctx.currentTime):s._node&&(s._node.playbackRate=e);var l=n.seek(t[u]),c=(n._sprite[s._sprite][0]+n._sprite[s._sprite][1])/1e3-l,h=1e3*c/Math.abs(s._rate);!n._endTimers[t[u]]&&s._paused||(n._clearTimer(t[u]),n._endTimers[t[u]]=setTimeout(n._ended.bind(n,s),h)),n._emit("rate",s._id)}return n},seek:function(){var e,t,n=this,i=arguments;if(0===i.length)t=n._sounds[0]._id;else if(1===i.length){var r=n._getSoundIds(),a=r.indexOf(i[0]);a>=0?t=parseInt(i[0],10):n._sounds.length&&(t=n._sounds[0]._id,e=parseFloat(i[0]))}else 2===i.length&&(e=parseFloat(i[0]),t=parseInt(i[1],10));if(void 0===t)return n;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"seek",action:function(){n.seek.apply(n,i)}}),n;var s=n._soundById(t);if(s){if(!("number"==typeof e&&e>=0)){if(n._webAudio){var u=n.playing(t)?o.ctx.currentTime-s._playStart:0;return s._seek+((s._rateSeek?s._rateSeek-s._seek:0)+u*Math.abs(s._rate))}return s._node.currentTime}var l=n.playing(t);l&&n.pause(t,!0),s._seek=e,s._ended=!1,n._clearTimer(t),!n._webAudio&&s._node&&(s._node.currentTime=e);var c=function(){n._emit("seek",t),l&&n.play(t,!0)};if(l&&!n._webAudio){var h=function e(){n._playLock?setTimeout(e,0):c()};setTimeout(h,0)}else c()}return n},playing:function(e){var t=this;if("number"==typeof e){var n=t._soundById(e);return!!n&&!n._paused}for(var i=0;i<t._sounds.length;i++)if(!t._sounds[i]._paused)return!0;return!1},duration:function(e){var t=this,n=t._duration,i=t._soundById(e);return i&&(n=t._sprite[i._sprite][1]/1e3),n},state:function(){return this._state},unload:function(){for(var e=this,t=e._sounds,n=0;n<t.length;n++){if(t[n]._paused||e.stop(t[n]._id),!e._webAudio){/MSIE |Trident\//.test(o._navigator&&o._navigator.userAgent)||(t[n]._node.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"),t[n]._node.removeEventListener("error",t[n]._errorFn,!1),t[n]._node.removeEventListener(o._canPlayEvent,t[n]._loadFn,!1)}delete t[n]._node,e._clearTimer(t[n]._id)}var i=o._howls.indexOf(e);i>=0&&o._howls.splice(i,1);var r=!0;for(n=0;n<o._howls.length;n++)if(o._howls[n]._src===e._src){r=!1;break}return l&&r&&delete l[e._src],o.noAudio=!1,e._state="unloaded",e._sounds=[],e=null,null},on:function(e,t,n,i){var r=this,a=r["_on"+e];return"function"==typeof t&&a.push(i?{id:n,fn:t,once:i}:{id:n,fn:t}),r},off:function(e,t,n){var i=this,r=i["_on"+e],a=0;if("number"==typeof t&&(n=t,t=null),t||n)for(a=0;a<r.length;a++){var o=n===r[a].id;if(t===r[a].fn&&o||!t&&o){r.splice(a,1);break}}else if(e)i["_on"+e]=[];else{var s=Object.keys(i);for(a=0;a<s.length;a++)0===s[a].indexOf("_on")&&Array.isArray(i[s[a]])&&(i[s[a]]=[])}return i},once:function(e,t,n){var i=this;return i.on(e,t,n,1),i},_emit:function(e,t,n){for(var i=this,r=i["_on"+e],a=r.length-1;a>=0;a--)r[a].id&&r[a].id!==t&&"load"!==e||(setTimeout(function(e){e.call(this,t,n)}.bind(i,r[a].fn),0),r[a].once&&i.off(e,r[a].fn,r[a].id));return i._loadQueue(e),i},_loadQueue:function(e){var t=this;if(t._queue.length>0){var n=t._queue[0];n.event===e&&(t._queue.shift(),t._loadQueue()),e||n.action()}return t},_ended:function(e){var t=this,n=e._sprite;if(!t._webAudio&&e._node&&!e._node.paused&&!e._node.ended&&e._node.currentTime<e._stop)return setTimeout(t._ended.bind(t,e),100),t;var i=!(!e._loop&&!t._sprite[n][2]);if(t._emit("end",e._id),!t._webAudio&&i&&t.stop(e._id,!0).play(e._id),t._webAudio&&i){t._emit("play",e._id),e._seek=e._start||0,e._rateSeek=0,e._playStart=o.ctx.currentTime;var r=1e3*(e._stop-e._start)/Math.abs(e._rate);t._endTimers[e._id]=setTimeout(t._ended.bind(t,e),r)}return t._webAudio&&!i&&(e._paused=!0,e._ended=!0,e._seek=e._start||0,e._rateSeek=0,t._clearTimer(e._id),t._cleanBuffer(e._node),o._autoSuspend()),t._webAudio||i||t.stop(e._id,!0),t},_clearTimer:function(e){var t=this;if(t._endTimers[e]){if("function"!=typeof t._endTimers[e])clearTimeout(t._endTimers[e]);else{var n=t._soundById(e);n&&n._node&&n._node.removeEventListener("ended",t._endTimers[e],!1)}delete t._endTimers[e]}return t},_soundById:function(e){for(var t=this,n=0;n<t._sounds.length;n++)if(e===t._sounds[n]._id)return t._sounds[n];return null},_inactiveSound:function(){var e=this;e._drain();for(var t=0;t<e._sounds.length;t++)if(e._sounds[t]._ended)return e._sounds[t].reset();return new u(e)},_drain:function(){var e=this,t=e._pool,n=0,i=0;if(!(e._sounds.length<t)){for(i=0;i<e._sounds.length;i++)e._sounds[i]._ended&&n++;for(i=e._sounds.length-1;i>=0;i--){if(n<=t)return;e._sounds[i]._ended&&(e._webAudio&&e._sounds[i]._node&&e._sounds[i]._node.disconnect(0),e._sounds.splice(i,1),n--)}}},_getSoundIds:function(e){var t=this;if(void 0===e){for(var n=[],i=0;i<t._sounds.length;i++)n.push(t._sounds[i]._id);return n}return[e]},_refreshBuffer:function(e){var t=this;return e._node.bufferSource=o.ctx.createBufferSource(),e._node.bufferSource.buffer=l[t._src],e._node.bufferSource.connect(e._panner?e._panner:e._node),e._node.bufferSource.loop=e._loop,e._loop&&(e._node.bufferSource.loopStart=e._start||0,e._node.bufferSource.loopEnd=e._stop||0),e._node.bufferSource.playbackRate.setValueAtTime(e._rate,o.ctx.currentTime),t},_cleanBuffer:function(e){var t=this;if(o._scratchBuffer&&e.bufferSource){e.bufferSource.onended=null,e.bufferSource.disconnect(0);try{e.bufferSource.buffer=o._scratchBuffer}catch(e){}}return e.bufferSource=null,t}};var u=function(e){this._parent=e,this.init()};u.prototype={init:function(){var e=this,t=e._parent;return e._muted=t._muted,e._loop=t._loop,e._volume=t._volume,e._rate=t._rate,e._seek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=++o._counter,t._sounds.push(e),e.create(),e},create:function(){var e=this,t=e._parent,n=o._muted||e._muted||e._parent._muted?0:e._volume;return t._webAudio?(e._node=void 0===o.ctx.createGain?o.ctx.createGainNode():o.ctx.createGain(),e._node.gain.setValueAtTime(n,o.ctx.currentTime),e._node.paused=!0,e._node.connect(o.masterGain)):(e._node=new Audio,e._errorFn=e._errorListener.bind(e),e._node.addEventListener("error",e._errorFn,!1),e._loadFn=e._loadListener.bind(e),e._node.addEventListener(o._canPlayEvent,e._loadFn,!1),e._node.src=t._src,e._node.preload="auto",e._node.volume=n*o.volume(),e._node.load()),e},reset:function(){var e=this,t=e._parent;return e._muted=t._muted,e._loop=t._loop,e._volume=t._volume,e._rate=t._rate,e._seek=0,e._rateSeek=0,e._paused=!0,e._ended=!0,e._sprite="__default",e._id=++o._counter,e},_errorListener:function(){var e=this;e._parent._emit("loaderror",e._id,e._node.error?e._node.error.code:0),e._node.removeEventListener("error",e._errorFn,!1)},_loadListener:function(){var e=this,t=e._parent;t._duration=Math.ceil(10*e._node.duration)/10,0===Object.keys(t._sprite).length&&(t._sprite={__default:[0,1e3*t._duration]}),"loaded"!==t._state&&(t._state="loaded",t._emit("load"),t._loadQueue()),e._node.removeEventListener(o._canPlayEvent,e._loadFn,!1)}};var l={},c=function(e){var t=e._src;if(l[t])return e._duration=l[t].duration,void d(e);if(/^data:[^;]+;base64,/.test(t)){for(var n=atob(t.split(",")[1]),i=new Uint8Array(n.length),r=0;r<n.length;++r)i[r]=n.charCodeAt(r);f(i.buffer,e)}else{var a=new XMLHttpRequest;a.open("GET",t,!0),a.withCredentials=e._xhrWithCredentials,a.responseType="arraybuffer",a.onload=function(){var t=(a.status+"")[0];if("0"!==t&&"2"!==t&&"3"!==t)return void e._emit("loaderror",null,"Failed loading audio file with status: "+a.status+".");f(a.response,e)},a.onerror=function(){e._webAudio&&(e._html5=!0,e._webAudio=!1,e._sounds=[],delete l[t],e.load())},h(a)}},h=function(e){try{e.send()}catch(t){e.onerror()}},f=function(e,t){var n=function(e){e&&t._sounds.length>0?(l[t._src]=e,d(t,e)):onError()},i=function(){t._emit("loaderror",null,"Decoding audio data failed.")};"undefined"!=typeof Promise&&1===o.ctx.decodeAudioData.length?o.ctx.decodeAudioData(e).then(n).catch(i):o.ctx.decodeAudioData(e,n,i)},d=function(e,t){t&&!e._duration&&(e._duration=t.duration),0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue())},p=function(){try{"undefined"!=typeof AudioContext?o.ctx=new AudioContext:"undefined"!=typeof webkitAudioContext?o.ctx=new webkitAudioContext:o.usingWebAudio=!1}catch(e){o.usingWebAudio=!1}var e=/iP(hone|od|ad)/.test(o._navigator&&o._navigator.platform),t=o._navigator&&o._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),n=t?parseInt(t[1],10):null;if(e&&n&&n<9){var i=/safari/.test(o._navigator&&o._navigator.userAgent.toLowerCase());(o._navigator&&o._navigator.standalone&&!i||o._navigator&&!o._navigator.standalone&&!i)&&(o.usingWebAudio=!1)}o.usingWebAudio&&(o.masterGain=void 0===o.ctx.createGain?o.ctx.createGainNode():o.ctx.createGain(),o.masterGain.gain.setValueAtTime(o._muted?0:1,o.ctx.currentTime),o.masterGain.connect(o.ctx.destination)),o._setup()};i=[],void 0!==(r=function(){return{Howler:o,Howl:s}}.apply(t,i))&&(e.exports=r),t.Howler=o,t.Howl=s,"undefined"!=typeof window?(window.HowlerGlobal=a,window.Howler=o,window.Howl=s,window.Sound=u):void 0!==n&&(n.HowlerGlobal=a,n.Howler=o,n.Howl=s,n.Sound=u)}(),function(){"use strict";HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){var t=this;if(!t.ctx||!t.ctx.listener)return t;for(var n=t._howls.length-1;n>=0;n--)t._howls[n].stereo(e);return t},HowlerGlobal.prototype.pos=function(e,t,n){var i=this;return i.ctx&&i.ctx.listener?(t="number"!=typeof t?i._pos[1]:t,n="number"!=typeof n?i._pos[2]:n,"number"!=typeof e?i._pos:(i._pos=[e,t,n],void 0!==i.ctx.listener.positionX?(i.ctx.listener.positionX.setTargetAtTime(i._pos[0],Howler.ctx.currentTime,.1),i.ctx.listener.positionY.setTargetAtTime(i._pos[1],Howler.ctx.currentTime,.1),i.ctx.listener.positionZ.setTargetAtTime(i._pos[2],Howler.ctx.currentTime,.1)):i.ctx.listener.setPosition(i._pos[0],i._pos[1],i._pos[2]),i)):i},HowlerGlobal.prototype.orientation=function(e,t,n,i,r,a){var o=this;if(!o.ctx||!o.ctx.listener)return o;var s=o._orientation;return t="number"!=typeof t?s[1]:t,n="number"!=typeof n?s[2]:n,i="number"!=typeof i?s[3]:i,r="number"!=typeof r?s[4]:r,a="number"!=typeof a?s[5]:a,"number"!=typeof e?s:(o._orientation=[e,t,n,i,r,a],void 0!==o.ctx.listener.forwardX?(o.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),o.ctx.listener.forwardY.setTargetAtTime(t,Howler.ctx.currentTime,.1),o.ctx.listener.forwardZ.setTargetAtTime(n,Howler.ctx.currentTime,.1),o.ctx.listener.upX.setTargetAtTime(e,Howler.ctx.currentTime,.1),o.ctx.listener.upY.setTargetAtTime(t,Howler.ctx.currentTime,.1),o.ctx.listener.upZ.setTargetAtTime(n,Howler.ctx.currentTime,.1)):o.ctx.listener.setOrientation(e,t,n,i,r,a),o)},Howl.prototype.init=function(e){return function(t){var n=this;return n._orientation=t.orientation||[1,0,0],n._stereo=t.stereo||null,n._pos=t.pos||null,n._pannerAttr={coneInnerAngle:void 0!==t.coneInnerAngle?t.coneInnerAngle:360,coneOuterAngle:void 0!==t.coneOuterAngle?t.coneOuterAngle:360,coneOuterGain:void 0!==t.coneOuterGain?t.coneOuterGain:0,distanceModel:void 0!==t.distanceModel?t.distanceModel:"inverse",maxDistance:void 0!==t.maxDistance?t.maxDistance:1e4,panningModel:void 0!==t.panningModel?t.panningModel:"HRTF",refDistance:void 0!==t.refDistance?t.refDistance:1,rolloffFactor:void 0!==t.rolloffFactor?t.rolloffFactor:1},n._onstereo=t.onstereo?[{fn:t.onstereo}]:[],n._onpos=t.onpos?[{fn:t.onpos}]:[],n._onorientation=t.onorientation?[{fn:t.onorientation}]:[],e.call(this,t)}}(Howl.prototype.init),Howl.prototype.stereo=function(t,n){var i=this;if(!i._webAudio)return i;if("loaded"!==i._state)return i._queue.push({event:"stereo",action:function(){i.stereo(t,n)}}),i;var r=void 0===Howler.ctx.createStereoPanner?"spatial":"stereo";if(void 0===n){if("number"!=typeof t)return i._stereo;i._stereo=t,i._pos=[t,0,0]}for(var a=i._getSoundIds(n),o=0;o<a.length;o++){var s=i._soundById(a[o]);if(s){if("number"!=typeof t)return s._stereo;s._stereo=t,s._pos=[t,0,0],s._node&&(s._pannerAttr.panningModel="equalpower",s._panner&&s._panner.pan||e(s,r),"spatial"===r?void 0!==s._panner.positionX?(s._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),s._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),s._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):s._panner.setPosition(t,0,0):s._panner.pan.setValueAtTime(t,Howler.ctx.currentTime)),i._emit("stereo",s._id)}}return i},Howl.prototype.pos=function(t,n,i,r){var a=this;if(!a._webAudio)return a;if("loaded"!==a._state)return a._queue.push({event:"pos",action:function(){a.pos(t,n,i,r)}}),a;if(n="number"!=typeof n?0:n,i="number"!=typeof i?-.5:i,void 0===r){if("number"!=typeof t)return a._pos;a._pos=[t,n,i]}for(var o=a._getSoundIds(r),s=0;s<o.length;s++){var u=a._soundById(o[s]);if(u){if("number"!=typeof t)return u._pos;u._pos=[t,n,i],u._node&&(u._panner&&!u._panner.pan||e(u,"spatial"),void 0!==u._panner.positionX?(u._panner.positionX.setValueAtTime(t,Howler.ctx.currentTime),u._panner.positionY.setValueAtTime(n,Howler.ctx.currentTime),u._panner.positionZ.setValueAtTime(i,Howler.ctx.currentTime)):u._panner.setOrientation(t,n,i)),a._emit("pos",u._id)}}return a},Howl.prototype.orientation=function(t,n,i,r){var a=this;if(!a._webAudio)return a;if("loaded"!==a._state)return a._queue.push({event:"orientation",action:function(){a.orientation(t,n,i,r)}}),a;if(n="number"!=typeof n?a._orientation[1]:n,i="number"!=typeof i?a._orientation[2]:i,void 0===r){if("number"!=typeof t)return a._orientation;a._orientation=[t,n,i]}for(var o=a._getSoundIds(r),s=0;s<o.length;s++){var u=a._soundById(o[s]);if(u){if("number"!=typeof t)return u._orientation;u._orientation=[t,n,i],u._node&&(u._panner||(u._pos||(u._pos=a._pos||[0,0,-.5]),e(u,"spatial")),void 0!==u._panner.orientationX?(u._panner.orientationX.setValueAtTime(t,Howler.ctx.currentTime),u._panner.orientationY.setValueAtTime(n,Howler.ctx.currentTime),u._panner.orientationZ.setValueAtTime(i,Howler.ctx.currentTime)):u._panner.setOrientation(t,n,i)),a._emit("orientation",u._id)}}return a},Howl.prototype.pannerAttr=function(){var t,n,i,r=this,a=arguments;if(!r._webAudio)return r;if(0===a.length)return r._pannerAttr;if(1===a.length){if("object"!=typeof a[0])return i=r._soundById(parseInt(a[0],10)),i?i._pannerAttr:r._pannerAttr;t=a[0],void 0===n&&(t.pannerAttr||(t.pannerAttr={coneInnerAngle:t.coneInnerAngle,coneOuterAngle:t.coneOuterAngle,coneOuterGain:t.coneOuterGain,distanceModel:t.distanceModel,maxDistance:t.maxDistance,refDistance:t.refDistance,rolloffFactor:t.rolloffFactor,panningModel:t.panningModel}),r._pannerAttr={coneInnerAngle:void 0!==t.pannerAttr.coneInnerAngle?t.pannerAttr.coneInnerAngle:r._coneInnerAngle,coneOuterAngle:void 0!==t.pannerAttr.coneOuterAngle?t.pannerAttr.coneOuterAngle:r._coneOuterAngle,coneOuterGain:void 0!==t.pannerAttr.coneOuterGain?t.pannerAttr.coneOuterGain:r._coneOuterGain,distanceModel:void 0!==t.pannerAttr.distanceModel?t.pannerAttr.distanceModel:r._distanceModel,maxDistance:void 0!==t.pannerAttr.maxDistance?t.pannerAttr.maxDistance:r._maxDistance,refDistance:void 0!==t.pannerAttr.refDistance?t.pannerAttr.refDistance:r._refDistance,rolloffFactor:void 0!==t.pannerAttr.rolloffFactor?t.pannerAttr.rolloffFactor:r._rolloffFactor,panningModel:void 0!==t.pannerAttr.panningModel?t.pannerAttr.panningModel:r._panningModel})}else 2===a.length&&(t=a[0],n=parseInt(a[1],10));for(var o=r._getSoundIds(n),s=0;s<o.length;s++)if(i=r._soundById(o[s])){var u=i._pannerAttr;u={coneInnerAngle:void 0!==t.coneInnerAngle?t.coneInnerAngle:u.coneInnerAngle,coneOuterAngle:void 0!==t.coneOuterAngle?t.coneOuterAngle:u.coneOuterAngle,coneOuterGain:void 0!==t.coneOuterGain?t.coneOuterGain:u.coneOuterGain,distanceModel:void 0!==t.distanceModel?t.distanceModel:u.distanceModel,maxDistance:void 0!==t.maxDistance?t.maxDistance:u.maxDistance,refDistance:void 0!==t.refDistance?t.refDistance:u.refDistance,rolloffFactor:void 0!==t.rolloffFactor?t.rolloffFactor:u.rolloffFactor,panningModel:void 0!==t.panningModel?t.panningModel:u.panningModel};var l=i._panner;l?(l.coneInnerAngle=u.coneInnerAngle,l.coneOuterAngle=u.coneOuterAngle,l.coneOuterGain=u.coneOuterGain,l.distanceModel=u.distanceModel,l.maxDistance=u.maxDistance,l.refDistance=u.refDistance,l.rolloffFactor=u.rolloffFactor,l.panningModel=u.panningModel):(i._pos||(i._pos=r._pos||[0,0,-.5]),e(i,"spatial"))}return r},Sound.prototype.init=function(e){return function(){var t=this,n=t._parent;t._orientation=n._orientation,t._stereo=n._stereo,t._pos=n._pos,t._pannerAttr=n._pannerAttr,e.call(this),t._stereo?n.stereo(t._stereo):t._pos&&n.pos(t._pos[0],t._pos[1],t._pos[2],t._id)}}(Sound.prototype.init),Sound.prototype.reset=function(e){return function(){var t=this,n=t._parent;return t._orientation=n._orientation,t._stereo=n._stereo,t._pos=n._pos,t._pannerAttr=n._pannerAttr,t._stereo?n.stereo(t._stereo):t._pos?n.pos(t._pos[0],t._pos[1],t._pos[2],t._id):t._panner&&(t._panner.disconnect(0),t._panner=void 0,n._refreshBuffer(t)),e.call(this)}}(Sound.prototype.reset);var e=function(e,t){t=t||"spatial","spatial"===t?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,void 0!==e._panner.positionX?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),void 0!==e._panner.orientationX?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)}}()}).call(t,n("h6ac"))}});
//# sourceMappingURL=route-game.chunk.6d492.js.map
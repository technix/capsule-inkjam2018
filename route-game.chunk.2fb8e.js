webpackJsonp([0],{"69q1":function(t){t.exports={scroller:"scroller__1YrmW",episode:"episode__2mlFw",currentScene:"currentScene__c26jd",dasher:"dasher__3UmY9",paragraphWrapper:"paragraphWrapper__3mEYS",choiceWrapper:"choiceWrapper__pHatH"}},B8ml:function(t,e,n){"use strict";function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function r(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function a(t){return t.replace(W,"$1"+M+"$2").replace(H,"$1"+M+"$2").replace(J,"$1"+M+"$2").replace(q,"$1"+M+"$2").replace(K,"$1"+M+"$2").replace($,"$1"+M+"$2")}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function u(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function l(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function c(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function h(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function f(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function d(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function p(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var v=n("KM04"),_=n("o6ac"),m=n("wYIL"),y=n("ZYns"),g=n.n(y),b=n("3Ix2"),k=n.n(b),S=n("bdDp"),C=n("lyKV"),T={},w={mute:function(t){C.Howler.mute(t)},setVolume:function(t){C.Howler.volume(t)},play:function(t){T[t]||(T[t]=new C.Howl({src:[t]})),T[t].play()},playMusic:function(t){T[t]||(T[t]=new C.Howl({src:[t],html5:!0,loop:!0})),T[t].play()}},O=w,A=new g.a(k.a);A.on("saveGame",function(t){return new Promise(function(e){S.a.set(t.id,t.data),e()})}),A.on("loadGame",function(t){return new Promise(function(e){e(S.a.get(t,!0))})}),A.on("loadStory",function(){return fetch(k.a.episodes[0]).then(function(t){return t.json()})}),A.registerCommand("IMG",function(t){return'<img src="assets/game/'+t+'">'}),A.registerCommand("CLEAR",function(t,e){return e.reset(),!1},["episode"]);var x={gameState:{},renderer:function(t){this.renderer=t},startGame:function(){return A.startGame()},renderScene:function(){A.renderScene();var t=A.getCurrentEpisode();this.gameState={scene:A.getCurrentScene(),episode:t.slice(0,t.length-1)}},makeChoice:function(t){return A.makeChoice(t)},saveGame:function(){return A.saveGame("auto")},resumeGame:function(){return A.loadGame("auto")},initGame:function(){return O.mute(!m.b.getState().sound),O.playMusic("assets/snd/music.mp3"),S.a.exists("auto")?this.resumeGame():this.startGame()},clearSavedGame:function(){S.a.delete("auto")}},E=x,P=n("69q1"),I=n.n(P),N=n("aA/P"),V=n.n(N),F=function(t){function e(){for(var e,n,r,a=arguments.length,o=Array(a),s=0;s<a;s++)o[s]=arguments[s];return e=n=i(this,t.call.apply(t,[this].concat(o))),n.makeChoice=function(t){t.preventDefault(),n.props.makeChoice(n.props.option.id)},r=e,i(n,r)}return r(e,t),e.prototype.render=function(t){var e=t.option;return"^"===e.choice?Object(v.h)("a",{href:"#",onClick:this.makeChoice,class:V.a.endEpisode},"»"):Object(v.h)("a",{href:"#",onClick:this.makeChoice,class:V.a.choice},e.choice)},e}(v.Component),L=F,j=n("HwNa"),D=n.n(j),R="[абвгдеёжзийклмнопрстуфхцчшщъыьэюя]",G="[аеёиоуыэюя]",B="[бвгджзклмнпрстфхцчшщ]",M="­",W=new RegExp('([йъь])("'+R+R+")","ig"),H=new RegExp("("+G+")("+G+R+")","ig"),J=new RegExp("("+G+B+")("+B+G+")","ig"),q=new RegExp("("+B+G+")("+B+G+")","ig"),K=new RegExp("("+G+B+")("+B+B+G+")","ig"),$=new RegExp("("+G+B+B+")("+B+B+G+")","ig"),U=a,X=function(t){var e=t.hyphens,n=t.text;return Object(v.h)("div",{class:[D.a.paragraph,e?"justified":""].join(" ")},n.map(function(t){return Object(v.h)("p",{class:0===t.indexOf("<")?"":"indented",dangerouslySetInnerHTML:{__html:e?U(t):t}})}))},Y=Object(_.connect)("hyphens")(X),Z=n("GedZ"),Q=n.n(Z),z=["-46","-43","-40","-36","-33","-29","-25","-21","-18","-14","-10","-7","-3","0","4","8","12","16","19","23","27","31","34","38","42","46"],tt=function(t){var e=t.display;return Object(v.h)("div",{class:D.a.paragraph},Object(v.h)("div",{class:Q.a.voltmeter},Object(v.h)("div",{class:Q.a.arrow,style:{transform:"rotate("+z[parseInt(e[1],10)]+"deg)"}})),Object(v.h)("p",{class:"indented",dangerouslySetInnerHTML:{__html:e[2]}}))},et=tt,nt=n("hAVL"),it=n.n(nt),rt=Object(v.h)("svg",{style:"height: 24px; width: 24px;",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},Object(v.h)("g",{class:"",style:"touch-action: none;",transform:"translate(0,0)"},Object(v.h)("path",{d:"M275.5 96l-96 96h-96v128h96l96 96V96zm51.46 27.668l-4.66 17.387c52.066 13.95 88.2 61.04 88.2 114.945 0 53.904-36.134 100.994-88.2 114.945l4.66 17.387C386.81 372.295 428.5 317.962 428.5 256c0-61.963-41.69-116.295-101.54-132.332zm-12.425 46.365l-4.658 17.387C340.96 195.748 362.5 223.822 362.5 256s-21.54 60.252-52.623 68.58l4.658 17.387C353.402 331.552 380.5 296.237 380.5 256c0-40.238-27.098-75.552-65.965-85.967zm-12.424 46.363l-4.657 17.387C307.55 236.49 314.5 245.547 314.5 256s-6.95 19.51-17.047 22.217l4.658 17.387c17.884-4.792 30.39-21.09 30.39-39.604 0-18.513-12.506-34.812-30.39-39.604z",fill:"#000000","fill-opacity":"1"}))),at=Object(v.h)("svg",{style:"height: 24px; width: 24px;",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},Object(v.h)("g",{class:"",style:"touch-action: none;",transform:"translate(0,0)"},Object(v.h)("path",{d:"M275.5 96l-96 96h-96v128h96l96 96V96zm50.863 89.637l-12.726 12.726L371.273 256l-57.636 57.637 12.726 12.726L384 268.727l57.637 57.636 12.726-12.726L396.727 256l57.636-57.637-12.726-12.726L384 243.273l-57.637-57.636z",fill:"#000000","fill-opacity":"1"}))),ot=function(t){function e(){return o(this,e),s(this,t.apply(this,arguments))}return u(e,t),e.prototype.componentDidUpdate=function(){O.mute(!this.props.sound)},e.prototype.render=function(t){var e=t.sound,n=t.setSound;return Object(v.h)("div",{class:it.a.sound,onClick:n},e?rt:at)},e}(v.Component),st=Object(_.connect)("sound",m.a)(ot),ut=Object(v.h)(st,null),lt=function(t){function e(){return l(this,e),c(this,t.apply(this,arguments))}return h(e,t),e.prototype.componentDidUpdate=function(){this.scroller&&(this.scroller.scrollTop=this.scroller.scrollHeight)},e.prototype.render=function(t){var e=this,n=t.episode,i=t.scene,r=t.makeChoice;return Object(v.h)("div",{class:I.a.scroller},Object(v.h)("div",{id:"episode",class:I.a.episode,ref:function(t){return e.scroller=t}},Object(v.h)("div",{class:I.a.paragraphWrapper},n.map(function(t){return Object(v.h)(Y,{text:t.text})})),Object(v.h)("div",{class:I.a.currentScene},i.choices.length>0?Object(v.h)("div",{class:I.a.dasher}):"",0===i.text[0].indexOf("VOLTMETER")?Object(v.h)(et,{display:i.text}):Object(v.h)(Y,{text:i.text})),Object(v.h)("div",{class:I.a.choiceWrapper,ref:function(t){return e.currentChoices=t}},i.choices.map(function(t){return Object(v.h)(L,{option:t,makeChoice:r})}))),ut)},e}(v.Component),ct=lt,ht=function(t){function e(){var n,i,r;f(this,e);for(var a=arguments.length,o=Array(a),s=0;s<a;s++)o[s]=arguments[s];return n=i=d(this,t.call.apply(t,[this].concat(o))),i.makeChoice=function(t){E.makeChoice(t).then(i.renderScene),E.saveGame()},i.renderScene=function(){E.renderScene(),i.props.gameState(E.gameState)},r=n,d(i,r)}return p(e,t),e.prototype.componentWillMount=function(){E.initGame().then(this.renderScene)},e.prototype.componentDidUpdate=function(){0===this.props.scene.choices.length&&E.clearSavedGame()},e.prototype.render=function(t){var e=t.scene,n=t.episode;return e?Object(v.h)(ct,{scene:e,episode:n,makeChoice:this.makeChoice}):""},e}(v.Component);e.default=Object(_.connect)("scene,episode",m.a)(ht)},GedZ:function(t){t.exports={voltmeter:"voltmeter__39rFT",arrow:"arrow__1Ou5n"}},HwNa:function(t){t.exports={paragraph:"paragraph__KzOCG"}},ZYns:function(t){var e=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t};!function(e,n){t.exports=n()}("undefined"!=typeof self&&self,function(){return function(t){function e(i){if(n[i])return n[i].exports;var r=n[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,e),r.l=!0,r.exports}var n={};return e.m=t,e.c=n,e.d=function(t,n,i){e.o(t,n)||Object.defineProperty(t,n,{enumerable:!0,get:i})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,n){if(1&n&&(t=e(t)),8&n)return t;if(4&n&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(e.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&n&&"string"!=typeof t)for(var r in t)e.d(i,r,function(e){return t[e]}.bind(null,r));return i},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="/",e(e.s=0)}([function(t,e,n){t.exports=n(1)},function(t,e,n){"use strict";function i(t){return t&&t.__esModule?t:{default:t}}function r(t){return new Promise(function(){throw new Error(t+" is not implemented")})}var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),o=i(n(2)),s=i(n(6)),u=i(n(7)),l=i(n(8));t.exports=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.game=e,this.events={loadStory:function(){return r("loadStory")},loadGame:function(){return r("loadGame")},saveGame:function(){return r("saveGame")},error:function(){return r("error")}},this.inkObservers=new u.default,this.inkFunctions=new l.default,this.inkCommands={},this.episode={},this.command={},this.transcript=[]}return a(t,[{key:"startGame",value:function(){var t=this;return this.loadEpisode(this.game.episodes[0]).then(function(){t.episode.reset()})}},{key:"loadGame",value:function(t){var e=this,n={};return this.dispatch("loadGame",t).then(function(t){return n=JSON.parse(t),e.loadEpisode(n.episode.filename)}).then(function(){e.episode.restoreState(n.episode)})}},{key:"saveGame",value:function(t){return this.dispatch("saveGame",{id:t,data:this.getGameState()})}},{key:"renderScene",value:function(){var t=this.episode.renderScene(this.command);return this.game.transcript&&this.transcript.push(t),t}},{key:"getCurrentEpisode",value:function(){return this.episode.content}},{key:"getCurrentScene",value:function(){return this.episode.getCurrentScene()}},{key:"getTranscript",value:function(){return this.transcript}},{key:"makeChoice",value:function(t){var e=this;return new Promise(function(n,i){try{e.game.transcript&&(e.transcript[e.transcript.length-1].chosen=t),e.episode.makeChoice(t)}catch(t){e.dispatch("error",t),i(t)}n()})}},{key:"loadEpisode",value:function(t){var e=this;return this.dispatch("loadStory",t).then(function(n){var i=n;if("string"==typeof n){var r=n.replace("\ufeff","");i=JSON.parse(r)}e.initEpisode(t,i)})}},{key:"initEpisode",value:function(t,e){var n=this;this.episode=new o.default(t,e,this.inkObservers,this.inkFunctions),this.command=new s.default({episode:this.episode,story:this.episode.story}),Object.keys(this.inkCommands).forEach(function(t){var e=n.inkCommands[t];n.command.register(t,e.callback,e.deps)})}},{key:"getGameState",value:function(){return{episode:this.episode.getState()}}},{key:"on",value:function(t,e){this.events[t]=e}},{key:"dispatch",value:function(t,e){return this.events[t](e)}},{key:"registerFunctions",value:function(t){this.inkFunctions.register(t)}},{key:"registerObservers",value:function(t){this.inkObservers.register(t)}},{key:"registerCommand",value:function(t,e,n){this.inkCommands[t]={callback:e,deps:n}}},{key:"debug",value:function(){return this.episode.story.state}}]),t}()},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=function(t){return t&&t.__esModule?t:{default:t}}(n(3));e.default=function(){function t(e,n,i,a){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.id=e,this.$episode=[],this.$story=new r.default(n),this.sceneId=-1,i.attach(this.$story),a.attach(this.$story)}return i(t,[{key:"reset",value:function(){this.$episode.splice(0),this.sceneId=-1}},{key:"renderScene",value:function(t){return this.updateEpisode(this.$story.getScene(t))}},{key:"getCurrentScene",value:function(){return this.$episode[this.$episode.length-1]}},{key:"makeChoice",value:function(t){this.$story.makeChoice(t)}},{key:"updateEpisode",value:function(t){return this.sceneId>=0&&(this.$episode[this.sceneId].isActive=!1),this.sceneId+=1,t.isActive=!0,t.id=this.sceneId,this.$episode.push(t),t}},{key:"getState",value:function(){return{filename:this.id,episode:this.$episode,story:JSON.parse(this.$story.saveState())}}},{key:"restoreState",value:function(t){this.id=t.filename,this.$episode=t.episode,this.$story.loadState(JSON.stringify(t.story))}},{key:"story",get:function(){return this.$story}},{key:"content",get:function(){return this.$episode}}]),t}()},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=n(4),a=function(t){return t&&t.__esModule?t:{default:t}}(n(5));e.default=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.story=new r.Story(e)}return i(t,[{key:"getScene",value:function(t){return(0,a.default)(this.story,t)}},{key:"makeChoice",value:function(t){this.story.ChooseChoiceIndex(t)}},{key:"saveState",value:function(){return this.story.state.toJson()}},{key:"loadState",value:function(t){this.story.state.LoadJson(t)}},{key:"globalTags",value:function(){return this.story.globalTags}},{key:"tagsForKnot",value:function(t){return this.story.TagsForContentAtPath(t)}},{key:"goTo",value:function(t){this.story.ChoosePathString(t)}},{key:"getVar",value:function(t){return this.story.variablesState[t]}},{key:"getVars",value:function(){var t=this.story.variablesState,e={};return Object.keys(t._globalVariables).forEach(function(n){e[n]=t[n]}),e}},{key:"setVar",value:function(t,e){this.story.variablesState[t]=e}},{key:"setVars",value:function(t){var e=this;Object.keys(t).forEach(function(n){e.story.variablesState[n]=t[n]})}},{key:"getVisitCount",value:function(t){this.story.state.VisitCountAtPathString(t)}},{key:"observeVar",value:function(t,e){this.story.ObserveVariable(t,e)}},{key:"bindFunction",value:function(t,e){this.story.BindExternalFunction(t,e)}},{key:"state",get:function(){return this.story.state}}]),t}()},function(t,n){"use strict";function r(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var s,u,l,c=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};!function(e,i){"object"===h(n)&&void 0!==t?i(n):(u=[n],void 0===(l="function"==typeof(s=i)?s.apply(n,u):s)||(t.exports=l))}(0,function(t){var n=function(){function t(){o(this,t),this._components=[],this._componentsString=null,"string"==typeof arguments[0]?this.componentsString=arguments[0]:arguments[0]instanceof s&&arguments[1]instanceof t?(this._components.push(arguments[0]),this._components=this._components.concat(arguments[1]._components)):arguments[0]instanceof Array&&(this._components=this._components.concat(arguments[0]),this._isRelative=!!arguments[1])}return c(t,[{key:"GetComponent",value:function(t){return this._components[t]}},{key:"PathByAppendingPath",value:function(e){for(var n=new t,i=0,r=0;r<e._components.length&&e._components[r].isParent;++r)i++;for(r=0;r<this._components.length-i;++r)n._components.push(this._components[r]);for(r=i;r<e._components.length;++r)n._components.push(e._components[r]);return n}},{key:"toString",value:function(){return this.componentsString}},{key:"Equals",value:function(t){if(null==t)return!1;if(t._components.length!=this._components.length)return!1;if(t.isRelative!=this.isRelative)return!1;for(var e=0,n=t._components.length;e<n;e++)if(!t._components[e].Equals(this._components[e]))return!1;return!0}},{key:"PathByAppendingComponent",value:function(e){var n=new t;return n._components.push.apply(n._components,this._components),n._components.push(e),n}},{key:"isRelative",get:function(){return this._isRelative}},{key:"componentCount",get:function(){return this._components.length}},{key:"head",get:function(){return this._components.length>0?this._components[0]:null}},{key:"tail",get:function(){return this._components.length>=2?new t(this._components.slice(1,this._components.length)):t.self}},{key:"length",get:function(){return this._components.length}},{key:"lastComponent",get:function(){var t=this._components.length-1;return t>=0?this._components[t]:null}},{key:"containsNamedComponent",get:function(){for(var t=0,e=this.components.length;t<e;t++)if(!this.components[t].isIndex)return!0;return!1}},{key:"componentsString",get:function(){return null==this._componentsString&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString},set:function(t){var e=this;this._components.length=0,null!=(this._componentsString=t)&&""!=this._componentsString&&("."==this._componentsString[0]&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1)),this._componentsString.split(".").forEach(function(t){e._components.push(/^(\-|\+)?([0-9]+|Infinity)$/.test(t)?new s(parseInt(t)):new s(t))}))}}],[{key:"self",get:function(){var e=new t;return e._isRelative=!0,e}}]),t}(),s=function(){function t(e){o(this,t),"string"==typeof e?(this._index=-1,this._name=e):(this._index=parseInt(e),this._name=null)}return c(t,[{key:"toString",value:function(){return this.isIndex?this.index.toString():this.name}},{key:"Equals",value:function(t){return null!=t&&t.isIndex==this.isIndex&&(this.isIndex?this.index==t.index:this.name==t.name)}},{key:"index",get:function(){return this._index}},{key:"name",get:function(){return this._name}},{key:"isIndex",get:function(){return this.index>=0}},{key:"isParent",get:function(){return this.name==n.parentId}}],[{key:"ToParent",value:function(){return new t(n.parentId)}}]),t}();n.parentId="^",n.Component=s;var u=function(){function t(){o(this,t),this.parent=null,this._path=null}return c(t,[{key:"ResolvePath",value:function(t){if(t.isRelative){var e=this;return e instanceof w==0&&(null==this.parent&&console.warn("Can't resolve relative path because we don't have a parent"),"Container"!==(e=this.parent).constructor.name&&console.warn("Expected parent to be a container"),t=t.tail),e.ContentAtPath(t)}return this.rootContentContainer.ContentAtPath(t)}},{key:"ConvertPathToRelative",value:function(t){for(var e=this.path,i=Math.min(t.componentCount,e.componentCount),r=-1,a=0;a<i;++a){if(!e.GetComponent(a).Equals(t.GetComponent(a)))break;r=a}if(-1==r)return t;for(var o=e.componentCount-1-r,s=[],u=0;u<o;++u)s.push(n.Component.ToParent());for(var l=r+1;l<t.componentCount;++l)s.push(t.GetComponent(l));return new n(s,!0)}},{key:"CompactPathString",value:function(t){var e=null,n=null;return t.isRelative?(n=t.componentsString,e=this.path.PathByAppendingPath(t).componentsString):(n=this.ConvertPathToRelative(t).componentsString,e=t.componentsString),n.length<e.length?n:e}},{key:"Copy",value:function(){throw"Not Implemented"}},{key:"SetChild",value:function(t,e,n){t[e]&&(t[e]=null),(t[e]=n)&&(t[e].parent=this)}},{key:"path",get:function(){if(null==this._path)if(null==this.parent)this._path=new n;else{for(var t=[],e=this,i=e.parent;i instanceof w;){var r=e;t.unshift(r.name&&r.hasValidName?new n.Component(r.name):new n.Component(i.content.indexOf(e))),e=i,i=i.parent}this._path=new n(t)}return this._path}},{key:"rootContentContainer",get:function(){for(var t=this;t.parent;)t=t.parent;return t}}]),t}(),l=function(){function t(e){o(this,t),e=void 0!==e?e.toString():"",this._string=e}return c(t,[{key:"Append",value:function(t){this._string+=t}},{key:"AppendLine",value:function(t){void 0!==t&&this.Append(t),this._string+="\n"}},{key:"AppendFormat",value:function(t){var e=Array.prototype.slice.call(arguments,1);this._string+=t.replace(/{(\d+)}/g,function(t,n){return void 0!==e[n]?e[n]:t})}},{key:"toString",value:function(){return this._string}},{key:"Length",get:function(){return this._string.length}}]),t}(),f=function(){function t(e,n){if(o(this,t),void 0!==n)this.originName=e,this.itemName=n;else{var i=e.toString().split(".");this.originName=i[0],this.itemName=i[1]}}return c(t,[{key:"isNull",value:function(){return null==this.originName&&null==this.itemName}},{key:"toString",value:function(){return this.fullname}},{key:"Equals",value:function(e){if(e instanceof t){var n=e;return n.itemName==this.itemName&&n.originName==this.originName}return!1}},{key:"toString",value:function(){var t="0",e=this.itemName?this.itemName.toString():"null";return null!=this.originName&&(t=this.originName.toString()),t+"."+e}},{key:"fullName",get:function(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}}],[{key:"Null",value:function(){return new t(null,null)}}]),t}(),d=function(){function t(e,n){var i=this;if(o(this,t),this._keys={},this._values={},this.origins=null,this._originNames=null,e)if(e instanceof t){var r=e;r.forEach(function(t){i.Add(t.Key,t.Value)}),this._originNames=r._originNames}else if("string"==typeof e){this.SetInitialOriginName(e);var a=null;if(!(a=n.listDefinitions.TryGetListDefinition(e,a)))throw new Error("InkList origin could not be found in story when constructing new list: "+singleOriginListName);this.origins=[a]}else if(e.hasOwnProperty("Key")&&e.hasOwnProperty("Value")){var s=e;this.Add(s.Key,s.Value)}}return c(t,[{key:"forEach",value:function(t){for(var e in this._values)t({Key:this._keys[e],Value:this._values[e]})}},{key:"AddItem",value:function(t){var e=this;if(t instanceof f){if(null==(r=t).originName)return void this.AddItem(r.itemName);throw this.origins.forEach(function(t){if(t.name==r.originName){var n;if(void 0!==(n=t.TryGetValueForItem(r,n)))return void e.Add(r,n);throw"Could not add the item "+r+" to this list because it doesn't exist in the original list definition in ink."}}),"Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found."}var n=t,i=null;if(this.origins.forEach(function(t){if(t.ContainsItemWithName(n)){if(null!=i)throw"Could not add the item "+n+" to this list because it could come from either "+t.name+" or "+i.name;i=t}}),null==i)throw"Could not add the item "+n+" to this list because it isn't known to any list definitions previously associated with this list.";var r=new f(i.name,n),a=i.ValueForItem(r);this.Add(r,a)}},{key:"ContainsItemNamed",value:function(t){var e=!1;return this.forEach(function(n){n.Key.itemName==t&&(e=!0)}),e}},{key:"ContainsKey",value:function(t){return t in this._values}},{key:"Add",value:function(t,e){this._keys[t]=t,this._values[t]=e}},{key:"Remove",value:function(t){delete this._values[t],delete this._keys[t]}},{key:"SetInitialOriginName",value:function(t){this._originNames=[t]}},{key:"SetInitialOriginNames",value:function(t){this._originNames=null==t?null:t.slice()}},{key:"Union",value:function(e){var n=new t(this);return e.forEach(function(t){n.Add(t.Key,t.Value)}),n}},{key:"Intersect",value:function(e){var n=new t;return this.forEach(function(t){e.ContainsKey(t.Key)&&n.Add(t.Key,t.Value)}),n}},{key:"Without",value:function(e){var n=new t(this);return e.forEach(function(t){n.Remove(t.Key)}),n}},{key:"Contains",value:function(t){var e=this,n=!0;return t.forEach(function(t){e.ContainsKey(t.Key)||(n=!1)}),n}},{key:"GreaterThan",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>t.maxItem.Value)}},{key:"GreaterThanOrEquals",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>=t.minItem.Value&&this.maxItem.Value>=t.maxItem.Value)}},{key:"LessThan",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<t.minItem.Value)}},{key:"LessThanOrEquals",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}},{key:"MaxAsList",value:function(){return this.Count>0?new t(this.maxItem):new t}},{key:"MinAsList",value:function(){return this.Count>0?new t(this.minItem):new t}},{key:"Equals",value:function(e){var n=e;if(n instanceof t==0)return!1;if(n.Count!=this.Count)return!1;var i=!0;return this.forEach(function(t){n.ContainsKey(t.Key)||(i=!1)}),i}},{key:"toString",value:function(){var t=[];this.forEach(function(e){t.push(e)}),t=t.sort(function(t,e){return t.Value===e.Value?0:t.Value>e.Value?1:-1});for(var e=new l,n=0;n<t.length;n++){n>0&&e.Append(", ");e.Append(t[n].Key.itemName)}return e.toString()}},{key:"valueOf",value:function(){return NaN}},{key:"Count",get:function(){return Object.keys(this._values).length}},{key:"originOfMaxItem",get:function(){if(null==this.origins)return null;var t=this.maxItem.Key.originName,e=null;return this.origins.every(function(n){return n.name!=t||(e=n,!1)}),e}},{key:"originNames",get:function(){var t=this;return this.Count>0&&(null==this._originNames&&this.Count>0?this._originNames=[]:this._originNames.length=0,this.forEach(function(e){t._originNames.push(e.Key.originName)})),this._originNames}},{key:"maxItem",get:function(){var t={Key:null,Value:null};return this.forEach(function(e){(null===t.Key||e.Value>t.Value)&&(t=e)}),t}},{key:"minItem",get:function(){var t={Key:null,Value:null};return this.forEach(function(e){(null===t.Key||e.Value<t.Value)&&(t=e)}),t}},{key:"inverse",get:function(){var e=this,n=new t;return null!=this.origins&&this.origins.forEach(function(t){t.items.forEach(function(t){e.ContainsKey(t.Key)||n.Add(t.Key,t.Value)})}),n}},{key:"all",get:function(){var e=new t;return null!=this.origins&&this.origins.forEach(function(t){t.items.forEach(function(t){e.Add(t.Key,t.Value)})}),e}}]),t}(),p=function(){function t(e){o(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.useEndLineNumber=!1,n.message=e,n.name="StoryException",n}return a(t,Error),t}(),v={Int:0,Float:1,List:2,String:3,DivertTarget:4,VariablePointer:5},_=function(){function t(){o(this,t);var e=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e}return a(t,u),c(t,[{key:"Cast",value:function(){throw"Trying to casting an AbstractValue"}},{key:"Copy",value:function(e){return t.Create(e)}},{key:"BadCastException",value:function(t){return new p("Can't cast "+this.valueObject+" from "+this.valueType+" to "+t)}},{key:"valueType",get:function(){return this._valueType}},{key:"isTruthy",get:function(){return this._isTruthy}},{key:"valueObject",get:function(){return this._valueObject}}],[{key:"Create",value:function(t){return"boolean"==typeof t&&(t=t?1:0),Number.isInteger(Number(t))?new y(t):isNaN(t)?"string"==typeof t?new b(t):t instanceof n?new k(t):t instanceof d?new C(t):null:new g(t)}}]),t}(),m=function(){function t(e){o(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.value=e,n}return a(t,_),c(t,[{key:"toString",value:function(){return this.value.toString()}},{key:"value",get:function(){return this._value},set:function(t){this._value=t}},{key:"valueObject",get:function(){return this.value}}]),t}(),y=function(){function t(e){o(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e||0));return n._valueType=v.Int,n}return a(t,m),c(t,[{key:"Cast",value:function(t){if(t==this.valueType)return this;if(t==v.Float)return new g(parseFloat(this.value));if(t==v.String)return new b(""+this.value);throw this.BadCastException(t)}},{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return v.Int}}]),t}(),g=function(){function t(e){o(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e||0));return n._valueType=v.Float,n}return a(t,m),c(t,[{key:"Cast",value:function(t){if(t==this.valueType)return this;if(t==v.Int)return new y(parseInt(this.value));if(t==v.String)return new b(""+this.value);throw this.BadCastException(t)}},{key:"isTruthy",get:function(){return 0!=this._value}},{key:"valueType",get:function(){return v.Float}}]),t}(),b=function(){function t(e){o(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e||""));return n._valueType=v.String,n._isNewline="\n"==n.value,n._isInlineWhitespace=!0,n.value.split().every(function(t){return" "==t||"\t"==t||(n._isInlineWhitespace=!1,!1)}),n}return a(t,m),c(t,[{key:"Cast",value:function(t){function e(){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}(function(t){if(t==this.valueType)return this;var e,n;if(t==v.Int)return(e=parseInt(value))?new y(e):null;if(t==v.Float)return(n=n(value))?new g(n):null;throw this.BadCastException(t)})},{key:"valueType",get:function(){return v.String}},{key:"isTruthy",get:function(){return this.value.length>0}},{key:"isNewline",get:function(){return this._isNewline}},{key:"isInlineWhitespace",get:function(){return this._isInlineWhitespace}},{key:"isNonWhitespace",get:function(){return!this.isNewline&&!this.isInlineWhitespace}}]),t}(),k=function(){function t(e){o(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n._valueType=v.DivertTarget,n}return a(t,m),c(t,[{key:"Cast",value:function(t){if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"toString",value:function(){return"DivertTargetValue("+this.targetPath+")"}},{key:"targetPath",get:function(){return this.value},set:function(t){this.value=t}},{key:"isTruthy",get:function(){throw"Shouldn't be checking the truthiness of a divert target"}}]),t}(),S=function(){function t(e,n){o(this,t);var i=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i._valueType=v.VariablePointer,i.contextIndex=void 0!==n?n:-1,i}return a(t,m),c(t,[{key:"Cast",value:function(t){if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"toString",value:function(){return"VariablePointerValue("+this.variableName+")"}},{key:"Copy",value:function(){return new t(this.variableName,this.contextIndex)}},{key:"variableName",get:function(){return this.value},set:function(t){this.value=t}},{key:"isTruthy",get:function(){throw"Shouldn't be checking the truthiness of a variable pointer"}}]),t}(),C=function(){function t(e,n){o(this,t);var i=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,null));return i._valueType=v.List,i.value=e instanceof d?new d(e):void 0!==e&&void 0!==n?new d({Key:e,Value:n}):new d,i}return a(t,m),c(t,[{key:"Cast",value:function(t){function e(){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}(function(t){var e;if(t==v.Int)return new y((e=this.value.maxItem).Key.isNull?0:e.Value);if(t==v.Float)return new g((e=this.value.maxItem).Key.isNull?0:parseFloat(e.Value));if(t==v.String)return new b((e=value.maxItem).Key.isNull?"":e.Key.toString());if(t==this.valueType)return this;throw this.BadCastException(t)})},{key:"valueType",get:function(){return v.List}},{key:"isTruthy",get:function(){var t=!1;return this.value.forEach(function(e){0!=e.Value&&(t=!0)}),t}}]),c(t,null,[{key:"RetainListOriginsForAssignment",value:function(e,n){var i=e,r=n;i instanceof t&&r instanceof t&&0==r.value.Count&&r.value.SetInitialOriginNames(i.value.originNames)}}]),t}(),T=function(){function t(){o(this,t)}return c(t,[{key:"copy",value:function(){var e=new t;return e.obj=this.obj,e.approximate=this.approximate,e}},{key:"correctObj",get:function(){return this.approximate?null:this.obj}},{key:"container",get:function(){return this.obj instanceof w?this.obj:null}}]),t}(),w=function(){function t(){o(this,t);var e=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.name="",e._content=[],e.namedContent={},e.visitsShouldBeCounted=!1,e.turnIndexShouldBeCounted=!1,e.countingAtStartOnly=!1,e.CountFlags={Visits:1,Turns:2,CountStartOnly:4},e._pathToFirstLeafContent=null,e}return a(t,u),c(t,[{key:"AddContent",value:function(t){var e=this;if(t instanceof Array)t.forEach(function(t){e.AddContent(t)});else{if(this._content.push(t),t.parent)throw"content is already in "+t.parent;t.parent=this,this.TryAddNamedContent(t)}}},{key:"TryAddNamedContent",value:function(t){t.hasValidName&&t.name&&this.AddToNamedContentOnly(t)}},{key:"AddToNamedContentOnly",value:function(t){t instanceof u==0&&console.warn("Can only add Runtime.Objects to a Runtime.Container"),t.parent=this,this.namedContent[t.name]=t}},{key:"ContentAtPath",value:function(e,n,i){n=void 0!==n?n:0,i=void 0!==i?i:e.length;var r=new T;r.approximate=!1;for(var a=this,o=this,s=n;s<i;++s){var u=e.GetComponent(s);if(null==a){r.approximate=!0;break}var l=a.ContentWithPathComponent(u);if(null==l){r.approximate=!0;break}o=l,a=l instanceof t?l:null}return r.obj=o,r}},{key:"InsertContent",value:function(t){if(this.content[i]=t,t.parent)throw"content is already in "+t.parent;t.parent=this,this.TryAddNamedContent(t)}},{key:"AddContentsOfContainer",value:function(t){var e=this;this.content=this.content.concat(t.content),t.content.forEach(function(t){t.parent=e,e.TryAddNamedContent(t)})}},{key:"ContentWithPathComponent",value:function(t){if(t.isIndex)return t.index>=0&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;var e;return(e=this.namedContent[t.name])?e:null}},{key:"BuildStringOfHierarchy",value:function(e,n,i){function r(){for(var t=0;t<4*n;++t)e.Append(" ")}if(0==arguments.length)return e=new l,this.BuildStringOfHierarchy(e,0,null),e.toString();r(),e.Append("["),this.hasValidName&&e.AppendFormat(" ({0})",this.name),this==i&&e.Append("  <---"),e.AppendLine(),n++;for(var a=0;a<this.content.length;++a){var o=this.content[a];o instanceof t?o.BuildStringOfHierarchy(e,n,i):(r(),o instanceof b?(e.Append('"'),e.Append(o.toString().replace("\n","\\n")),e.Append('"')):e.Append(o.toString())),a!=this.content.length-1&&e.Append(","),o instanceof t||o!=i||e.Append("  <---"),e.AppendLine()}var s={};for(var u in this.namedContent)this.content.indexOf(this.namedContent[u])>=0||(s[u]=this.namedContent[u]);if(Object.keys(s).length>0)for(var u in r(),e.AppendLine("-- named: --"),s)s[u]instanceof t||console.warn("Can only print out named Containers"),s[u].BuildStringOfHierarchy(e,n,i),e.Append("\n");n--,r(),e.Append("]")}},{key:"hasValidName",get:function(){return null!=this.name&&this.name.length>0}},{key:"content",get:function(){return this._content},set:function(t){this.AddContent(t)}},{key:"namedOnlyContent",get:function(){var t={};for(var e in this.namedContent)t[e]=this.namedContent[e];return this.content.forEach(function(e){var n=e;n.name&&n.hasValidName&&delete t[n.name]}),0==Object.keys(t).length&&(t=null),t},set:function(t){var e=this.namedOnlyContent;if(null!=e)for(var n in e)delete this.namedContent[n];if(null!=t)for(var n in t){var i=t[n];i.name&&void 0!==i.hasValidName&&this.AddToNamedContentOnly(i)}}},{key:"countFlags",get:function(){var t=0;return this.visitsShouldBeCounted&&(t|=this.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=this.CountFlags.Turns),this.countingAtStartOnly&&(t|=this.CountFlags.CountStartOnly),t==this.CountFlags.CountStartOnly&&(t=0),t},set:function(t){var e=t;(e&this.CountFlags.Visits)>0&&(this.visitsShouldBeCounted=!0),(e&this.CountFlags.Turns)>0&&(this.turnIndexShouldBeCounted=!0),(e&this.CountFlags.CountStartOnly)>0&&(this.countingAtStartOnly=!0)}},{key:"pathToFirstLeafContent",get:function(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}},{key:"internalPathToFirstLeafContent",get:function(){for(var e=[],n=this;n instanceof t;)n.content.length>0&&(e.push(new Path.Component(0)),n=n.content[0]);return new Path(e)}}]),t}(),O=function(){function t(){return o(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return a(t,u),c(t,[{key:"toString",value:function(){return"Glue"}}]),t}(),A=function(){function t(e){o(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n._commandType=void 0!==e?e:x.NotSet,n}return a(t,u),c(t,[{key:"copy",value:function(){return new t(this.commandType)}},{key:"toString",value:function(){return this.commandType.toString()}},{key:"commandType",get:function(){return this._commandType}}],[{key:"EvalStart",value:function(){return new t(x.EvalStart)}},{key:"EvalOutput",value:function(){return new t(x.EvalOutput)}},{key:"EvalEnd",value:function(){return new t(x.EvalEnd)}},{key:"Duplicate",value:function(){return new t(x.Duplicate)}},{key:"PopEvaluatedValue",value:function(){return new t(x.PopEvaluatedValue)}},{key:"PopFunction",value:function(){return new t(x.PopFunction)}},{key:"PopTunnel",value:function(){return new t(x.PopTunnel)}},{key:"BeginString",value:function(){return new t(x.BeginString)}},{key:"EndString",value:function(){return new t(x.EndString)}},{key:"NoOp",value:function(){return new t(x.NoOp)}},{key:"ChoiceCount",value:function(){return new t(x.ChoiceCount)}},{key:"TurnsSince",value:function(){return new t(x.TurnsSince)}},{key:"ReadCount",value:function(){return new t(x.ReadCount)}},{key:"Random",value:function(){return new t(x.Random)}},{key:"SeedRandom",value:function(){return new t(x.SeedRandom)}},{key:"VisitIndex",value:function(){return new t(x.VisitIndex)}},{key:"SequenceShuffleIndex",value:function(){return new t(x.SequenceShuffleIndex)}},{key:"StartThread",value:function(){return new t(x.StartThread)}},{key:"Done",value:function(){return new t(x.Done)}},{key:"End",value:function(){return new t(x.End)}},{key:"ListFromInt",value:function(){return new t(x.ListFromInt)}},{key:"ListRange",value:function(){return new t(x.ListRange)}}]),t}(),x={NotSet:-1,EvalStart:0,EvalOutput:1,EvalEnd:2,Duplicate:3,PopEvaluatedValue:4,PopFunction:5,PopTunnel:6,BeginString:7,EndString:8,NoOp:9,ChoiceCount:10,TurnsSince:11,Random:12,SeedRandom:13,VisitIndex:14,SequenceShuffleIndex:15,StartThread:16,Done:17,End:18,ListFromInt:19,ListRange:20,ReadCount:21};x.TOTAL_VALUES=Object.keys(x).length-1,A.CommandType=x;var E={Tunnel:0,Function:1,FunctionEvaluationFromGame:2},P=function(){function t(e,n){o(this,t),this.container=e,this.index=n}return c(t,[{key:"Resolve",value:function(){return this.index<0?this.container:null==this.container?null:0==this.container.content.length?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}},{key:"toString",value:function(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}},{key:"copy",value:function(){return new t(this.container,this.index)}},{key:"isNull",get:function(){return null==this.container}},{key:"path",get:function(){return this.isNull?null:this.index>=0?this.container.path.PathByAppendingComponent(new n.Component(this.index)):this.container.path}}],[{key:"StartOf",value:function(e){return new t(e,0)}},{key:"Null",get:function(){return new t(null,-1)}}]),t}(),I=function(){function t(e){o(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.pushesToStack=!1,e&&(n.pushesToStack=!0,n.stackPushType=e),n}return a(t,u),c(t,[{key:"Equals",value:function(e){var n=e;return n instanceof t&&this.hasVariableTarget==n.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==n.variableDivertName:this.targetPath.Equals(n.targetPath))}},{key:"toString",value:function(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";var t=new l,e=this.targetPath.toString();return t.Append("Divert"),this.isConditional&&t.Append("?"),this.pushesToStack&&t.Append(this.stackPushType==E.Function?" function":" tunnel"),t.Append(" -> "),t.Append(this.targetPathString),t.Append(" ("),t.Append(e),t.Append(")"),t.toString()}},{key:"targetPath",get:function(){if(null!=this._targetPath&&this._targetPath.isRelative){var t=this.targetPointer.Resolve();t&&(this._targetPath=t.path)}return this._targetPath},set:function(t){this._targetPath=t,this._targetPointer=P.Null}},{key:"targetPointer",get:function(){if(this._targetPointer.isNull){var t=this.ResolvePath(this._targetPath).obj;this._targetPath.lastComponent.isIndex?(this._targetPointer.container=t.parent instanceof w?t.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index):this._targetPointer=P.StartOf(t instanceof w?t:null)}return this._targetPointer.copy()}},{key:"targetPathString",get:function(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)},set:function(t){this.targetPath=null==t?null:new n(t)}},{key:"hasVariableTarget",get:function(){return null!=this.variableDivertName}}]),t}(),N=function(){function t(e){o(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.onceOnly=!!e,n}return a(t,u),c(t,[{key:"toString",value:function(){return"Choice: -> "+this.pathOnChoice.toString()}},{key:"pathOnChoice",get:function(){if(null!=this._pathOnChoice&&this._pathOnChoice.isRelative){var t=this.choiceTarget;t&&(this._pathOnChoice=t.path)}return this._pathOnChoice},set:function(t){this._pathOnChoice=t}},{key:"choiceTarget",get:function(){return this.ResolvePath(this._pathOnChoice).container}},{key:"pathStringOnChoice",get:function(){return this.CompactPathString(this.pathOnChoice)},set:function(t){this.pathOnChoice=new n(t)}},{key:"flags",get:function(){var t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t},set:function(t){this.hasCondition=(1&t)>0,this.hasStartContent=(2&t)>0,this.hasChoiceOnlyContent=(4&t)>0,this.isInvisibleDefault=(8&t)>0,this.onceOnly=(16&t)>0}}]),t}(),V=function(){function t(e){o(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.name=e,n}return a(t,u),c(t,[{key:"toString",value:function(){return null!=this.name?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}},{key:"containerForCount",get:function(){return this.ResolvePath(this.pathForCount).container}},{key:"pathStringForCount",get:function(){return null==this.pathForCount?null:this.CompactPathString(this.pathForCount)},set:function(t){this.pathForCount=null==t?null:new n(t)}}]),t}(),F=function(){function t(e,n){o(this,t);var i=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i._variableName=e||null,i._isNewDeclaration=!!n,i}return a(t,u),c(t,[{key:"toString",value:function(){return"VarAssign to "+this.variableName}},{key:"variableName",get:function(){return this._variableName}},{key:"isNewDeclaration",get:function(){return this._isNewDeclaration}}]),t}(),L=function(){function t(){return o(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return a(t,u),t}(),j=function(){function t(e){o(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.name=e,n._operationFuncs=null,t.GenerateNativeFunctionsIfNecessary(),n}return a(t,u),c(t,[{key:"Call",value:function(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw"Unexpected number of parameters";var e=!1;if(t.forEach(function(t){if(t instanceof L)throw new p("Attempting to perform operation on a void value. Did you forget to 'return' a value from a function you called here?");t instanceof C&&(e=!0)}),2==t.length&&e)return this.CallBinaryListOperation(t);var n=this.CoerceValuesToSingleType(t),i=n[0].valueType;return i==v.Int?this.CallType(n):i==v.Float?this.CallType(n):i==v.String?this.CallType(n):i==v.DivertTarget?this.CallType(n):i==v.List?this.CallType(n):null}},{key:"CallType",value:function(t){var e=t[0],n=e.valueType,i=e,r=t.length;if(2==r||1==r){var a=this._operationFuncs[n];if(!a)throw new p("Cannot perform operation '"+this.name+"' on "+n);if(2==r){var o=t[1],s=a(i.value,o.value);return m.Create(s)}return s=a(i.value),m.Create(s)}throw"Unexpected number of parameters to NativeFunctionCall: "+t.length}},{key:"CallBinaryListOperation",value:function(t){if(("+"==this.name||"-"==this.name)&&t[0]instanceof C&&t[1]instanceof y)return this.CallListIncrementOperation(t);var e=t[0],n=t[1];if(!("&&"!=this.name&&"||"!=this.name||e.valueType==v.List&&n.valueType==v.List)){var i=(0,this._operationFuncs[v.Int])(e.isTruthy?1:0,n.isTruthy?1:0);return new y(i)}if(e.valueType==v.List&&n.valueType==v.List)return this.CallType([e,n]);throw new p("Can not call use '"+this.name+"' operation on "+e.valueType+" and "+n.valueType)}},{key:"CallListIncrementOperation",value:function(t){var e=this,n=t[0],i=t[1],r=new d;return n.value.forEach(function(t){var a=t.Key,o=t.Value,s=(0,e._operationFuncs[v.Int])(o,i.value),u=null;if(n.value.origins.forEach(function(t){if(t.name==a.originName)return u=t,!1}),null!=u){var l=u.TryGetItemWithValue(s);l.exists&&r.Add(l.item,s)}}),new C(r)}},{key:"CoerceValuesToSingleType",value:function(t){var e=v.Int,n=null;t.forEach(function(t){var i=t;i.valueType>e&&(e=i.valueType),i.valueType==v.List&&(n=i)});var i=[];return t.forEach(e==v.List?function(t){if(t.valueType==v.List)i.push(t);else{if(t.valueType!=v.Int)throw new p("Cannot mix Lists and "+t.valueType+" values in this operation");var e=parseInt(t.valueObject),r=n.value.originOfMaxItem,a=r.TryGetItemWithValue(e);if(!a.exists)throw new p("Could not find List item with the value "+e+" in "+r.name);var o=new C(a.item,e);i.push(o)}}:function(t){var n=t.Cast(e);i.push(n)}),i}},{key:"AddOpFuncForType",value:function(t,e){null==this._operationFuncs&&(this._operationFuncs={}),this._operationFuncs[t]=e}},{key:"toString",value:function(){return"Native '"+this.name+"'"}},{key:"name",get:function(){return this._name},set:function(e){this._name=e,this._isPrototype||(this._prototype=t._nativeFunctions[this._name])}},{key:"numberOfParameters",get:function(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters},set:function(t){this._numberOfParameters=t}}],[{key:"internalConstructor",value:function(e,n){var i=new t(e);return i._isPrototype=!0,i.numberOfParameters=n,i}},{key:"CallWithName",value:function(e){return new t(e)}},{key:"CallExistsWithName",value:function(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions[t]}},{key:"GenerateNativeFunctionsIfNecessary",value:function(){null==this._nativeFunctions&&(this._nativeFunctions={},this.AddIntBinaryOp(this.Add,function(t,e){return t+e}),this.AddIntBinaryOp(this.Subtract,function(t,e){return t-e}),this.AddIntBinaryOp(this.Multiply,function(t,e){return t*e}),this.AddIntBinaryOp(this.Divide,function(t,e){return parseInt(t/e)}),this.AddIntBinaryOp(this.Mod,function(t,e){return t%e}),this.AddIntUnaryOp(this.Negate,function(t){return-t}),this.AddIntBinaryOp(this.Equal,function(t,e){return t==e?1:0}),this.AddIntBinaryOp(this.Greater,function(t,e){return t>e?1:0}),this.AddIntBinaryOp(this.Less,function(t,e){return t<e?1:0}),this.AddIntBinaryOp(this.GreaterThanOrEquals,function(t,e){return t>=e?1:0}),this.AddIntBinaryOp(this.LessThanOrEquals,function(t,e){return t<=e?1:0}),this.AddIntBinaryOp(this.NotEquals,function(t,e){return t!=e?1:0}),this.AddIntUnaryOp(this.Not,function(t){return 0==t?1:0}),this.AddIntBinaryOp(this.And,function(t,e){return 0!=t&&0!=e?1:0}),this.AddIntBinaryOp(this.Or,function(t,e){return 0!=t||0!=e?1:0}),this.AddIntBinaryOp(this.Max,function(t,e){return Math.max(t,e)}),this.AddIntBinaryOp(this.Min,function(t,e){return Math.min(t,e)}),this.AddFloatBinaryOp(this.Add,function(t,e){return t+e}),this.AddFloatBinaryOp(this.Subtract,function(t,e){return t-e}),this.AddFloatBinaryOp(this.Multiply,function(t,e){return t*e}),this.AddFloatBinaryOp(this.Divide,function(t,e){return t/e}),this.AddFloatBinaryOp(this.Mod,function(t,e){return t%e}),this.AddFloatUnaryOp(this.Negate,function(t){return-t}),this.AddFloatBinaryOp(this.Equal,function(t,e){return t==e?1:0}),this.AddFloatBinaryOp(this.Greater,function(t,e){return t>e?1:0}),this.AddFloatBinaryOp(this.Less,function(t,e){return t<e?1:0}),this.AddFloatBinaryOp(this.GreaterThanOrEquals,function(t,e){return t>=e?1:0}),this.AddFloatBinaryOp(this.LessThanOrEquals,function(t,e){return t<=e?1:0}),this.AddFloatBinaryOp(this.NotEquals,function(t,e){return t!=e?1:0}),this.AddFloatUnaryOp(this.Not,function(t){return 0==t?1:0}),this.AddFloatBinaryOp(this.And,function(t,e){return 0!=t&&0!=e?1:0}),this.AddFloatBinaryOp(this.Or,function(t,e){return 0!=t||0!=e?1:0}),this.AddFloatBinaryOp(this.Max,function(t,e){return Math.max(t,e)}),this.AddFloatBinaryOp(this.Min,function(t,e){return Math.min(t,e)}),this.AddStringBinaryOp(this.Add,function(t,e){return t+e}),this.AddStringBinaryOp(this.Equal,function(t,e){return t===e?1:0}),this.AddStringBinaryOp(this.NotEquals,function(t,e){return t!==e?1:0}),this.AddStringBinaryOp(this.Has,function(t,e){return t.includes(e)?1:0}),this.AddStringBinaryOp(this.Hasnt,function(t,e){return t.includes(e)?0:1}),this.AddListBinaryOp(this.Add,function(t,e){return t.Union(e)}),this.AddListBinaryOp(this.Subtract,function(t,e){return t.Without(e)}),this.AddListBinaryOp(this.Has,function(t,e){return t.Contains(e)?1:0}),this.AddListBinaryOp(this.Hasnt,function(t,e){return t.Contains(e)?0:1}),this.AddListBinaryOp(this.Intersect,function(t,e){return t.Intersect(e)}),this.AddListBinaryOp(this.Equal,function(t,e){return t.Equals(e)?1:0}),this.AddListBinaryOp(this.Greater,function(t,e){return t.GreaterThan(e)?1:0}),this.AddListBinaryOp(this.Less,function(t,e){return t.LessThan(e)?1:0}),this.AddListBinaryOp(this.GreaterThanOrEquals,function(t,e){return t.GreaterThanOrEquals(e)?1:0}),this.AddListBinaryOp(this.LessThanOrEquals,function(t,e){return t.LessThanOrEquals(e)?1:0}),this.AddListBinaryOp(this.NotEquals,function(t,e){return t.Equals(e)?0:1}),this.AddListBinaryOp(this.And,function(t,e){return t.Count>0&&e.Count>0?1:0}),this.AddListBinaryOp(this.Or,function(t,e){return t.Count>0||e.Count>0?1:0}),this.AddListUnaryOp(this.Not,function(t){return 0==t.Count?1:0}),this.AddListUnaryOp(this.Invert,function(t){return t.inverse}),this.AddListUnaryOp(this.All,function(t){return t.all}),this.AddListUnaryOp(this.ListMin,function(t){return t.MinAsList()}),this.AddListUnaryOp(this.ListMax,function(t){return t.MaxAsList()}),this.AddListUnaryOp(this.Count,function(t){return t.Count}),this.AddListUnaryOp(this.ValueOfList,function(t){return t.maxItem.Value}),this.AddOpToNativeFunc(this.Equal,2,v.DivertTarget,function(t,e){return t.Equals(e)?1:0}))}},{key:"AddOpToNativeFunc",value:function(e,n,i,r){var a=this._nativeFunctions[e];a||(a=t.internalConstructor(e,n),this._nativeFunctions[e]=a),a.AddOpFuncForType(i,r)}},{key:"AddIntBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,v.Int,e)}},{key:"AddIntUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,v.Int,e)}},{key:"AddFloatBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,v.Float,e)}},{key:"AddFloatUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,v.Float,e)}},{key:"AddStringBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,v.String,e)}},{key:"AddListBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,v.List,e)}},{key:"AddListUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,v.List,e)}}]),t}();j.Add="+",j.Subtract="-",j.Divide="/",j.Multiply="*",j.Mod="%",j.Negate="_",j.Equal="==",j.Greater=">",j.Less="<",j.GreaterThanOrEquals=">=",j.LessThanOrEquals="<=",j.NotEquals="!=",j.Not="!",j.And="&&",j.Or="||",j.Min="MIN",j.Max="MAX",j.Has="?",j.Hasnt="!?",j.Intersect="^",j.ListMin="LIST_MIN",j.ListMax="LIST_MAX",j.All="LIST_ALL",j.Count="LIST_COUNT",j.ValueOfList="LIST_VALUE",j.Invert="LIST_INVERT",j._nativeFunctions=null;var D=function(){function t(e){o(this,t);var n=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n._text=e.toString()||"",n}return a(t,u),c(t,[{key:"toString",value:function(){return"# "+this._text}},{key:"text",get:function(){return this._text}}]),t}(),R=function(){function t(){o(this,t),this.isInvisibleDefault=!1}return c(t,[{key:"pathStringOnChoice",get:function(){return this.targetPath.toString()},set:function(t){this.targetPath=new n(t)}}]),t}(),G=function(){function t(e,n){o(this,t),this._name=e||"",this._items=null,this._rawListItemsKeys=null,this._itemNameToValues=n||{}}return c(t,[{key:"forEachItems",value:function(t){for(var e in this._rawListItemsKeys)t({Key:this._rawListItemsKeys[e],Value:this._items[e]})}},{key:"ValueForItem",value:function(t){var e=this._itemNameToValues[t.itemName];return void 0!==e?e:0}},{key:"ContainsItem",value:function(t){return t.originName==this.name&&t.itemName in this._itemNameToValues}},{key:"ContainsItemWithName",value:function(t){return void 0!==this._itemNameToValues[t]}},{key:"TryGetItemWithValue",value:function(t){for(var e in this._itemNameToValues)if(this._itemNameToValues[e]==t)return{item:new f(this.name,e),exists:!0};return{item:f.Null,exists:!1}}},{key:"TryGetValueForItem",value:function(t){return intVal=this._itemNameToValues[t.itemName],intVal}},{key:"ListRange",value:function(t,e){var n=new d;for(var i in this._itemNameToValues)if(this._itemNameToValues[i]>=t&&this._itemNameToValues[i]<=e){var r=new f(this.name,i);n.Add(r,this._itemNameToValues[i])}return new C(n)}},{key:"name",get:function(){return this._name}},{key:"items",get:function(){if(null==this._items)for(var t in this._items={},this._rawListItemsKeys={},this._itemNameToValues){var e=new f(this.name,t);this._rawListItemsKeys[e]=e,this._items[e]=this._itemNameToValues[t]}return this._items.forEach=this.forEachItems.bind(this),this._items}}]),t}(),B=function(){function t(e){var n=this;o(this,t),this._lists={},this._allUnambiguousListValueCache={},e.forEach(function(t){n._lists[t.name]=t,t.items.forEach(function(t){var e=t.Key,i=t.Value,r=new C(e,i);n._allUnambiguousListValueCache[e.itemName]=r,n._allUnambiguousListValueCache[e.fullName]=r})})}return c(t,[{key:"TryListGetDefinition",value:function(t,e){return t in this._lists?this._lists[t]:e}},{key:"FindSingleItemListWithName",value:function(t){var e=null;return void 0!==this._allUnambiguousListValueCache[t]&&(e=this._allUnambiguousListValueCache[t]),e}},{key:"lists",get:function(){var t=[];for(var e in this._lists)t.push(this._lists[e]);return t}}]),t}(),M=function(){function t(){o(this,t)}return c(t,null,[{key:"ListToJArray",value:function(t){var e=this,n=[];return t.forEach(function(t){n.push(e.RuntimeObjectToJToken(t))}),n}},{key:"JArrayToRuntimeObjList",value:function(t,e){var n=t.length;e&&n--;for(var i=[],r=0;r<n;r++){i.push(this.JTokenToRuntimeObject(t[r]))}return i}},{key:"JObjectToDictionaryRuntimeObjs",value:function(t){var e={};for(var n in t)e[n]=this.JTokenToRuntimeObject(t[n]);return e}},{key:"DictionaryRuntimeObjsToJObject",value:function(t){var e={};for(var n in t){var i=t[n];i instanceof u&&(e[n]=this.RuntimeObjectToJToken(i))}return e}},{key:"JObjectToIntDictionary",value:function(t){var e={};for(var n in t)e[n]=parseInt(t[n]);return e}},{key:"IntDictionaryToJObject",value:function(t){var e={};for(var n in t)e[n]=t[n];return e}},{key:"JTokenToRuntimeObject",value:function(t){if(!isNaN(t)&&"\n"!==t)return m.Create(t);if("string"==typeof t){var e=t.toString(),i=e[0];if("^"==i)return new b(e.substring(1));if("\n"==i&&1==e.length)return new b("\n");if("<>"==e)return new O;for(var r=0;r<W.length;++r)if(e==W[r])return new A(r);if("L^"==e&&(e="^"),j.CallExistsWithName(e))return j.CallWithName(e);if("->->"==e)return A.PopTunnel();if("~ret"==e)return A.PopFunction();if("void"==e)return new L}if("object"===(void 0===t?"undefined":h(t))&&t instanceof Array==0){var a,o=t;if(o["^->"])return a=o["^->"],new k(new n(a.toString()));if(o["^var"]){a=o["^var"];var s=new S(a.toString());return"ci"in o&&(a=o.ci,s.contextIndex=parseInt(a)),s}var u=!1,l=!1,c=E.Function,p=!1;if((a=o["->"])?u=!0:(a=o["f()"])?(u=!0,l=!0,c=E.Function):(a=o["->t->"])?(u=!0,l=!0,c=E.Tunnel):(a=o["x()"])&&(u=!0,p=!0,l=!1,c=E.Function),u){var v=new I;v.pushesToStack=l,v.stackPushType=c,v.isExternal=p;var _=a.toString();return(a=o.var)?v.variableDivertName=_:v.targetPathString=_,v.isConditional=!!o.c,p&&(a=o.exArgs)&&(v.externalArgs=parseInt(a)),v}if(a=o["*"]){var y=new N;return y.pathStringOnChoice=a.toString(),(a=o.flg)&&(y.flags=parseInt(a)),y}if(a=o["VAR?"])return new V(a.toString());if(a=o["CNT?"]){var g=new V;return g.pathStringForCount=a.toString(),g}var T=!1,w=!1;if((a=o["VAR="])?(T=!0,w=!0):(a=o["temp="])&&(T=!0,w=!1),T){var x=a.toString(),P=!o.re,R=new F(x,P);return R.isGlobal=w,R}if(void 0!==o["#"])return a=o["#"],new D(a.toString());if(a=o.list){var G=a,B=new d;if(a=o.origins){B.SetInitialOriginNames(a)}for(var M in G){var H=G[M];B.Add(new f(M),parseInt(H))}return new C(B)}if(null!=o.originalChoicePath)return this.JObjectToChoice(o)}if(t instanceof Array)return this.JArrayToContainer(t);if(null==t)return null;throw"Failed to convert token to runtime object: "+JSON.stringify(t)}},{key:"RuntimeObjectToJToken",value:function(t){var e=t;if(e instanceof w)return this.ContainerToJArray(e);var n=t;if(n instanceof I){var i,r="->";return n.isExternal?r="x()":n.pushesToStack&&(n.stackPushType==E.Function?r="f()":n.stackPushType==E.Tunnel&&(r="->t->")),i=n.hasVariableTarget?n.variableDivertName:n.targetPathString,(h={})[r]=i,n.hasVariableTarget&&(h.var=!0),n.isConditional&&(h.c=!0),n.externalArgs>0&&(h.exArgs=n.externalArgs),h}var a=t;if(a instanceof N)return(h={})["*"]=a.pathStringOnChoice,h.flg=a.flags,h;if(t instanceof y)return t.value;if(t instanceof g)return t.value;var o=t;if(o instanceof b)return o.isNewline?"\n":"^"+o.value;var s=t;if(s instanceof C)return this.InkListToJObject(s);if(t instanceof k)return{"^->":t.value.componentsString};var u=t;if(u instanceof S)return{"^var":u.value,ci:u.contextIndex};if(t instanceof O)return"<>";if(t instanceof A)return W[parseInt(t.commandType)];if(t instanceof j){var l=t.name;return"^"==l&&(l="L^"),l}var c=t;if(c instanceof V){var h={},f=c.pathStringForCount;return null!=f?h["CNT?"]=f:h["VAR?"]=c.name,h}var d=t;if(d instanceof F)return(h={})[d.isGlobal?"VAR=":"temp="]=d.variableName,d.isNewDeclaration||(h.re=!0),h;if(t instanceof L)return"void";if(t instanceof D)return(h={})["#"]=t.text,h;var p=t;if(p instanceof R)return this.ChoiceToJObject(p);throw"Failed to convert runtime object to Json token: "+t}},{key:"ContainerToJArray",value:function(t){var e=this.ListToJArray(t.content),n=t.namedOnlyContent,i=t.countFlags;if(null!=n&&n.length>0||i>0||null!=t.name){var r;if(null!=n)for(var a in r=this.DictionaryRuntimeObjsToJObject(n)){var o=r[a];if(null!=o){var s=o[o.length-1];null!=s&&(delete s["#n"],0==Object.keys(s).length&&(o[o.length-1]=null))}}else r={};i>0&&(r["#f"]=i),null!=t.name&&(r["#n"]=t.name),e.push(r)}else e.push(null);return e}},{key:"JArrayToContainer",value:function(t){var e=new w;e.content=this.JArrayToRuntimeObjList(t,!0);var n=t[t.length-1];if(null!=n){var i={};for(var r in n)if("#f"==r)e.countFlags=parseInt(n[r]);else if("#n"==r)e.name=n[r].toString();else{var a=this.JTokenToRuntimeObject(n[r]);a instanceof w&&(a.name=r),i[r]=a}e.namedOnlyContent=i}return e}},{key:"JObjectToChoice",value:function(t){var e=new R;return e.text=t.text.toString(),e.index=parseInt(t.index),e.sourcePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e.pathStringOnChoice=t.targetPath.toString(),e}},{key:"ChoiceToJObject",value:function(t){var e={};return e.text=t.text,e.index=t.index,e.originalChoicePath=t.sourcePath,e.originalThreadIndex=t.originalThreadIndex,e.targetPath=t.pathStringOnChoice,e}},{key:"InkListToJObject",value:function(t){var e=t.value,n={},i={};return e.forEach(function(t){var e=t.Key,n=t.Value;i[e.toString()]=n}),n.list=i,0==e.Count&&null!=e.originNames&&e.originNames.length>0&&(n.origins=e.originNames),n}},{key:"ListDefinitionsToJToken",value:function(t){var e={};return t.lists.forEach(function(t){var n={};t.items.forEach(function(t){n[t.Key.itemName]=t.Value}),e[t.name]=n}),e}},{key:"JTokenToListDefinitions",value:function(t){var e=t,n=[];for(var i in e){var r=i.toString(),a=e[i],o={};for(var s in a){var u=a[s];o[s]=parseInt(u)}n.push(new G(r,o))}return new B(n)}}]),t}(),W=[];W[A.CommandType.EvalStart]="ev",W[A.CommandType.EvalOutput]="out",W[A.CommandType.EvalEnd]="/ev",W[A.CommandType.Duplicate]="du",W[A.CommandType.PopEvaluatedValue]="pop",W[A.CommandType.PopFunction]="~ret",W[A.CommandType.PopTunnel]="->->",W[A.CommandType.BeginString]="str",W[A.CommandType.EndString]="/str",W[A.CommandType.NoOp]="nop",W[A.CommandType.ChoiceCount]="choiceCnt",W[A.CommandType.TurnsSince]="turns",W[A.CommandType.ReadCount]="readc",W[A.CommandType.Random]="rnd",W[A.CommandType.SeedRandom]="srnd",W[A.CommandType.VisitIndex]="visit",W[A.CommandType.SequenceShuffleIndex]="seq",W[A.CommandType.StartThread]="thread",W[A.CommandType.Done]="done",W[A.CommandType.End]="end",W[A.CommandType.ListFromInt]="listInt",W[A.CommandType.ListRange]="range";for(var H=0;H<A.CommandType.TOTAL_VALUES;++H)if(null==W[H])throw"Control command not accounted for in serialisation";var J=function(){function t(e,n,i){o(this,t),this.currentPointer=n.copy(),this.inExpressionEvaluation=i||!1,this.temporaryVariables={},this.type=e,this.evaluationStackHeightWhenPushed=0,this.functionStartInOuputStream=0}return c(t,[{key:"Copy",value:function(){var n=new t(this.type,this.currentPointer,this.inExpressionEvaluation);return e(n.temporaryVariables,this.temporaryVariables),n.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,n.functionStartInOuputStream=this.functionStartInOuputStream,n}}]),t}(),q=function(){function t(e,i){var r=this;if(o(this,t),this.callstack=[],this.threadIndex=0,this.previousPointer=P.Null,e&&i){var a=e;this.threadIndex=parseInt(a.threadIndex),a.callstack.forEach(function(t){var e=t,a=parseInt(e.type),o=P.Null,s=null,u=e.cPath;if(void 0!==u){s=u.toString();var l=i.ContentAtPath(new n(s));if(o.container=l.container,o.index=parseInt(e.idx),null==l.obj)throw"When loading state, internal story location couldn't be found: "+s+". Has the story changed since this save data was created?";l.approximate&&i.Warning("When loading state, exact internal story location couldn't be found: '"+s+"', so it was approximated to '"+o.container.path.toString()+"' to recover. Has the story changed since this save data was created?")}var c=!!e.exp,h=new J(a,o,c);h.temporaryVariables=M.JObjectToDictionaryRuntimeObjs(e.temp),r.callstack.push(h)});var s=a.previousContentObject;if(void 0!==s){var u=new n(s.toString());this.previousPointer=i.PointerAtPath(u)}}}return c(t,[{key:"Copy",value:function(){var e=new t;return e.threadIndex=this.threadIndex,this.callstack.forEach(function(t){e.callstack.push(t.Copy())}),e.previousPointer=this.previousPointer.copy(),e}},{key:"jsonToken",get:function(){var t={},e=[];return this.callstack.forEach(function(t){var n={};t.currentPointer.isNull||(n.cPath=t.currentPointer.container.path.componentsString,n.idx=t.currentPointer.index),n.exp=t.inExpressionEvaluation,n.type=parseInt(t.type),n.temp=M.DictionaryRuntimeObjsToJObject(t.temporaryVariables),e.push(n)}),t.callstack=e,t.threadIndex=this.threadIndex,this.previousPointer.isNull||(t.previousContentObject=this.previousPointer.Resolve().path.toString()),t}}]),t}(),K=function(){function t(e){var n=this;o(this,t),this._threads=[],this._threadCounter=0,this._threads.push(new q),e instanceof t?(this._threads=[],e._threads.forEach(function(t){n._threads.push(t.Copy())})):this._threads[0].callstack.push(new J(E.Tunnel,P.StartOf(e)))}return c(t,[{key:"CanPop",value:function(t){return!!this.canPop&&(null==t||this.currentElement.type==t)}},{key:"Pop",value:function(t){if(!this.CanPop(t))throw"Mismatched push/pop in Callstack";this.callStack.pop()}},{key:"Push",value:function(t,e,n){e=void 0!==e?e:0,n=void 0!==n?n:0;var i=new J(t,this.currentElement.currentPointer,!1);i.evaluationStackHeightWhenPushed=e,i.functionStartInOuputStream=n,this.callStack.push(i)}},{key:"PushThread",value:function(){var t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}},{key:"PopThread",value:function(){if(!this.canPopThread)throw"Can't pop thread";this._threads.splice(this._threads.indexOf(this.currentThread),1)}},{key:"SetJsonToken",value:function(t,e){var n=this;this._threads.length=0;var i=t;i.threads.forEach(function(t){var i=new q(t,e);n._threads.push(i)}),this._threadCounter=parseInt(i.threadCounter)}},{key:"GetJsonToken",value:function(){var t={},e=[];return this._threads.forEach(function(t){e.push(t.jsonToken)}),t.threads=e,t.threadCounter=this._threadCounter,t}},{key:"GetTemporaryVariableWithName",value:function(t,e){-1==(e=void 0===e?-1:e)&&(e=this.currentElementIndex+1);var n;return(n=this.callStack[e-1].temporaryVariables[t])?n:null}},{key:"SetTemporaryVariable",value:function(t,e,n,i){-1==(i=void 0===i?-1:i)&&(i=this.currentElementIndex+1);var r,a=this.callStack[i-1];if(!n&&!a.temporaryVariables[t])throw new p("Could not find temporary variable to set: "+t);(r=a.temporaryVariables[t])&&C.RetainListOriginsForAssignment(r,e),a.temporaryVariables[t]=e}},{key:"ContextForVariableNamed",value:function(t){return this.currentElement.temporaryVariables[t]?this.currentElementIndex+1:0}},{key:"ThreadWithIndex",value:function(t){return this._threads.filter(function(e){if(e.threadIndex==t)return e})[0]}},{key:"currentThread",get:function(){return this._threads[this._threads.length-1]},set:function(t){1!=this._threads.length&&console.warn("Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}},{key:"callStack",get:function(){return this.currentThread.callstack}},{key:"callStackTrace",get:function(){for(var t=new l,e=0;e<this._threads.length;e++){var n=this._threads[e];t.AppendFormat("=== THREAD {0}/{1} {2}===\n",e+1,this._threads.length,e==this._threads.length-1?"(current) ":"");for(var i=0;i<n.callstack.length;i++){t.Append(n.callstack[i].type==E.Function?"  [FUNCTION] ":"  [TUNNEL] ");var r=n.callstack[i].currentPointer;r.isNull||(t.Append("<SOMEWHERE IN "),t.Append(r.container.path.toString()),t.AppendLine(">"))}}return t.toString()}},{key:"elements",get:function(){return this.callStack}},{key:"depth",get:function(){return this.elements.length}},{key:"currentElement",get:function(){var t=this._threads[this._threads.length-1].callstack;return t[t.length-1]}},{key:"currentElementIndex",get:function(){return this.callStack.length-1}},{key:"canPop",get:function(){return this.callStack.length>1}},{key:"canPopThread",get:function(){return this._threads.length>1&&!this.elementIsEvaluateFromGame}},{key:"elementIsEvaluateFromGame",get:function(){return this.currentElement.type==E.FunctionEvaluationFromGame}}]),t}(),$=function(){function t(e,n){o(this,t),this._globalVariables={},this._defaultGlobalVariables={},this._callStack=e,this._listDefsOrigin=n,this._batchObservingVariableChanges=null,this._changedVariables=null,this.variableChangedEvent=null,this.variableChangedEventCallbacks=[];try{return new Proxy(this,{get:function(t,e){return e in t?t[e]:t.$(e)},set:function(t,e,n){return e in t?t[e]=n:t.$(e,n),!0}})}catch(t){}}return c(t,[{key:"ObserveVariableChange",value:function(t){var e=this;null==this.variableChangedEvent&&(this.variableChangedEvent=function(t,n){e.variableChangedEventCallbacks.forEach(function(e){e(t,n)})}),this.variableChangedEventCallbacks.push(t)}},{key:"CopyFrom",value:function(t){this._globalVariables=e({},t._globalVariables),this._defaultGlobalVariables=e({},t._defaultGlobalVariables),this.variableChangedEvent=t.variableChangedEvent,t.batchObservingVariableChanges!=this.batchObservingVariableChanges&&(t.batchObservingVariableChanges?(this._batchObservingVariableChanges=!0,this._changedVariables=t._changedVariables):(this._batchObservingVariableChanges=!1,this._changedVariables=null))}},{key:"GlobalVariableExistsWithName",value:function(t){return void 0!==this._globalVariables[t]}},{key:"GetVariableWithName",value:function(t,e){void 0===e&&(e=-1);var n=this.GetRawVariableWithName(t,e),i=n;return i instanceof S&&(n=this.ValueAtVariablePointer(i)),n}},{key:"TryGetDefaultVariableValue",value:function(t){var e=_defaultGlobalVariables[t];return void 0===e&&(e=null),e}},{key:"GetRawVariableWithName",value:function(t,e){var n=null;if(0==e||-1==e){if(n=this._globalVariables[t])return n;var i=this._listDefsOrigin.FindSingleItemListWithName(t);if(i)return i}return n=this._callStack.GetTemporaryVariableWithName(t,e)}},{key:"ValueAtVariablePointer",value:function(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}},{key:"Assign",value:function(t,e){var n=t.variableName,i=-1,r=!1;if(r=t.isNewDeclaration?t.isGlobal:!!this._globalVariables[n],t.isNewDeclaration){var a=e;a instanceof S&&(e=this.ResolveVariablePointer(a))}else{var o=null;do{(o=this.GetRawVariableWithName(n,i))instanceof S&&(n=o.variableName,r=0==(i=o.contextIndex))}while(o instanceof S)}r?this.SetGlobal(n,e):this._callStack.SetTemporaryVariable(n,e,t.isNewDeclaration,i)}},{key:"SnapshotDefaultGlobals",value:function(){this._defaultGlobalVariables=e({},this._globalVariables)}},{key:"RetainListOriginsForAssignment",value:function(t,e){var n=t,i=e;n instanceof C&&i instanceof C&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames)}},{key:"SetGlobal",value:function(t,e){var n;n=this._globalVariables[t],C.RetainListOriginsForAssignment(n,e),this._globalVariables[t]=e,null!=this.variableChangedEvent&&e!==n&&(this.batchObservingVariableChanges?this._changedVariables.push(t):this.variableChangedEvent(t,e))}},{key:"ResolveVariablePointer",value:function(t){var e=t.contextIndex;-1==e&&(e=this.GetContextIndexOfVariableNamed(t.variableName));var n=this.GetRawVariableWithName(t.variableName,e);return n instanceof S?n:new S(t.variableName,e)}},{key:"GetContextIndexOfVariableNamed",value:function(t){return this._globalVariables[t]?0:this._callStack.currentElementIndex}},{key:"$",value:function(t,e){if(void 0===e){var n=this._globalVariables[t];return void 0===n&&(n=this._defaultGlobalVariables[t]),void 0!==n?n.valueObject:null}if(void 0===this._defaultGlobalVariables[t])throw new p("Cannot assign to a variable that hasn't been declared in the story");var i=m.Create(e);if(null==i)throw new p(null==e?"Cannot pass null to VariableState":"Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,i)}},{key:"callStack",get:function(){return this._callStack},set:function(t){this._callStack=t}},{key:"batchObservingVariableChanges",get:function(){return this._batchObservingVariableChanges},set:function(t){var e=this;t=!!t,this._batchObservingVariableChanges=t,t?this._changedVariables=[]:(null!=this._changedVariables&&this._changedVariables.forEach(function(t){e.variableChangedEvent(t,e._globalVariables[t])}),this._changedVariables=null)}},{key:"jsonToken",get:function(){return M.DictionaryRuntimeObjsToJObject(this._globalVariables)},set:function(t){this._globalVariables=M.JObjectToDictionaryRuntimeObjs(t)}}]),t}(),U=function(){function t(e){o(this,t),(this._seed=e%2147483647)<=0&&(this._seed+=2147483646)}return c(t,[{key:"next",value:function(){return this._seed=16807*this._seed%2147483647}},{key:"nextFloat",value:function(){return(this.next()-1)/2147483646}}]),t}(),X=function(){function t(e){o(this,t),this.story=e,this._outputStream=[],this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this.OutputStreamDirty(),this._evaluationStack=[],this.callStack=new K(e.rootContentContainer),this._variablesState=new $(this.callStack,e.listDefinitions),this._visitCounts={},this._turnIndices={},this._currentTurnIndex=-1,this.divertedPointer=P.Null;var n=(new Date).getTime();this.storySeed=new U(n).next()%100,this.previousRandom=0,this._currentChoices=[],this._currentText=null,this._currentTags=null,this._currentErrors=null,this._currentWarnings=null,this.didSafeExit=!1,this.GoToStart()}return c(t,[{key:"CleanOutputWhitespace",value:function(t){for(var e=new l,n=-1,i=0;i<t.length;i++){var r=t.charAt(i),a=" "==r||"\t"==r;a&&-1==n&&(n=i),a||("\n"!=r&&n>0&&e.Append(t.substr(n,i-n)),n=-1),a||e.Append(r)}return e.toString()}},{key:"GoToStart",value:function(){this.callStack.currentElement.currentPointer=P.StartOf(this.story.mainContentContainer)}},{key:"ResetErrors",value:function(){this._currentErrors=null,this._currentWarnings=null}},{key:"ResetOutput",value:function(t){t=void 0!==t?t:null,this._outputStream.length=0,null!=t&&this._outputStream.push.apply(this._outputStream,t),this.OutputStreamDirty()}},{key:"PushEvaluationStack",value:function(t){var e=this;if(t instanceof C){var n=t.value;null!=n.originNames&&(n.origins||(n.origins=[]),n.origins.length=0,n.originNames.forEach(function(t){var i=null;i=e.story.listDefinitions.TryListGetDefinition(t,i),n.origins.indexOf(i)<0&&n.origins.push(i)}))}this.evaluationStack.push(t)}},{key:"PopEvaluationStack",value:function(t){if(t){if(t>this.evaluationStack.length)throw"trying to pop too many objects";return this.evaluationStack.splice(this.evaluationStack.length-t,t)}return this.evaluationStack.pop()}},{key:"PeekEvaluationStack",value:function(){return this.evaluationStack[this.evaluationStack.length-1]}},{key:"PushToOutputStream",value:function(t){var e=this,n=t;if(n instanceof b){var i=this.TrySplittingHeadTailWhitespace(n);if(null!=i)return i.forEach(function(t){e.PushToOutputStreamIndividual(t)}),void this.OutputStreamDirty()}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}},{key:"PopFromOutputStream",value:function(t){this.outputStream.splice(this.outputStream.length-t,t),this.OutputStreamDirty()}},{key:"TrySplittingHeadTailWhitespace",value:function(t){for(var e=t.value,n=-1,i=-1,r=0;r<e.length;++r){if("\n"!=(s=e[r])){if(" "==s||"\t"==s)continue;break}-1==n&&(n=r),i=r}var a=-1,o=-1;for(r=0;r<e.length;++r){var s;if("\n"!=(s=e[r])){if(" "==s||"\t"==s)continue;break}-1==a&&(a=r),o=r}if(-1==n&&-1==a)return null;var u=[],l=0,c=e.length;if(-1!=n){if(n>0){u.push(e.substring(0,n))}u.push(new b("\n")),l=i+1}if(-1!=a&&(c=o),c>l){var h=e.substring(l,c-l);u.push(new b(h))}if(-1!=a&&o>i&&(u.push(new b("\n")),a<e.length-1)){u.push(new b(e.substring(a+1,e.length-a-1)))}return u}},{key:"PushToOutputStreamIndividual",value:function(t){var e=t,n=!0;if(t instanceof O)this.TrimNewlinesFromOutputStream(),n=!0;else if(e instanceof b){var i=-1,r=this.callStack.currentElement;r.type==E.Function&&(i=r.functionStartInOutputStream);for(var a=-1,o=this._outputStream.length-1;o>=0;o--){var s=this._outputStream[o],u=s instanceof A?s:null;if(null!=(s instanceof O?s:null)){a=o;break}if(null!=u&&u.commandType==A.CommandType.BeginString){o>=i&&(i=-1);break}}if(-1!=(-1!=a&&-1!=i?Math.min(i,a):-1!=a?a:i)){if(e.isNewline)n=!1;else if(e.isNonWhitespace&&(a>-1&&this.RemoveExistingGlue(),i>-1)){var l=this.callStack.elements;for(o=l.length-1;o>=0;o--){var c=l[o];if(c.type!=E.Function)break;c.functionStartInOutputStream=-1}}}else e.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(n=!1))}n&&(this._outputStream.push(t),this.OutputStreamDirty())}},{key:"TrimNewlinesFromOutputStream",value:function(){for(var t=-1,e=this._outputStream.length-1;e>=0;){var n=this._outputStream[e],i=n instanceof b?n:null;if(null!=(n instanceof A?n:null)||null!=i&&i.isNonWhitespace)break;null!=i&&i.isNewline&&(t=e),e--}if(t>=0)for(e=t;e<this._outputStream.length;)this._outputStream[e]instanceof b?this._outputStream.splice(e,1):e++;this.OutputStreamDirty()}},{key:"RemoveExistingGlue",value:function(){for(var t=this._outputStream.length-1;t>=0;t--){var e=this._outputStream[t];if(e instanceof O)this._outputStream.splice(t,1);else if(e instanceof A)break}this.OutputStreamDirty()}},{key:"ForceEnd",value:function(){for(;this.callStack.canPopThread;)this.callStack.PopThread();for(;this.callStack.canPop;)this.PopCallStack();this._currentChoices.length=0,this.currentPointer=P.Null,this.previousPointer=P.Null,this.didSafeExit=!0}},{key:"TrimWhitespaceFromFunctionEnd",value:function(){var t=this.callStack.currentElement.functionStartInOutputStream;-1==t&&(t=0);for(var e=this._outputStream.length-1;e>=t;e--){var n=this._outputStream[e],i=n instanceof b?n:null;if(null!=i){if(n instanceof A?n:null)break;if(!i.isNewline&&!i.isInlineWhitespace)break;this._outputStream.splice(e,1),this.OutputStreamDirty()}}}},{key:"PopCallStack",value:function(t){t=void 0!==t?t:null,this.callStack.currentElement.type==E.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(t)}},{key:"SetChosenPath",value:function(t){this._currentChoices.length=0;var e=this.story.PointerAtPath(t);e.isNull||-1!=e.index||(e.index=0),this.currentPointer=e,this._currentTurnIndex++}},{key:"StartFunctionEvaluationFromGame",value:function(t,e){this.callStack.Push(E.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=P.StartOf(t),this.PassArgumentsToEvaluationStack(e)}},{key:"PassArgumentsToEvaluationStack",value:function(t){if(null!=t)for(var e=0;e<t.length;e++){if("number"!=typeof t[e]&&"string"!=typeof t[e])throw"ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters  must be int, float or string";this.PushEvaluationStack(m.Create(t[e]))}}},{key:"TryExitFunctionEvaluationFromGame",value:function(){return this.callStack.currentElement.type==E.FunctionEvaluationFromGame&&(this.currentPointer=P.Null,this.didSafeExit=!0,!0)}},{key:"CompleteFunctionEvaluationFromGame",value:function(){if(this.callStack.currentElement.type!=E.FunctionEvaluationFromGame)throw new p("Expected external function evaluation to be complete. Stack trace: "+callStack.callStackTrace);for(var t=this.callStack.currentElement.evaluationStackHeightWhenPushed,e=null;this.evaluationStack.length>t;){var n=this.PopEvaluationStack();null==e&&(e=n)}if(this.PopCallStack(E.FunctionEvaluationFromGame),e){if(e instanceof L)return null;var i=e;return i.valueType==v.DivertTarget?i.valueObject.toString():i.valueObject}return null}},{key:"AddError",value:function(t,e){e?(null==this._currentWarnings&&(this._currentWarnings=[]),this._currentWarnings.push(t)):(null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(t))}},{key:"OutputStreamDirty",value:function(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}},{key:"VisitCountAtPathString",value:function(t){var e;return(e=this.visitCounts[t])?e:0}},{key:"Copy",value:function(){var e=new t(this.story);for(var n in e.outputStream.push.apply(e.outputStream,this._outputStream),this.OutputStreamDirty(),e._currentChoices.push.apply(e._currentChoices,this._currentChoices),this.hasError&&(e._currentErrors=[],e._currentErrors.push.apply(e._currentErrors,this.currentErrors)),this.hasWarning&&(e._currentWarnings=[],e._currentWarnings.push.apply(e._currentWarnings,this.currentWarnings)),e.callStack=new K(this.callStack),e._variablesState=new $(e.callStack,this.story.listDefinitions),e.variablesState.CopyFrom(this.variablesState),e.evaluationStack.push.apply(e.evaluationStack,this.evaluationStack),this.divertedPointer.isNull||(e.divertedPointer=this.divertedPointer.copy()),e.previousPointer=this.previousPointer.copy(),e._visitCounts={},this._visitCounts)e._visitCounts[n]=this._visitCounts[n];for(var n in e._turnIndices={},this._turnIndices)e._turnIndices[n]=this._turnIndices[n];return e._currentTurnIndex=this.currentTurnIndex,e.storySeed=this.storySeed,e.previousRandom=this.previousRandom,e.didSafeExit=this.didSafeExit,e}},{key:"ToJson",value:function(t){return JSON.stringify(this.jsonToken,null,t?2:0)}},{key:"toJson",value:function(t){return this.ToJson(t)}},{key:"LoadJson",value:function(t){this.jsonToken=JSON.parse(t)}},{key:"currentChoices",get:function(){return this.canContinue?[]:this._currentChoices}},{key:"generatedChoices",get:function(){return this._currentChoices}},{key:"currentErrors",get:function(){return this._currentErrors}},{key:"currentWarnings",get:function(){return this._currentWarnings}},{key:"visitCounts",get:function(){return this._visitCounts}},{key:"turnIndices",get:function(){return this._turnIndices}},{key:"currentTurnIndex",get:function(){return this._currentTurnIndex}},{key:"variablesState",get:function(){return this._variablesState}},{key:"currentContentObject",get:function(){return this.callStack.currentElement.currentObject},set:function(t){this.callStack.currentElement.currentObject=t}},{key:"canContinue",get:function(){return!this.currentPointer.isNull&&!this.hasError}},{key:"hasError",get:function(){return null!=this.currentErrors&&this.currentErrors.length>0}},{key:"hasWarning",get:function(){return null!=this.currentWarnings&&this.currentWarnings.length>0}},{key:"inExpressionEvaluation",get:function(){return this.callStack.currentElement.inExpressionEvaluation},set:function(t){this.callStack.currentElement.inExpressionEvaluation=t}},{key:"evaluationStack",get:function(){return this._evaluationStack}},{key:"outputStreamEndsInNewline",get:function(){if(this._outputStream.length>0)for(var t=this._outputStream.length-1;t>=0&&!(this._outputStream[t]instanceof A);t--){var e=this._outputStream[t];if(e instanceof b){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}},{key:"outputStreamContainsContent",get:function(){for(var t=0;t<this._outputStream.length;t++)if(this._outputStream[t]instanceof b)return!0;return!1}},{key:"inStringEvaluation",get:function(){for(var t=this._outputStream.length-1;t>=0;t--){var e=this._outputStream[t];if(e instanceof A&&e.commandType==A.CommandType.BeginString)return!0}return!1}},{key:"currentText",get:function(){if(this._outputStreamTextDirty){var t=new l;this._outputStream.forEach(function(e){var n=e;n instanceof b&&t.Append(n.value)}),this._currentText=this.CleanOutputWhitespace(t.toString()),this._outputStreamTextDirty=!1}return this._currentText}},{key:"currentTags",get:function(){var t=this;return this._outputStreamTagsDirty&&(this._currentTags=[],this._outputStream.forEach(function(e){var n=e;n instanceof D&&t._currentTags.push(n.text)}),this._outputStreamTagsDirty=!1),this._currentTags}},{key:"outputStream",get:function(){return this._outputStream}},{key:"currentPathString",get:function(){var t=this.currentPointer;return t.isNull?null:t.path.toString()}},{key:"currentPointer",get:function(){return this.callStack.currentElement.currentPointer.copy()},set:function(t){this.callStack.currentElement.currentPointer=t.copy()}},{key:"previousPointer",get:function(){return this.callStack.currentThread.previousPointer.copy()},set:function(t){this.callStack.currentThread.previousPointer=t.copy()}},{key:"callstackDepth",get:function(){return this.callStack.depth}},{key:"jsonToken",get:function(){var e=this,n={},i=null;return this._currentChoices.forEach(function(t){t.originalThreadIndex=t.threadAtGeneration.threadIndex,null==e.callStack.ThreadWithIndex(t.originalThreadIndex)&&(null==i&&(i={}),i[t.originalThreadIndex.toString()]=t.threadAtGeneration.jsonToken)}),null!=this.choiceThreads&&(n.choiceThreads=this.choiceThreads),n.callstackThreads=this.callStack.GetJsonToken(),n.variablesState=this.variablesState.jsonToken,n.evalStack=M.ListToJArray(this.evaluationStack),n.outputStream=M.ListToJArray(this._outputStream),n.currentChoices=M.ListToJArray(this._currentChoices),this.divertedPointer.isNull||(n.currentDivertTarget=this.divertedPointer.path.componentsString),n.visitCounts=M.IntDictionaryToJObject(this.visitCounts),n.turnIndices=M.IntDictionaryToJObject(this.turnIndices),n.turnIdx=this.currentTurnIndex,n.storySeed=this.storySeed,n.inkSaveVersion=t.kInkSaveStateVersion,n.inkFormatVersion=this.story.inkVersionCurrent,n},set:function(e){var i=this,r=e,a=r.inkSaveVersion;if(null==a)throw new p("ink save format incorrect, can't load.");if(parseInt(a)<t.kMinCompatibleLoadVersion)throw new p("Ink save format isn't compatible with the current version (saw '"+a+"', but minimum is "+t.kMinCompatibleLoadVersion+"), so can't load.");this.callStack.SetJsonToken(r.callstackThreads,this.story),this.variablesState.jsonToken=r.variablesState,this._evaluationStack=M.JArrayToRuntimeObjList(r.evalStack),this._outputStream=M.JArrayToRuntimeObjList(r.outputStream),this.OutputStreamDirty(),this._currentChoices=M.JArrayToRuntimeObjList(r.currentChoices);var o=r.currentDivertTarget;if(null!=o){this.divertedPointer=this.story.PointerAtPath(new n(o.toString()))}this._visitCounts=M.JObjectToIntDictionary(r.visitCounts),this._turnIndices=M.JObjectToIntDictionary(r.turnIndices),this._currentTurnIndex=parseInt(r.turnIdx),this.storySeed=parseInt(r.storySeed);var s=r.choiceThreads;this._currentChoices.forEach(function(t){var e=i.callStack.ThreadWithIndex(t.originalThreadIndex);if(null!=e)t.threadAtGeneration=e;else{var n=s[t.originalThreadIndex.toString()];t.threadAtGeneration=new K.Thread(n,i.story)}})}}]),t}();X.kInkSaveStateVersion=8,X.kMinCompatibleLoadVersion=8;var Y=function(){function t(){o(this,t)}return c(t,[{key:"Start",value:function(){this.startTime=(new Date).getTime()}},{key:"Stop",value:function(){this.startTime=void 0}},{key:"ElapsedMilliseconds",get:function(){return(new Date).getTime()-this.startTime}}]),t}();Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&t>-9007199254740992&&t<9007199254740992&&Math.floor(t)===t});var Z=function(){function t(e,n){o(this,t);var i=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));if(n=n||null,i.inkVersionCurrent=18,i.inkVersionMinimumCompatible=18,i._variableObservers=null,i._externals={},i._prevContainers=[],i._listDefinitions=null,i._stateAtLastNewline=null,i._recursiveContinueCount=0,i._temporaryEvaluationContainer=null,i._profiler=null,e instanceof w)i._mainContentContainer=e,null!=n&&(i._listDefinitions=new B(n));else{var a="string"==typeof e?JSON.parse(e):e,s=a.inkVersion;if(null==s)throw"ink version number not found. Are you sure it's a valid .ink.json file?";var u=parseInt(s);if(u>i.inkVersionCurrent)throw"Version of ink used to build story was newer than the current version of the engine";if(u<i.inkVersionMinimumCompatible)throw"Version of ink used to build story is too old to be loaded by this version of the engine";u!=i.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");var l,c=a.root;if(null==c)throw"Root node for ink not found. Are you sure it's a valid .ink.json file?";(l=a.listDefs)&&(i._listDefinitions=M.JTokenToListDefinitions(l)),i._mainContentContainer=M.JTokenToRuntimeObject(c),i._hasValidatedExternals=null,i.allowExternalFunctionFallbacks=!1,i.ResetState()}return i}return a(t,u),c(t,[{key:"StartProfiling",value:function(){}},{key:"EndProfiling",value:function(){}},{key:"ToJsonString",value:function(){var t=M.RuntimeObjectToJToken(this._mainContentContainer),e={};return e.inkVersion=this.inkVersionCurrent,e.root=t,null!=this._listDefinitions&&(e.listDefs=M.ListDefinitionsToJToken(this._listDefinitions)),JSON.stringify(e)}},{key:"ResetState",value:function(){this.IfAsyncWeCant("ResetState"),this._state=new X(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}},{key:"ResetErrors",value:function(){this._state.ResetErrors()}},{key:"ResetCallstack",value:function(){this.IfAsyncWeCant("ResetCallstack"),this._state.ForceEnd()}},{key:"ResetGlobals",value:function(){if(this._mainContentContainer.namedContent["global decl"]){var t=this.state.currentPointer.copy();this.ChoosePathString("global decl",!1),this.ContinueInternal(),this.state.currentPointer=t}this.state.variablesState.SnapshotDefaultGlobals()}},{key:"Continue",value:function(){return this.ContinueAsync(0),this.currentText}},{key:"ContinueAsync",value:function(t){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(t)}},{key:"ContinueInternal",value:function(t){t=void 0!==t?t:0,null!=this._profiler&&this._profiler.PreContinue();var e=t>0;if(this._recursiveContinueCount++,!this._asyncContinueActive){if(this._asyncContinueActive=e,!this.canContinue)throw new p("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!0)}var n=new Y;n.Start();var i=!1;do{try{i=this.ContinueSingleStep()}catch(t){if(!(t instanceof p))throw t;this.AddError(t.Message,void 0,t.useEndLineNumber);break}if(i)break;if(this._asyncContinueActive&&n.ElapsedMilliseconds>t)break}while(this.canContinue);n.Stop(),!i&&this.canContinue||(null!=this._stateAtLastNewline&&(this.RestoreStateSnapshot(this._stateAtLastNewline),this._stateAtLastNewline=null),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||this.AddError(this.state.callStack.CanPop(E.Tunnel)?"unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?":this.state.callStack.CanPop(E.Function)?"unexpectedly reached end of content. Do you need a '~ return'?":this.state.callStack.canPop?"unexpectedly reached end of content for unknown reason. Please debug compiler!":"ran out of content. Do you need a '-> DONE' or '-> END'?")),this.state.didSafeExit=!1,1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!1),this._asyncContinueActive=!1),this._recursiveContinueCount--,null!=this._profiler&&this._profiler.PostContinue()}},{key:"ContinueSingleStep",value:function(){if(null!=this._profiler&&this._profiler.PreStep(),this.Step(),null!=this._profiler&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),null!=this._profiler&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(null!=this._stateAtLastNewline){var t=this.CalculateNewlineOutputStateChange(this._stateAtLastNewline.currentText,this.state.currentText,this._stateAtLastNewline.currentTags.length,this.state.currentTags.length);if(t==Q.ExtendedBeyondNewline)return this.RestoreStateSnapshot(this._stateAtLastNewline),!0;t==Q.NewlineRemoved&&(this._stateAtLastNewline=null)}this.state.outputStreamEndsInNewline&&(this.canContinue?null==this._stateAtLastNewline&&(this._stateAtLastNewline=this.StateSnapshot()):this._stateAtLastNewline=null)}return null!=this._profiler&&this._profiler.PostSnapshot(),!1}},{key:"CalculateNewlineOutputStateChange",value:function(t,e,n,i){var r=e.length>=t.length&&"\n"==e.charAt(t.length-1);if(n==i&&t.length==e.length&&r)return Q.NoChange;if(!r)return Q.NewlineRemoved;if(i>n)return Q.ExtendedBeyondNewline;for(var a=t.length;a<e.length;a++){var o=e.charAt(a);if(" "!=o&&"\t"!=o)return Q.ExtendedBeyondNewline}return Q.NoChange}},{key:"ContinueMaximally",value:function(){this.IfAsyncWeCant("ContinueMaximally");for(var t=new l;this.canContinue;)t.Append(this.Continue());return t.toString()}},{key:"ContentAtPath",value:function(t){return this.mainContentContainer.ContentAtPath(t)}},{key:"KnotContainerWithName",value:function(t){var e=this.mainContentContainer.namedContent[t];return e instanceof w?e:null}},{key:"PointerAtPath",value:function(t){if(0==t.length)return P.Null;var e=new P,n=t.length,i=null;return t.lastComponent.isIndex?(n=t.length-1,i=this.mainContentContainer.ContentAtPath(t,void 0,n),e.container=i.container,e.index=t.lastComponent.index):(i=this.mainContentContainer.ContentAtPath(t),e.container=i.container,e.index=-1),null==i.obj||i.obj==this.mainContentContainer&&n>0?this.Error("Failed to find content at path '"+t+"', and no approximation of it was possible."):i.approximate&&this.Warning("Failed to find content at path '"+t+"', so it was approximated to: '"+i.obj.path+"'."),e}},{key:"StateSnapshot",value:function(){return this.state.Copy()}},{key:"RestoreStateSnapshot",value:function(t){this._state=t}},{key:"Step",value:function(){var t=!0,e=this.state.currentPointer.copy();if(!e.isNull){for(var n=e.Resolve();n instanceof w&&(this.VisitContainer(n,!0),0!=n.content.length);)n=(e=P.StartOf(n)).Resolve();this.state.currentPointer=e.copy(),null!=this._profiler&&this._profiler.Step(state.callStack);var i=e.Resolve(),r=this.PerformLogicAndFlowControl(i);if(!this.state.currentPointer.isNull){r&&(t=!1);var a=i;if(a instanceof N){var o=this.ProcessChoice(a);o&&this.state.generatedChoices.push(o),i=null,t=!1}if(i instanceof w&&(t=!1),t){var s=i;if(s instanceof S&&-1==s.contextIndex){var u=this.state.callStack.ContextForVariableNamed(s.variableName);i=new S(s.variableName,u)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(i):this.state.PushToOutputStream(i)}this.NextContent(),i instanceof A&&i.commandType==A.CommandType.StartThread&&this.state.callStack.PushThread()}}}},{key:"VisitContainer",value:function(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.RecordTurnIndexVisitToContainer(t))}},{key:"VisitChangedContainersDueToDivert",value:function(){var t=this.state.previousPointer.copy(),e=this.state.currentPointer.copy();if(!e.isNull&&-1!=e.index){if(this._prevContainers.length=0,!t.isNull)for(var n=t.Resolve(),i=n instanceof w?n:t.container;i instanceof w;)this._prevContainers.push(i),i=i.parent;var r=e.Resolve();if(null!=r)for(var a=r.parent;a instanceof w&&this._prevContainers.indexOf(a)<0;){var o=a.content.length>0&&r==a.content[0];this.VisitContainer(a,o),r=a,a=a.parent}}}},{key:"ProcessChoice",value:function(t){var e=!0;if(t.hasCondition){this.IsTruthy(this.state.PopEvaluationStack())||(e=!1)}var n="",i="";if(t.hasChoiceOnlyContent&&(i=this.state.PopEvaluationStack().value),t.hasStartContent&&(n=this.state.PopEvaluationStack().value),t.onceOnly&&this.VisitCountForContainer(t.choiceTarget)>0&&(e=!1),!e)return null;var r=new R;return r.targetPath=t.pathOnChoice,r.sourcePath=t.path.toString(),r.isInvisibleDefault=t.isInvisibleDefault,r.threadAtGeneration=this.state.callStack.currentThread.Copy(),r.text=(n+i).replace(/^[ \t]+|[ \t]+$/g,""),r}},{key:"IsTruthy",value:function(t){if(t instanceof m){var e=t;if(e instanceof k){return this.Error("Shouldn't use a divert target (to "+e.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return e.isTruthy}return!1}},{key:"PerformLogicAndFlowControl",value:function(t){if(null==t)return!1;if(t instanceof I){var e=t;if(e.isConditional){if(!this.IsTruthy(this.state.PopEvaluationStack()))return!0}if(e.hasVariableTarget){var n=e.variableDivertName,i=this.state.variablesState.GetVariableWithName(n);if(null==i)this.Error("Tried to divert using a target from a variable that could not be found ("+n+")");else if(!(i instanceof k)){var r="Tried to divert to a target from a variable, but the variable ("+n+") didn't contain a divert target, it ";r+=i instanceof y&&0==i.value?"was empty/null (the value 0).":"contained '"+i+"'.",this.Error(r)}var a=i;this.state.divertedPointer=this.PointerAtPath(a.targetPath)}else{if(e.isExternal)return this.CallExternalFunction(e.targetPathString,e.externalArgs),!0;this.state.divertedPointer=e.targetPointer.copy()}return e.pushesToStack&&this.state.callStack.Push(e.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!e.isExternal&&this.Error(e&&null!=e.debugMetadata.sourceName?"Divert target doesn't exist: "+e.debugMetadata.sourceName:"Divert resolution failed: "+e),!0}if(t instanceof A){var o=t;switch(o.commandType){case A.CommandType.EvalStart:this.state.inExpressionEvaluation&&console.warn("Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case A.CommandType.EvalEnd:this.state.inExpressionEvaluation||console.warn("Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case A.CommandType.EvalOutput:if(this.state.evaluationStack.length>0){var s=this.state.PopEvaluationStack();if(!(s instanceof L)){this.state.PushToOutputStream(new b(s.toString()))}}break;case A.CommandType.NoOp:break;case A.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case A.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case A.CommandType.PopFunction:case A.CommandType.PopTunnel:var u=o.commandType==A.CommandType.PopFunction?E.Function:E.Tunnel,c=null;if(u==E.Tunnel){var h=this.state.PopEvaluationStack();if((c=h)instanceof k==0){if(h instanceof L==0)throw"Expected void if ->-> doesn't override target";c=null}}if(this.state.TryExitFunctionEvaluationFromGame())break;if(this.state.callStack.currentElement.type==u&&this.state.callStack.canPop)this.state.PopCallStack(),c&&(this.state.divertedPointer=this.PointerAtPath(c.targetPath));else{var f={};f[E.Function]="function return statement (~ return)",f[E.Tunnel]="tunnel onwards statement (->->)";var d=f[this.state.callStack.currentElement.type];this.state.callStack.canPop||(d="end of flow (-> END or choice)");this.Error("Found "+f[u]+", when expected "+d)}break;case A.CommandType.BeginString:this.state.PushToOutputStream(o),this.state.inExpressionEvaluation||console.warn("Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case A.CommandType.EndString:for(var v=[],_=0,m=this.state.outputStream.length-1;m>=0;--m){var g=this.state.outputStream[m];if(_++,g instanceof A&&g.commandType==A.CommandType.BeginString)break;g instanceof b&&v.push(g)}this.state.PopFromOutputStream(_),v=v.reverse();var S=new l;v.forEach(function(t){S.Append(t.toString())}),this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new b(S.toString()));break;case A.CommandType.ChoiceCount:this.state.PushEvaluationStack(new y(this.state.generatedChoices.length));break;case A.CommandType.TurnsSince:case A.CommandType.ReadCount:if(!((a=this.state.PopEvaluationStack())instanceof k)){var T="";a instanceof y&&(T=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+a+T);break}var O,x=a,N=this.ContentAtPath(x.targetPath).correctObj;null!=(st=N instanceof w?N:null)?O=o.commandType==A.CommandType.TurnsSince?this.TurnsSinceForContainer(st):this.VisitCountForContainer(st):(O=o.commandType==A.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+o.toString()+" lookup at "+x.targetPath.toString())),this.state.PushEvaluationStack(new y(O));break;case A.CommandType.Random:var D=this.state.PopEvaluationStack(),R=this.state.PopEvaluationStack();null!=R&&R instanceof y!=0||this.Error("Invalid value for minimum parameter of RANDOM(min, max)"),null!=D&&R instanceof y!=0||this.Error("Invalid value for maximum parameter of RANDOM(min, max)");var G=D.value-R.value+1;G<=0&&this.Error("RANDOM was called with minimum as "+R.value+" and maximum as "+D.value+". The maximum must be larger");var B=this.state.storySeed+this.state.previousRandom,M=new U(B).next();this.state.PushEvaluationStack(new y(M%G+R.value)),this.state.previousRandom=M;break;case A.CommandType.SeedRandom:var W=this.state.PopEvaluationStack();null!=W&&W instanceof y!=0||this.Error("Invalid value passed to SEED_RANDOM"),this.state.storySeed=W.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new L);break;case A.CommandType.VisitIndex:var H=this.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new y(H));break;case A.CommandType.SequenceShuffleIndex:var J=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new y(J));break;case A.CommandType.StartThread:break;case A.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=P.Null);break;case A.CommandType.End:this.state.ForceEnd();break;case A.CommandType.ListFromInt:var q=parseInt(this.state.PopEvaluationStack()),K=this.state.PopEvaluationStack().toString();if(null==q)throw new p("Passed non-integer when creating a list element from a numerical value.");var $,X=null;if(!($=this.listDefinitions.TryListGetDefinition(K,$)))throw new p("Failed to find LIST called "+K.value);var Y=$.TryGetItemWithValue(q);Y.exists&&(X=new C(Y.item,q)),null==X&&(X=new C),this.state.PushEvaluationStack(X);break;case A.CommandType.ListRange:var Z=this.state.PopEvaluationStack(),Q=this.state.PopEvaluationStack(),z=this.state.PopEvaluationStack();if(z instanceof C==0||null==z||null==Q||null==Z)throw new p("Expected list, minimum and maximum for LIST_RANGE");var tt=function(t){return t instanceof C?parseInt(t.value.maxItem.Value):t instanceof y?t.value:-1},et=tt(Q),nt=tt(Z);if(-1==et)throw new p("Invalid min range bound passed to LIST_VALUE(): "+Q);if(-1==nt)throw new p("Invalid max range bound passed to LIST_VALUE(): "+Z);var it=new C,rt=z.value.origins;null!=rt&&rt.forEach(function(t){t.ListRange(et,nt).value.forEach(function(t){it.value.Add(t.Key,t.Value)})}),this.state.PushEvaluationStack(it);break;default:this.Error("unhandled ControlCommand: "+o)}return!0}if(t instanceof F){return this.state.variablesState.Assign(t,this.state.PopEvaluationStack()),!0}if(t instanceof V){var at=t,ot=null;if(null!=at.pathForCount){var st=at.containerForCount;H=this.VisitCountForContainer(st),ot=new y(H)}else if(null==(ot=this.state.variablesState.GetVariableWithName(at.name))){var ut=this.state.variablesState.TryGetDefaultVariableValue(at.name);null!=ut?(this.Warning("Variable not found in save state: '"+at.name+"', but seems to have been newly created. Assigning value from latest ink's declaration: "+ut),ot=ut,state.variablesState.SetGlobal(at.name,ot)):(this.Warning("Variable not found: '"+at.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit."),ot=new y(0))}return this.state.PushEvaluationStack(ot),!0}if(t instanceof j){var lt=t,ct=this.state.PopEvaluationStack(lt.numberOfParameters);return it=lt.Call(ct),this.state.PushEvaluationStack(it),!0}return!1}},{key:"ChoosePathString",value:function(t,e,i){if(e=void 0===e||e,i=i||[],this.IfAsyncWeCant("call ChoosePathString right now"),e)this.ResetCallstack();else if(this.state.callStack.currentElement.type==E.Function){var r="",a=this.state.callStack.currentElement.currentPointer.container;throw null!=a&&(r="("+a.path.toString()+") "),"Story was running a function "+r+"when you called ChoosePathString("+t+") - this is almost certainly not not what you want! Full stack trace: \n"+this.state.callStack.callStackTrace}this.state.PassArgumentsToEvaluationStack(i),this.ChoosePath(new n(t))}},{key:"IfAsyncWeCant",value:function(t){if(this._asyncContinueActive)throw"Can't "+t+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand."}},{key:"ChoosePath",value:function(t){this.state.SetChosenPath(t),this.VisitChangedContainersDueToDivert()}},{key:"ChooseChoiceIndex",value:function(t){t=t;var e=this.currentChoices;(t<0||t>e.length)&&console.warn("choice out of range");var n=e[t];this.state.callStack.currentThread=n.threadAtGeneration,this.ChoosePath(n.targetPath)}},{key:"HasFunction",value:function(t){try{return null!=this.KnotContainerWithName(t)}catch(t){return!1}}},{key:"EvaluateFunction",value:function(t,e,n){if(n=!!n,this.IfAsyncWeCant("evaluate a function"),null==t)throw"Function is null";if(""==t||""==t.trim())throw"Function is empty or white space.";var i=this.KnotContainerWithName(t);if(null==i)throw"Function doesn't exist: '"+t+"'";var r=[];r.push.apply(r,this.state.outputStream),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(i,e);for(var a=new l;this.canContinue;)a.Append(this.Continue());var o=a.toString();this._state.ResetOutput(r);var s=this.state.CompleteFunctionEvaluationFromGame();return n?{returned:s,output:o}:s}},{key:"EvaluateExpression",value:function(t){var e=this.state.callStack.elements.length;this.state.callStack.Push(E.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart();var n=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.PopCallStack(),this.state.evaluationStack.length>n?this.state.PopEvaluationStack():null}},{key:"CallExternalFunction",value:function(t,e){var n=this._externals[t],i=null;if(void 0===n){if(this.allowExternalFunctionFallbacks)return(i=this.KnotContainerWithName(t))instanceof w||console.warn("Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(E.Function,void 0,this.state.outputStream.length),void(this.state.divertedPointer=P.StartOf(i));console.warn("Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}for(var r=[],a=0;a<e;++a){r.push(this.state.PopEvaluationStack().valueObject)}r.reverse();var o=n(r),s=null;null!=o?null==(s=m.Create(o))&&console.warn("Could not create ink value from returned object of type "+(void 0===o?"undefined":h(o))):s=new L,this.state.PushEvaluationStack(s)}},{key:"TryCoerce",value:function(t){return t}},{key:"BindExternalFunctionGeneral",value:function(t,e){this.IfAsyncWeCant("bind an external function"),this._externals[t]&&console.warn("Function '"+t+"' has already been bound."),this._externals[t]=e}},{key:"BindExternalFunction",value:function(t,e){var n=this;e||console.warn("Can't bind a null function"),this.BindExternalFunctionGeneral(t,function(t){t.length<e.length&&console.warn("External function expected "+e.length+" arguments");for(var i=[],r=0,a=t.length;r<a;r++)i[r]=n.TryCoerce(t[r]);return e.apply(null,i)})}},{key:"UnbindExternalFunction",value:function(t){this.IfAsyncWeCant("unbind an external a function"),void 0===this._externals[t]&&console.warn("Function '"+t+"' has not been bound."),delete this._externals[t]}},{key:"ValidateExternalBindings",value:function(t,e){var n=this;if(t)if(t instanceof w){var i=t;for(var r in i.content.forEach(function(t){n.ValidateExternalBindings(t,e)}),i.namedContent)this.ValidateExternalBindings(i.namedContent[r],e)}else{var a=t;if(a instanceof I&&a.isExternal){var o=a.targetPathString;this._externals[o]||(this.allowExternalFunctionFallbacks?!!this.mainContentContainer.namedContent[o]||e.push(o):e.push(o))}}else if(e=[],this.ValidateExternalBindings(this._mainContentContainer,e),this._hasValidatedExternals=!0,0==e.length)this._hasValidatedExternals=!0;else{var s="Error: Missing function binding for external";s+=e.length>1?"s":"",s+=": '",s+=e.join("', '"),s+="' ",s+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(s)}}},{key:"ObserveVariable",value:function(t,e){if(this.IfAsyncWeCant("observe a new variable"),null==this._variableObservers&&(this._variableObservers={}),!this.state.variablesState.GlobalVariableExistsWithName(t))throw new p("Cannot observe variable '"+t+"' because it wasn't declared in the ink story.");this._variableObservers[t]?this._variableObservers[t].push(e):this._variableObservers[t]=[e]}},{key:"ObserveVariables",value:function(t,e){for(var n=0,i=t.length;n<i;n++)this.ObserveVariable(t[n],e[n])}},{key:"RemoveVariableObserver",value:function(t,e){if(this.IfAsyncWeCant("remove a variable observer"),null!=this._variableObservers)if(void 0!==e)this._variableObservers[e]&&this._variableObservers[e].splice(this._variableObservers[e].indexOf(t),1);else for(var n in this._variableObservers)this._variableObservers[n].splice(this._variableObservers[n].indexOf(t),1)}},{key:"VariableStateDidChangeEvent",value:function(t,e){if(null!=this._variableObservers){var n=this._variableObservers[t];if(void 0!==n){if(!(e instanceof m))throw"Tried to get the value of a variable that isn't a standard type";var i=e;n.forEach(function(e){e(t,i.valueObject)})}}}},{key:"TagsForContentAtPath",value:function(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}},{key:"TagsAtStartOfFlowContainerWithPathString",value:function(t){for(var e=new n(t),i=this.ContentAtPath(e).container;;){var r=i.content[0];if(!(r instanceof w))break;i=r}var a=null;return i.content.every(function(t){var e=t;return e instanceof D&&(null==a&&(a=[]),a.push(e.text),!0)}),a}},{key:"BuildStringOfHierarchy",value:function(){var t=new l;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}},{key:"BuildStringOfContainer",value:function(t){var e=new l;return t.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}},{key:"NextContent",value:function(){if(this.state.previousPointer=this.state.currentPointer.copy(),(this.state.divertedPointer.isNull||(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=P.Null,this.VisitChangedContainersDueToDivert(),this.state.currentPointer.isNull))&&!this.IncrementContentPointer()){var t=!1;this.state.callStack.CanPop(E.Function)?(this.state.PopCallStack(E.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new L),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitFunctionEvaluationFromGame(),t&&!this.state.currentPointer.isNull&&this.NextContent()}}},{key:"IncrementContentPointer",value:function(){var t=!0,e=this.state.callStack.currentElement.currentPointer.copy();for(e.index++;e.index>=e.container.content.length;){t=!1;var n=e.container.parent;if(n instanceof w==0)break;var i=n.content.indexOf(e.container);if(-1==i)break;(e=new P(n,i)).index++,t=!0}return t||(e=P.Null),this.state.callStack.currentElement.currentPointer=e.copy(),t}},{key:"TryFollowDefaultInvisibleChoice",value:function(){var t=this._state.currentChoices,e=t.filter(function(t){return t.isInvisibleDefault});return!(0==e.length||t.length>e.length)&&(this.ChoosePath(e[0].targetPath),!0)}},{key:"VisitCountForContainer",value:function(t){if(!t.visitsShouldBeCounted)return console.warn("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;var e=0;return e=this.state.visitCounts[t.path.toString()]||e}},{key:"IncrementVisitCountForContainer",value:function(t){var e=0,n=t.path.toString();this.state.visitCounts[n]&&(e=this.state.visitCounts[n]),e++,this.state.visitCounts[n]=e}},{key:"RecordTurnIndexVisitToContainer",value:function(t){this.state.turnIndices[t.path.toString()]=this.state.currentTurnIndex}},{key:"TurnsSinceForContainer",value:function(t){t.turnIndexShouldBeCounted||this.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c).");var e=t.path.toString(),n=this.state.turnIndices[e];return void 0!==n?this.state.currentTurnIndex-n:-1}},{key:"NextSequenceShuffleIndex",value:function(){var t=this.state.PopEvaluationStack();if(!(t instanceof y))return this.Error("expected number of elements in sequence for shuffle index"),0;for(var e=this.state.currentPointer.container,n=t.value,i=this.state.PopEvaluationStack().value,r=i/n,a=i%n,o=e.path.toString(),s=0,u=0,l=o.length;u<l;u++)s+=o.charCodeAt(u)||0;var c=s+r+this.state.storySeed,h=new U(parseInt(c)),f=[];for(u=0;u<n;++u)f.push(u);for(u=0;u<=a;++u){var d=h.next()%f.length,p=f[d];if(f.splice(d,1),u==a)return p}throw"Should never reach here"}},{key:"Error",value:function(t){throw new p(t)}},{key:"Warning",value:function(t){this.AddError(t,!0)}},{key:"AddError",value:function(t,e){var n=e?"WARNING":"ERROR";t=this.state.currentPointer.isNull?"RUNTIME "+n+": "+t:"RUNTIME "+n+": ("+this.state.currentPath+"): "+t,this.state.AddError(t,e),e||this.state.ForceEnd()}},{key:"currentChoices",get:function(){var t=[];return this._state.currentChoices.forEach(function(e){e.isInvisibleDefault||(e.index=t.length,t.push(e))}),t}},{key:"currentText",get:function(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}},{key:"currentTags",get:function(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}},{key:"currentErrors",get:function(){return this.state.currentErrors}},{key:"currentWarnings",get:function(){return this.state.currentWarnings}},{key:"hasError",get:function(){return this.state.hasError}},{key:"hasWarning",get:function(){return this.state.hasWarning}},{key:"variablesState",get:function(){return this.state.variablesState}},{key:"listDefinitions",get:function(){return this._listDefinitions}},{key:"state",get:function(){return this._state}},{key:"mainContentContainer",get:function(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}},{key:"canContinue",get:function(){return this.state.canContinue}},{key:"asyncContinueComplete",get:function(){return!this._asyncContinueActive}},{key:"globalTags",get:function(){return this.TagsAtStartOfFlowContainerWithPathString("")}}]),t}(),Q={NoChange:0,ExtendedBeyondNewline:1,NewlineRemoved:2};t.Story=Z,t.InkList=d,Object.defineProperty(t,"__esModule",{value:!0})})},function(t,n){"use strict";function i(t){var e={};return t.forEach(function(t){var n=t.split(":"),i=n[0].trim(),r=n.slice(1).join(":").trim(),a=r.substr(0,1);"{"!==a&&"["!==a||(r=JSON.parse(r)),e[i]=r}),e}Object.defineProperty(n,"__esModule",{value:!0}),n.default=function(t,n){for(var r={type:"text",content:[],text:[],tags:{},choices:[]};t.canContinue;){t.Continue();var a=t.currentText;if(0===a.indexOf(">>>")){var o=n.run(a);o&&r.text.push(o)}else r.text.push(a);var s=i(t.currentTags);s.scene&&(r.type=s.scene),r.tags=e({},r.tags,s),r.content.push({text:a,tags:s})}return t.currentChoices.forEach(function(t,e){r.choices.push({id:e,choice:t.text})}),r}},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();e.default=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.dependencies=e,this.commands={}}return n(t,[{key:"register",value:function(t,e,n){this.commands[t]={callback:e,deps:n}}},{key:"run",value:function(t){var e=this,n=t.replace(/(\r\n\t|\n|\r\t)/gm,"").split(" "),i=n[1],r=n.slice(2);if(!(i in this.commands))return t;var a=this.commands[i],o=[];return a.deps&&a.deps.forEach(function(t){o.push(e.dependencies[t])}),a.callback.apply(a,[r].concat(o))}}]),t}()},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();e.default=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.observers={}}return n(t,[{key:"register",value:function(t){var e=this;Object.keys(t).forEach(function(n){e.observers[n]=t[n]})}},{key:"attach",value:function(t){var e=this;Object.keys(this.observers).forEach(function(n){t.observeVar(n,e.observers[n])})}}]),t}()},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();e.default=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.functions={}}return n(t,[{key:"register",value:function(t){var e=this;Object.keys(t).forEach(function(n){e.functions[n]=t[n]})}},{key:"attach",value:function(t){var e=this;Object.keys(this.functions).forEach(function(n){t.bindFunction(n,e.functions[n])})}}]),t}()}])})},"aA/P":function(t){t.exports={choice:"choice__3HkX2",endEpisode:"endEpisode__1IBfH"}},h6ac:function(t){var e;e=function(){return this}();try{e=e||Function("return this")()||(0,eval)("this")}catch(t){"object"==typeof window&&(e=window)}t.exports=e},hAVL:function(t){t.exports={sound:"sound__3_d27"}},lyKV:function(t,e,n){(function(n){var i,r;!function(){"use strict";var a=function(){this.init()};a.prototype={init:function(){var t=this||o;return t._counter=1e3,t._codecs={},t._howls=[],t._muted=!1,t._volume=1,t._canPlayEvent="canplaythrough",t._navigator="undefined"!=typeof window&&window.navigator?window.navigator:null,t.masterGain=null,t.noAudio=!1,t.usingWebAudio=!0,t.autoSuspend=!0,t.ctx=null,t.mobileAutoEnable=!0,t._setup(),t},volume:function(t){var e=this||o;if(t=parseFloat(t),e.ctx||p(),void 0!==t&&t>=0&&t<=1){if(e._volume=t,e._muted)return e;e.usingWebAudio&&e.masterGain.gain.setValueAtTime(t,o.ctx.currentTime);for(var n=0;n<e._howls.length;n++)if(!e._howls[n]._webAudio)for(var i=e._howls[n]._getSoundIds(),r=0;r<i.length;r++){var a=e._howls[n]._soundById(i[r]);a&&a._node&&(a._node.volume=a._volume*t)}return e}return e._volume},mute:function(t){var e=this||o;e.ctx||p(),e._muted=t,e.usingWebAudio&&e.masterGain.gain.setValueAtTime(t?0:e._volume,o.ctx.currentTime);for(var n=0;n<e._howls.length;n++)if(!e._howls[n]._webAudio)for(var i=e._howls[n]._getSoundIds(),r=0;r<i.length;r++){var a=e._howls[n]._soundById(i[r]);a&&a._node&&(a._node.muted=!!t||a._muted)}return e},unload:function(){for(var t=this||o,e=t._howls.length-1;e>=0;e--)t._howls[e].unload();return t.usingWebAudio&&t.ctx&&void 0!==t.ctx.close&&(t.ctx.close(),t.ctx=null,p()),t},codecs:function(t){return(this||o)._codecs[t.replace(/^x-/,"")]},_setup:function(){var t=this||o;if(t.state=t.ctx?t.ctx.state||"running":"running",t._autoSuspend(),!t.usingWebAudio)if("undefined"!=typeof Audio)try{var e=new Audio;void 0===e.oncanplaythrough&&(t._canPlayEvent="canplay")}catch(e){t.noAudio=!0}else t.noAudio=!0;try{var e=new Audio;e.muted&&(t.noAudio=!0)}catch(t){}return t.noAudio||t._setupCodecs(),t},_setupCodecs:function(){var t=this||o,e=null;try{e="undefined"!=typeof Audio?new Audio:null}catch(e){return t}if(!e||"function"!=typeof e.canPlayType)return t;var n=e.canPlayType("audio/mpeg;").replace(/^no$/,""),i=t._navigator&&t._navigator.userAgent.match(/OPR\/([0-6].)/g),r=i&&parseInt(i[0].split("/")[1],10)<33;return t._codecs={mp3:!(r||!n&&!e.canPlayType("audio/mp3;").replace(/^no$/,"")),mpeg:!!n,opus:!!e.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!e.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!e.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!e.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),aac:!!e.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!e.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(e.canPlayType("audio/x-m4a;")||e.canPlayType("audio/m4a;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(e.canPlayType("audio/x-mp4;")||e.canPlayType("audio/mp4;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!e.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),webm:!!e.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,""),dolby:!!e.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(e.canPlayType("audio/x-flac;")||e.canPlayType("audio/flac;")).replace(/^no$/,"")},t},_enableMobileAudio:function(){var t=this||o,e=/iPhone|iPad|iPod|Android|BlackBerry|BB10|Silk|Mobi|Chrome/i.test(t._navigator&&t._navigator.userAgent);if(!t._mobileEnabled&&t.ctx&&e){t._mobileEnabled=!1,t.mobileAutoEnable=!1,t._mobileUnloaded||44100===t.ctx.sampleRate||(t._mobileUnloaded=!0,t.unload()),t._scratchBuffer=t.ctx.createBuffer(1,1,22050);var n=function e(n){n.preventDefault(),o._autoResume();var i=t.ctx.createBufferSource();i.buffer=t._scratchBuffer,i.connect(t.ctx.destination),void 0===i.start?i.noteOn(0):i.start(0),"function"==typeof t.ctx.resume&&t.ctx.resume(),i.onended=function(){i.disconnect(0),t._mobileEnabled=!0,document.removeEventListener("touchstart",e,!0),document.removeEventListener("touchend",e,!0),document.removeEventListener("click",e,!0);for(var n=0;n<t._howls.length;n++)t._howls[n]._emit("unlock")}};return document.addEventListener("touchstart",n,!0),document.addEventListener("touchend",n,!0),document.addEventListener("click",n,!0),t}},_autoSuspend:function(){var t=this;if(t.autoSuspend&&t.ctx&&void 0!==t.ctx.suspend&&o.usingWebAudio){for(var e=0;e<t._howls.length;e++)if(t._howls[e]._webAudio)for(var n=0;n<t._howls[e]._sounds.length;n++)if(!t._howls[e]._sounds[n]._paused)return t;return t._suspendTimer&&clearTimeout(t._suspendTimer),t._suspendTimer=setTimeout(function(){t.autoSuspend&&(t._suspendTimer=null,t.state="suspending",t.ctx.suspend().then(function(){t.state="suspended",t._resumeAfterSuspend&&(delete t._resumeAfterSuspend,t._autoResume())}))},3e4),t}},_autoResume:function(){var t=this;if(t.ctx&&void 0!==t.ctx.resume&&o.usingWebAudio)return"running"===t.state&&t._suspendTimer?(clearTimeout(t._suspendTimer),t._suspendTimer=null):"suspended"===t.state?(t.ctx.resume().then(function(){t.state="running";for(var e=0;e<t._howls.length;e++)t._howls[e]._emit("resume")}),t._suspendTimer&&(clearTimeout(t._suspendTimer),t._suspendTimer=null)):"suspending"===t.state&&(t._resumeAfterSuspend=!0),t}};var o=new a,s=function(t){var e=this;if(!t.src||0===t.src.length)return void console.error("An array of source files must be passed with any new Howl.");e.init(t)};s.prototype={init:function(t){var e=this;return o.ctx||p(),e._autoplay=t.autoplay||!1,e._format="string"!=typeof t.format?t.format:[t.format],e._html5=t.html5||!1,e._muted=t.mute||!1,e._loop=t.loop||!1,e._pool=t.pool||5,e._preload="boolean"!=typeof t.preload||t.preload,e._rate=t.rate||1,e._sprite=t.sprite||{},e._src="string"!=typeof t.src?t.src:[t.src],e._volume=void 0!==t.volume?t.volume:1,e._xhrWithCredentials=t.xhrWithCredentials||!1,e._duration=0,e._state="unloaded",e._sounds=[],e._endTimers={},e._queue=[],e._playLock=!1,e._onend=t.onend?[{fn:t.onend}]:[],e._onfade=t.onfade?[{fn:t.onfade}]:[],e._onload=t.onload?[{fn:t.onload}]:[],e._onloaderror=t.onloaderror?[{fn:t.onloaderror}]:[],e._onplayerror=t.onplayerror?[{fn:t.onplayerror}]:[],e._onpause=t.onpause?[{fn:t.onpause}]:[],e._onplay=t.onplay?[{fn:t.onplay}]:[],e._onstop=t.onstop?[{fn:t.onstop}]:[],e._onmute=t.onmute?[{fn:t.onmute}]:[],e._onvolume=t.onvolume?[{fn:t.onvolume}]:[],e._onrate=t.onrate?[{fn:t.onrate}]:[],e._onseek=t.onseek?[{fn:t.onseek}]:[],e._onunlock=t.onunlock?[{fn:t.onunlock}]:[],e._onresume=[],e._webAudio=o.usingWebAudio&&!e._html5,void 0!==o.ctx&&o.ctx&&o.mobileAutoEnable&&o._enableMobileAudio(),o._howls.push(e),e._autoplay&&e._queue.push({event:"play",action:function(){e.play()}}),e._preload&&e.load(),e},load:function(){var t=this,e=null;if(o.noAudio)return void t._emit("loaderror",null,"No audio support.");"string"==typeof t._src&&(t._src=[t._src]);for(var n=0;n<t._src.length;n++){var i,r;if(t._format&&t._format[n])i=t._format[n];else{if("string"!=typeof(r=t._src[n])){t._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}i=/^data:audio\/([^;,]+);/i.exec(r),i||(i=/\.([^.]+)$/.exec(r.split("?",1)[0])),i&&(i=i[1].toLowerCase())}if(i||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),i&&o.codecs(i)){e=t._src[n];break}}return e?(t._src=e,t._state="loading","https:"===window.location.protocol&&"http:"===e.slice(0,5)&&(t._html5=!0,t._webAudio=!1),new u(t),t._webAudio&&c(t),t):void t._emit("loaderror",null,"No codec support for selected audio sources.")},play:function(t,e){var n=this,i=null;if("number"==typeof t)i=t,t=null;else{if("string"==typeof t&&"loaded"===n._state&&!n._sprite[t])return null;if(void 0===t){t="__default";for(var r=0,a=0;a<n._sounds.length;a++)n._sounds[a]._paused&&!n._sounds[a]._ended&&(r++,i=n._sounds[a]._id);1===r?t=null:i=null}}var s=i?n._soundById(i):n._inactiveSound();if(!s)return null;if(i&&!t&&(t=s._sprite||"__default"),"loaded"!==n._state){s._sprite=t,s._ended=!1;var u=s._id;return n._queue.push({event:"play",action:function(){n.play(u)}}),u}if(i&&!s._paused)return e||n._loadQueue("play"),s._id;n._webAudio&&o._autoResume();var l=Math.max(0,s._seek>0?s._seek:n._sprite[t][0]/1e3),c=Math.max(0,(n._sprite[t][0]+n._sprite[t][1])/1e3-l),h=1e3*c/Math.abs(s._rate);if(s._paused=!1,s._ended=!1,s._sprite=t,s._seek=l,s._start=n._sprite[t][0]/1e3,s._stop=(n._sprite[t][0]+n._sprite[t][1])/1e3,s._loop=!(!s._loop&&!n._sprite[t][2]),s._seek>=s._stop)return void n._ended(s);var f=s._node;if(n._webAudio){var d=function(){n._refreshBuffer(s),f.gain.setValueAtTime(s._muted||n._muted?0:s._volume,o.ctx.currentTime),s._playStart=o.ctx.currentTime,void 0===f.bufferSource.start?s._loop?f.bufferSource.noteGrainOn(0,l,86400):f.bufferSource.noteGrainOn(0,l,c):s._loop?f.bufferSource.start(0,l,86400):f.bufferSource.start(0,l,c),h!==1/0&&(n._endTimers[s._id]=setTimeout(n._ended.bind(n,s),h)),e||setTimeout(function(){n._emit("play",s._id)},0)};"running"===o.state?d():(n.once("resume",d),n._clearTimer(s._id))}else{var p=function(){f.currentTime=l,f.muted=s._muted||n._muted||o._muted||f.muted,f.volume=s._volume*o.volume(),f.playbackRate=s._rate;try{var i=f.play();if("undefined"!=typeof Promise&&(i instanceof Promise||"function"==typeof i.then)?(n._playLock=!0,i.then(function(){n._playLock=!1,e||n._emit("play",s._id)}).catch(function(){n._playLock=!1,n._emit("playerror",s._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.")})):e||n._emit("play",s._id),f.playbackRate=s._rate,f.paused)return void n._emit("playerror",s._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");"__default"!==t||s._loop?n._endTimers[s._id]=setTimeout(n._ended.bind(n,s),h):(n._endTimers[s._id]=function(){n._ended(s),f.removeEventListener("ended",n._endTimers[s._id],!1)},f.addEventListener("ended",n._endTimers[s._id],!1))}catch(t){n._emit("playerror",s._id,t)}},v=window&&window.ejecta||!f.readyState&&o._navigator.isCocoonJS;if(f.readyState>=3||v)p();else{f.addEventListener(o._canPlayEvent,function t(){p(),f.removeEventListener(o._canPlayEvent,t,!1)},!1),n._clearTimer(s._id)}}return s._id},pause:function(t){var e=this;if("loaded"!==e._state||e._playLock)return e._queue.push({event:"pause",action:function(){e.pause(t)}}),e;for(var n=e._getSoundIds(t),i=0;i<n.length;i++){e._clearTimer(n[i]);var r=e._soundById(n[i]);if(r&&!r._paused&&(r._seek=e.seek(n[i]),r._rateSeek=0,r._paused=!0,e._stopFade(n[i]),r._node))if(e._webAudio){if(!r._node.bufferSource)continue;void 0===r._node.bufferSource.stop?r._node.bufferSource.noteOff(0):r._node.bufferSource.stop(0),e._cleanBuffer(r._node)}else isNaN(r._node.duration)&&r._node.duration!==1/0||r._node.pause();arguments[1]||e._emit("pause",r?r._id:null)}return e},stop:function(t,e){var n=this;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"stop",action:function(){n.stop(t)}}),n;for(var i=n._getSoundIds(t),r=0;r<i.length;r++){n._clearTimer(i[r]);var a=n._soundById(i[r]);a&&(a._seek=a._start||0,a._rateSeek=0,a._paused=!0,a._ended=!0,n._stopFade(i[r]),a._node&&(n._webAudio?a._node.bufferSource&&(void 0===a._node.bufferSource.stop?a._node.bufferSource.noteOff(0):a._node.bufferSource.stop(0),n._cleanBuffer(a._node)):isNaN(a._node.duration)&&a._node.duration!==1/0||(a._node.currentTime=a._start||0,a._node.pause())),e||n._emit("stop",a._id))}return n},mute:function(t,e){var n=this;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"mute",action:function(){n.mute(t,e)}}),n;if(void 0===e){if("boolean"!=typeof t)return n._muted;n._muted=t}for(var i=n._getSoundIds(e),r=0;r<i.length;r++){var a=n._soundById(i[r]);a&&(a._muted=t,a._interval&&n._stopFade(a._id),n._webAudio&&a._node?a._node.gain.setValueAtTime(t?0:a._volume,o.ctx.currentTime):a._node&&(a._node.muted=!!o._muted||t),n._emit("mute",a._id))}return n},volume:function(){var t,e,n=this,i=arguments;if(0===i.length)return n._volume;if(1===i.length||2===i.length&&void 0===i[1]){n._getSoundIds().indexOf(i[0])>=0?e=parseInt(i[0],10):t=parseFloat(i[0])}else i.length>=2&&(t=parseFloat(i[0]),e=parseInt(i[1],10));var r;if(!(void 0!==t&&t>=0&&t<=1))return r=e?n._soundById(e):n._sounds[0],r?r._volume:0;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"volume",action:function(){n.volume.apply(n,i)}}),n;void 0===e&&(n._volume=t),e=n._getSoundIds(e);for(var a=0;a<e.length;a++)(r=n._soundById(e[a]))&&(r._volume=t,i[2]||n._stopFade(e[a]),n._webAudio&&r._node&&!r._muted?r._node.gain.setValueAtTime(t,o.ctx.currentTime):r._node&&!r._muted&&(r._node.volume=t*o.volume()),n._emit("volume",r._id));return n},fade:function(t,e,n,i){var r=this;if("loaded"!==r._state||r._playLock)return r._queue.push({event:"fade",action:function(){r.fade(t,e,n,i)}}),r;r.volume(t,i);for(var a=r._getSoundIds(i),s=0;s<a.length;s++){var u=r._soundById(a[s]);if(u){if(i||r._stopFade(a[s]),r._webAudio&&!u._muted){var l=o.ctx.currentTime,c=l+n/1e3;u._volume=t,u._node.gain.setValueAtTime(t,l),u._node.gain.linearRampToValueAtTime(e,c)}r._startFadeInterval(u,t,e,n,a[s],void 0===i)}}return r},_startFadeInterval:function(t,e,n,i,r,a){var o=this,s=e,u=n-e,l=Math.abs(u/.01),c=Math.max(4,l>0?i/l:i),h=Date.now();t._fadeTo=n,t._interval=setInterval(function(){var r=(Date.now()-h)/i;h=Date.now(),s+=u*r,s=Math.max(0,s),s=Math.min(1,s),s=Math.round(100*s)/100,o._webAudio?t._volume=s:o.volume(s,t._id,!0),a&&(o._volume=s),(n<e&&s<=n||n>e&&s>=n)&&(clearInterval(t._interval),t._interval=null,t._fadeTo=null,o.volume(n,t._id),o._emit("fade",t._id))},c)},_stopFade:function(t){var e=this,n=e._soundById(t);return n&&n._interval&&(e._webAudio&&n._node.gain.cancelScheduledValues(o.ctx.currentTime),clearInterval(n._interval),n._interval=null,e.volume(n._fadeTo,t),n._fadeTo=null,e._emit("fade",t)),e},loop:function(){var t,e,n,i=this,r=arguments;if(0===r.length)return i._loop;if(1===r.length){if("boolean"!=typeof r[0])return!!(n=i._soundById(parseInt(r[0],10)))&&n._loop;t=r[0],i._loop=t}else 2===r.length&&(t=r[0],e=parseInt(r[1],10));for(var a=i._getSoundIds(e),o=0;o<a.length;o++)(n=i._soundById(a[o]))&&(n._loop=t,i._webAudio&&n._node&&n._node.bufferSource&&(n._node.bufferSource.loop=t,t&&(n._node.bufferSource.loopStart=n._start||0,n._node.bufferSource.loopEnd=n._stop)));return i},rate:function(){var t,e,n=this,i=arguments;if(0===i.length)e=n._sounds[0]._id;else if(1===i.length){var r=n._getSoundIds(),a=r.indexOf(i[0]);a>=0?e=parseInt(i[0],10):t=parseFloat(i[0])}else 2===i.length&&(t=parseFloat(i[0]),e=parseInt(i[1],10));var s;if("number"!=typeof t)return s=n._soundById(e),s?s._rate:n._rate;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"rate",action:function(){n.rate.apply(n,i)}}),n;void 0===e&&(n._rate=t),e=n._getSoundIds(e);for(var u=0;u<e.length;u++)if(s=n._soundById(e[u])){s._rateSeek=n.seek(e[u]),s._playStart=n._webAudio?o.ctx.currentTime:s._playStart,s._rate=t,n._webAudio&&s._node&&s._node.bufferSource?s._node.bufferSource.playbackRate.setValueAtTime(t,o.ctx.currentTime):s._node&&(s._node.playbackRate=t);var l=n.seek(e[u]),c=(n._sprite[s._sprite][0]+n._sprite[s._sprite][1])/1e3-l,h=1e3*c/Math.abs(s._rate);!n._endTimers[e[u]]&&s._paused||(n._clearTimer(e[u]),n._endTimers[e[u]]=setTimeout(n._ended.bind(n,s),h)),n._emit("rate",s._id)}return n},seek:function(){var t,e,n=this,i=arguments;if(0===i.length)e=n._sounds[0]._id;else if(1===i.length){var r=n._getSoundIds(),a=r.indexOf(i[0]);a>=0?e=parseInt(i[0],10):n._sounds.length&&(e=n._sounds[0]._id,t=parseFloat(i[0]))}else 2===i.length&&(t=parseFloat(i[0]),e=parseInt(i[1],10));if(void 0===e)return n;if("loaded"!==n._state||n._playLock)return n._queue.push({event:"seek",action:function(){n.seek.apply(n,i)}}),n;var s=n._soundById(e);if(s){if(!("number"==typeof t&&t>=0)){if(n._webAudio){var u=n.playing(e)?o.ctx.currentTime-s._playStart:0;return s._seek+((s._rateSeek?s._rateSeek-s._seek:0)+u*Math.abs(s._rate))}return s._node.currentTime}var l=n.playing(e);l&&n.pause(e,!0),s._seek=t,s._ended=!1,n._clearTimer(e),!n._webAudio&&s._node&&(s._node.currentTime=t);var c=function(){n._emit("seek",e),l&&n.play(e,!0)};if(l&&!n._webAudio){var h=function t(){n._playLock?setTimeout(t,0):c()};setTimeout(h,0)}else c()}return n},playing:function(t){var e=this;if("number"==typeof t){var n=e._soundById(t);return!!n&&!n._paused}for(var i=0;i<e._sounds.length;i++)if(!e._sounds[i]._paused)return!0;return!1},duration:function(t){var e=this,n=e._duration,i=e._soundById(t);return i&&(n=e._sprite[i._sprite][1]/1e3),n},state:function(){return this._state},unload:function(){for(var t=this,e=t._sounds,n=0;n<e.length;n++){if(e[n]._paused||t.stop(e[n]._id),!t._webAudio){/MSIE |Trident\//.test(o._navigator&&o._navigator.userAgent)||(e[n]._node.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"),e[n]._node.removeEventListener("error",e[n]._errorFn,!1),e[n]._node.removeEventListener(o._canPlayEvent,e[n]._loadFn,!1)}delete e[n]._node,t._clearTimer(e[n]._id)}var i=o._howls.indexOf(t);i>=0&&o._howls.splice(i,1);var r=!0;for(n=0;n<o._howls.length;n++)if(o._howls[n]._src===t._src){r=!1;break}return l&&r&&delete l[t._src],o.noAudio=!1,t._state="unloaded",t._sounds=[],t=null,null},on:function(t,e,n,i){var r=this,a=r["_on"+t];return"function"==typeof e&&a.push(i?{id:n,fn:e,once:i}:{id:n,fn:e}),r},off:function(t,e,n){var i=this,r=i["_on"+t],a=0;if("number"==typeof e&&(n=e,e=null),e||n)for(a=0;a<r.length;a++){var o=n===r[a].id;if(e===r[a].fn&&o||!e&&o){r.splice(a,1);break}}else if(t)i["_on"+t]=[];else{var s=Object.keys(i);for(a=0;a<s.length;a++)0===s[a].indexOf("_on")&&Array.isArray(i[s[a]])&&(i[s[a]]=[])}return i},once:function(t,e,n){var i=this;return i.on(t,e,n,1),i},_emit:function(t,e,n){for(var i=this,r=i["_on"+t],a=r.length-1;a>=0;a--)r[a].id&&r[a].id!==e&&"load"!==t||(setTimeout(function(t){t.call(this,e,n)}.bind(i,r[a].fn),0),r[a].once&&i.off(t,r[a].fn,r[a].id));return i._loadQueue(t),i},_loadQueue:function(t){var e=this;if(e._queue.length>0){var n=e._queue[0];n.event===t&&(e._queue.shift(),e._loadQueue()),t||n.action()}return e},_ended:function(t){var e=this,n=t._sprite;if(!e._webAudio&&t._node&&!t._node.paused&&!t._node.ended&&t._node.currentTime<t._stop)return setTimeout(e._ended.bind(e,t),100),e;var i=!(!t._loop&&!e._sprite[n][2]);if(e._emit("end",t._id),!e._webAudio&&i&&e.stop(t._id,!0).play(t._id),e._webAudio&&i){e._emit("play",t._id),t._seek=t._start||0,t._rateSeek=0,t._playStart=o.ctx.currentTime;var r=1e3*(t._stop-t._start)/Math.abs(t._rate);e._endTimers[t._id]=setTimeout(e._ended.bind(e,t),r)}return e._webAudio&&!i&&(t._paused=!0,t._ended=!0,t._seek=t._start||0,t._rateSeek=0,e._clearTimer(t._id),e._cleanBuffer(t._node),o._autoSuspend()),e._webAudio||i||e.stop(t._id,!0),e},_clearTimer:function(t){var e=this;if(e._endTimers[t]){if("function"!=typeof e._endTimers[t])clearTimeout(e._endTimers[t]);else{var n=e._soundById(t);n&&n._node&&n._node.removeEventListener("ended",e._endTimers[t],!1)}delete e._endTimers[t]}return e},_soundById:function(t){for(var e=this,n=0;n<e._sounds.length;n++)if(t===e._sounds[n]._id)return e._sounds[n];return null},_inactiveSound:function(){var t=this;t._drain();for(var e=0;e<t._sounds.length;e++)if(t._sounds[e]._ended)return t._sounds[e].reset();return new u(t)},_drain:function(){var t=this,e=t._pool,n=0,i=0;if(!(t._sounds.length<e)){for(i=0;i<t._sounds.length;i++)t._sounds[i]._ended&&n++;for(i=t._sounds.length-1;i>=0;i--){if(n<=e)return;t._sounds[i]._ended&&(t._webAudio&&t._sounds[i]._node&&t._sounds[i]._node.disconnect(0),t._sounds.splice(i,1),n--)}}},_getSoundIds:function(t){var e=this;if(void 0===t){for(var n=[],i=0;i<e._sounds.length;i++)n.push(e._sounds[i]._id);return n}return[t]},_refreshBuffer:function(t){var e=this;return t._node.bufferSource=o.ctx.createBufferSource(),t._node.bufferSource.buffer=l[e._src],t._node.bufferSource.connect(t._panner?t._panner:t._node),t._node.bufferSource.loop=t._loop,t._loop&&(t._node.bufferSource.loopStart=t._start||0,t._node.bufferSource.loopEnd=t._stop||0),t._node.bufferSource.playbackRate.setValueAtTime(t._rate,o.ctx.currentTime),e},_cleanBuffer:function(t){var e=this;if(o._scratchBuffer&&t.bufferSource){t.bufferSource.onended=null,t.bufferSource.disconnect(0);try{t.bufferSource.buffer=o._scratchBuffer}catch(t){}}return t.bufferSource=null,e}};var u=function(t){this._parent=t,this.init()};u.prototype={init:function(){var t=this,e=t._parent;return t._muted=e._muted,t._loop=e._loop,t._volume=e._volume,t._rate=e._rate,t._seek=0,t._paused=!0,t._ended=!0,t._sprite="__default",t._id=++o._counter,e._sounds.push(t),t.create(),t},create:function(){var t=this,e=t._parent,n=o._muted||t._muted||t._parent._muted?0:t._volume;return e._webAudio?(t._node=void 0===o.ctx.createGain?o.ctx.createGainNode():o.ctx.createGain(),t._node.gain.setValueAtTime(n,o.ctx.currentTime),t._node.paused=!0,t._node.connect(o.masterGain)):(t._node=new Audio,t._errorFn=t._errorListener.bind(t),t._node.addEventListener("error",t._errorFn,!1),t._loadFn=t._loadListener.bind(t),t._node.addEventListener(o._canPlayEvent,t._loadFn,!1),t._node.src=e._src,t._node.preload="auto",t._node.volume=n*o.volume(),t._node.load()),t},reset:function(){var t=this,e=t._parent;return t._muted=e._muted,t._loop=e._loop,t._volume=e._volume,t._rate=e._rate,t._seek=0,t._rateSeek=0,t._paused=!0,t._ended=!0,t._sprite="__default",t._id=++o._counter,t},_errorListener:function(){var t=this;t._parent._emit("loaderror",t._id,t._node.error?t._node.error.code:0),t._node.removeEventListener("error",t._errorFn,!1)},_loadListener:function(){var t=this,e=t._parent;e._duration=Math.ceil(10*t._node.duration)/10,0===Object.keys(e._sprite).length&&(e._sprite={__default:[0,1e3*e._duration]}),"loaded"!==e._state&&(e._state="loaded",e._emit("load"),e._loadQueue()),t._node.removeEventListener(o._canPlayEvent,t._loadFn,!1)}};var l={},c=function(t){var e=t._src;if(l[e])return t._duration=l[e].duration,void d(t);if(/^data:[^;]+;base64,/.test(e)){for(var n=atob(e.split(",")[1]),i=new Uint8Array(n.length),r=0;r<n.length;++r)i[r]=n.charCodeAt(r);f(i.buffer,t)}else{var a=new XMLHttpRequest;a.open("GET",e,!0),a.withCredentials=t._xhrWithCredentials,a.responseType="arraybuffer",a.onload=function(){var e=(a.status+"")[0];if("0"!==e&&"2"!==e&&"3"!==e)return void t._emit("loaderror",null,"Failed loading audio file with status: "+a.status+".");f(a.response,t)},a.onerror=function(){t._webAudio&&(t._html5=!0,t._webAudio=!1,t._sounds=[],delete l[e],t.load())},h(a)}},h=function(t){try{t.send()}catch(e){t.onerror()}},f=function(t,e){var n=function(t){t&&e._sounds.length>0?(l[e._src]=t,d(e,t)):onError()},i=function(){e._emit("loaderror",null,"Decoding audio data failed.")};"undefined"!=typeof Promise&&1===o.ctx.decodeAudioData.length?o.ctx.decodeAudioData(t).then(n).catch(i):o.ctx.decodeAudioData(t,n,i)},d=function(t,e){e&&!t._duration&&(t._duration=e.duration),0===Object.keys(t._sprite).length&&(t._sprite={__default:[0,1e3*t._duration]}),"loaded"!==t._state&&(t._state="loaded",t._emit("load"),t._loadQueue())},p=function(){try{"undefined"!=typeof AudioContext?o.ctx=new AudioContext:"undefined"!=typeof webkitAudioContext?o.ctx=new webkitAudioContext:o.usingWebAudio=!1}catch(t){o.usingWebAudio=!1}var t=/iP(hone|od|ad)/.test(o._navigator&&o._navigator.platform),e=o._navigator&&o._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),n=e?parseInt(e[1],10):null;if(t&&n&&n<9){var i=/safari/.test(o._navigator&&o._navigator.userAgent.toLowerCase());(o._navigator&&o._navigator.standalone&&!i||o._navigator&&!o._navigator.standalone&&!i)&&(o.usingWebAudio=!1)}o.usingWebAudio&&(o.masterGain=void 0===o.ctx.createGain?o.ctx.createGainNode():o.ctx.createGain(),o.masterGain.gain.setValueAtTime(o._muted?0:1,o.ctx.currentTime),o.masterGain.connect(o.ctx.destination)),o._setup()};i=[],void 0!==(r=function(){return{Howler:o,Howl:s}}.apply(e,i))&&(t.exports=r),e.Howler=o,e.Howl=s,"undefined"!=typeof window?(window.HowlerGlobal=a,window.Howler=o,window.Howl=s,window.Sound=u):void 0!==n&&(n.HowlerGlobal=a,n.Howler=o,n.Howl=s,n.Sound=u)}(),function(){"use strict";HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(t){var e=this;if(!e.ctx||!e.ctx.listener)return e;for(var n=e._howls.length-1;n>=0;n--)e._howls[n].stereo(t);return e},HowlerGlobal.prototype.pos=function(t,e,n){var i=this;return i.ctx&&i.ctx.listener?(e="number"!=typeof e?i._pos[1]:e,n="number"!=typeof n?i._pos[2]:n,"number"!=typeof t?i._pos:(i._pos=[t,e,n],void 0!==i.ctx.listener.positionX?(i.ctx.listener.positionX.setTargetAtTime(i._pos[0],Howler.ctx.currentTime,.1),i.ctx.listener.positionY.setTargetAtTime(i._pos[1],Howler.ctx.currentTime,.1),i.ctx.listener.positionZ.setTargetAtTime(i._pos[2],Howler.ctx.currentTime,.1)):i.ctx.listener.setPosition(i._pos[0],i._pos[1],i._pos[2]),i)):i},HowlerGlobal.prototype.orientation=function(t,e,n,i,r,a){var o=this;if(!o.ctx||!o.ctx.listener)return o;var s=o._orientation;return e="number"!=typeof e?s[1]:e,n="number"!=typeof n?s[2]:n,i="number"!=typeof i?s[3]:i,r="number"!=typeof r?s[4]:r,a="number"!=typeof a?s[5]:a,"number"!=typeof t?s:(o._orientation=[t,e,n,i,r,a],void 0!==o.ctx.listener.forwardX?(o.ctx.listener.forwardX.setTargetAtTime(t,Howler.ctx.currentTime,.1),o.ctx.listener.forwardY.setTargetAtTime(e,Howler.ctx.currentTime,.1),o.ctx.listener.forwardZ.setTargetAtTime(n,Howler.ctx.currentTime,.1),o.ctx.listener.upX.setTargetAtTime(t,Howler.ctx.currentTime,.1),o.ctx.listener.upY.setTargetAtTime(e,Howler.ctx.currentTime,.1),o.ctx.listener.upZ.setTargetAtTime(n,Howler.ctx.currentTime,.1)):o.ctx.listener.setOrientation(t,e,n,i,r,a),o)},Howl.prototype.init=function(t){return function(e){var n=this;return n._orientation=e.orientation||[1,0,0],n._stereo=e.stereo||null,n._pos=e.pos||null,n._pannerAttr={coneInnerAngle:void 0!==e.coneInnerAngle?e.coneInnerAngle:360,coneOuterAngle:void 0!==e.coneOuterAngle?e.coneOuterAngle:360,coneOuterGain:void 0!==e.coneOuterGain?e.coneOuterGain:0,distanceModel:void 0!==e.distanceModel?e.distanceModel:"inverse",maxDistance:void 0!==e.maxDistance?e.maxDistance:1e4,panningModel:void 0!==e.panningModel?e.panningModel:"HRTF",refDistance:void 0!==e.refDistance?e.refDistance:1,rolloffFactor:void 0!==e.rolloffFactor?e.rolloffFactor:1},n._onstereo=e.onstereo?[{fn:e.onstereo}]:[],n._onpos=e.onpos?[{fn:e.onpos}]:[],n._onorientation=e.onorientation?[{fn:e.onorientation}]:[],t.call(this,e)}}(Howl.prototype.init),Howl.prototype.stereo=function(e,n){var i=this;if(!i._webAudio)return i;if("loaded"!==i._state)return i._queue.push({event:"stereo",action:function(){i.stereo(e,n)}}),i;var r=void 0===Howler.ctx.createStereoPanner?"spatial":"stereo";if(void 0===n){if("number"!=typeof e)return i._stereo;i._stereo=e,i._pos=[e,0,0]}for(var a=i._getSoundIds(n),o=0;o<a.length;o++){var s=i._soundById(a[o]);if(s){if("number"!=typeof e)return s._stereo;s._stereo=e,s._pos=[e,0,0],s._node&&(s._pannerAttr.panningModel="equalpower",s._panner&&s._panner.pan||t(s,r),"spatial"===r?void 0!==s._panner.positionX?(s._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),s._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),s._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):s._panner.setPosition(e,0,0):s._panner.pan.setValueAtTime(e,Howler.ctx.currentTime)),i._emit("stereo",s._id)}}return i},Howl.prototype.pos=function(e,n,i,r){var a=this;if(!a._webAudio)return a;if("loaded"!==a._state)return a._queue.push({event:"pos",action:function(){a.pos(e,n,i,r)}}),a;if(n="number"!=typeof n?0:n,i="number"!=typeof i?-.5:i,void 0===r){if("number"!=typeof e)return a._pos;a._pos=[e,n,i]}for(var o=a._getSoundIds(r),s=0;s<o.length;s++){var u=a._soundById(o[s]);if(u){if("number"!=typeof e)return u._pos;u._pos=[e,n,i],u._node&&(u._panner&&!u._panner.pan||t(u,"spatial"),void 0!==u._panner.positionX?(u._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),u._panner.positionY.setValueAtTime(n,Howler.ctx.currentTime),u._panner.positionZ.setValueAtTime(i,Howler.ctx.currentTime)):u._panner.setOrientation(e,n,i)),a._emit("pos",u._id)}}return a},Howl.prototype.orientation=function(e,n,i,r){var a=this;if(!a._webAudio)return a;if("loaded"!==a._state)return a._queue.push({event:"orientation",action:function(){a.orientation(e,n,i,r)}}),a;if(n="number"!=typeof n?a._orientation[1]:n,i="number"!=typeof i?a._orientation[2]:i,void 0===r){if("number"!=typeof e)return a._orientation;a._orientation=[e,n,i]}for(var o=a._getSoundIds(r),s=0;s<o.length;s++){var u=a._soundById(o[s]);if(u){if("number"!=typeof e)return u._orientation;u._orientation=[e,n,i],u._node&&(u._panner||(u._pos||(u._pos=a._pos||[0,0,-.5]),t(u,"spatial")),void 0!==u._panner.orientationX?(u._panner.orientationX.setValueAtTime(e,Howler.ctx.currentTime),u._panner.orientationY.setValueAtTime(n,Howler.ctx.currentTime),u._panner.orientationZ.setValueAtTime(i,Howler.ctx.currentTime)):u._panner.setOrientation(e,n,i)),a._emit("orientation",u._id)}}return a},Howl.prototype.pannerAttr=function(){var e,n,i,r=this,a=arguments;if(!r._webAudio)return r;if(0===a.length)return r._pannerAttr;if(1===a.length){if("object"!=typeof a[0])return i=r._soundById(parseInt(a[0],10)),i?i._pannerAttr:r._pannerAttr;e=a[0],void 0===n&&(e.pannerAttr||(e.pannerAttr={coneInnerAngle:e.coneInnerAngle,coneOuterAngle:e.coneOuterAngle,coneOuterGain:e.coneOuterGain,distanceModel:e.distanceModel,maxDistance:e.maxDistance,refDistance:e.refDistance,rolloffFactor:e.rolloffFactor,panningModel:e.panningModel}),r._pannerAttr={coneInnerAngle:void 0!==e.pannerAttr.coneInnerAngle?e.pannerAttr.coneInnerAngle:r._coneInnerAngle,coneOuterAngle:void 0!==e.pannerAttr.coneOuterAngle?e.pannerAttr.coneOuterAngle:r._coneOuterAngle,coneOuterGain:void 0!==e.pannerAttr.coneOuterGain?e.pannerAttr.coneOuterGain:r._coneOuterGain,distanceModel:void 0!==e.pannerAttr.distanceModel?e.pannerAttr.distanceModel:r._distanceModel,maxDistance:void 0!==e.pannerAttr.maxDistance?e.pannerAttr.maxDistance:r._maxDistance,refDistance:void 0!==e.pannerAttr.refDistance?e.pannerAttr.refDistance:r._refDistance,rolloffFactor:void 0!==e.pannerAttr.rolloffFactor?e.pannerAttr.rolloffFactor:r._rolloffFactor,panningModel:void 0!==e.pannerAttr.panningModel?e.pannerAttr.panningModel:r._panningModel})}else 2===a.length&&(e=a[0],n=parseInt(a[1],10));for(var o=r._getSoundIds(n),s=0;s<o.length;s++)if(i=r._soundById(o[s])){var u=i._pannerAttr;u={coneInnerAngle:void 0!==e.coneInnerAngle?e.coneInnerAngle:u.coneInnerAngle,coneOuterAngle:void 0!==e.coneOuterAngle?e.coneOuterAngle:u.coneOuterAngle,coneOuterGain:void 0!==e.coneOuterGain?e.coneOuterGain:u.coneOuterGain,distanceModel:void 0!==e.distanceModel?e.distanceModel:u.distanceModel,maxDistance:void 0!==e.maxDistance?e.maxDistance:u.maxDistance,refDistance:void 0!==e.refDistance?e.refDistance:u.refDistance,rolloffFactor:void 0!==e.rolloffFactor?e.rolloffFactor:u.rolloffFactor,panningModel:void 0!==e.panningModel?e.panningModel:u.panningModel};var l=i._panner;l?(l.coneInnerAngle=u.coneInnerAngle,l.coneOuterAngle=u.coneOuterAngle,l.coneOuterGain=u.coneOuterGain,l.distanceModel=u.distanceModel,l.maxDistance=u.maxDistance,l.refDistance=u.refDistance,l.rolloffFactor=u.rolloffFactor,l.panningModel=u.panningModel):(i._pos||(i._pos=r._pos||[0,0,-.5]),t(i,"spatial"))}return r},Sound.prototype.init=function(t){return function(){var e=this,n=e._parent;e._orientation=n._orientation,e._stereo=n._stereo,e._pos=n._pos,e._pannerAttr=n._pannerAttr,t.call(this),e._stereo?n.stereo(e._stereo):e._pos&&n.pos(e._pos[0],e._pos[1],e._pos[2],e._id)}}(Sound.prototype.init),Sound.prototype.reset=function(t){return function(){var e=this,n=e._parent;return e._orientation=n._orientation,e._stereo=n._stereo,e._pos=n._pos,e._pannerAttr=n._pannerAttr,e._stereo?n.stereo(e._stereo):e._pos?n.pos(e._pos[0],e._pos[1],e._pos[2],e._id):e._panner&&(e._panner.disconnect(0),e._panner=void 0,n._refreshBuffer(e)),t.call(this)}}(Sound.prototype.reset);var t=function(t,e){e=e||"spatial","spatial"===e?(t._panner=Howler.ctx.createPanner(),t._panner.coneInnerAngle=t._pannerAttr.coneInnerAngle,t._panner.coneOuterAngle=t._pannerAttr.coneOuterAngle,t._panner.coneOuterGain=t._pannerAttr.coneOuterGain,t._panner.distanceModel=t._pannerAttr.distanceModel,t._panner.maxDistance=t._pannerAttr.maxDistance,t._panner.refDistance=t._pannerAttr.refDistance,t._panner.rolloffFactor=t._pannerAttr.rolloffFactor,t._panner.panningModel=t._pannerAttr.panningModel,void 0!==t._panner.positionX?(t._panner.positionX.setValueAtTime(t._pos[0],Howler.ctx.currentTime),t._panner.positionY.setValueAtTime(t._pos[1],Howler.ctx.currentTime),t._panner.positionZ.setValueAtTime(t._pos[2],Howler.ctx.currentTime)):t._panner.setPosition(t._pos[0],t._pos[1],t._pos[2]),void 0!==t._panner.orientationX?(t._panner.orientationX.setValueAtTime(t._orientation[0],Howler.ctx.currentTime),t._panner.orientationY.setValueAtTime(t._orientation[1],Howler.ctx.currentTime),t._panner.orientationZ.setValueAtTime(t._orientation[2],Howler.ctx.currentTime)):t._panner.setOrientation(t._orientation[0],t._orientation[1],t._orientation[2])):(t._panner=Howler.ctx.createStereoPanner(),t._panner.pan.setValueAtTime(t._stereo,Howler.ctx.currentTime)),t._panner.connect(t._node),t._paused||t._parent.pause(t._id,!0).play(t._id,!0)}}()}).call(e,n("h6ac"))}});
//# sourceMappingURL=route-game.chunk.2fb8e.js.map